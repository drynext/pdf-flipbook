<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipOS V27 | Geometry Architect</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* CORE VARIABLES */
        :root {
            --sys-bg: #050505;
            --sys-panel: #1a1a1d;
            --sys-text: #ffffff;
            --sys-accent: #3b82f6;
            --sys-border: #27272a;
            --sys-sidebar-w: 72px;
        }
        [data-theme="light"] {
            --sys-bg: #f0f2f5;
            --sys-panel: #ffffff;
            --sys-text: #18181b;
            --sys-border: #e4e4e7;
            --sys-accent: #2563eb;
        }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }
        
        body {
            background-color: var(--sys-bg); color: var(--sys-text);
            font-family: 'Inter', sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            display: grid;
            grid-template-columns: var(--sys-sidebar-w) 1fr var(--sys-sidebar-w);
            grid-template-rows: 100%;
            grid-template-areas: "left stage right";
        }

        /* SIDEBARS */
        .sidebar {
            background-color: var(--sys-panel);
            border-left: 1px solid var(--sys-border);
            border-right: 1px solid var(--sys-border);
            z-index: 1000; display: flex; flex-direction: column; 
            align-items: center; padding: 20px 0; gap: 16px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #ui-left { grid-area: left; border-left: none; }
        #ui-right { grid-area: right; border-right: none; }

        /* STAGE */
        #stage {
            grid-area: stage; position: relative; overflow: hidden;
            background-image: radial-gradient(var(--sys-border) 1px, transparent 1px);
            background-size: 24px 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: grab;
        }
        #stage:active { cursor: grabbing; }

        #transform-target {
            transform-origin: center center;
            will-change: transform;
            transition: transform 0.1s linear;
        }

        /* COMPONENTS */
        .btn {
            width: 48px; height: 48px; border-radius: 12px;
            background: rgba(128,128,128,0.05); color: inherit;
            border: 1px solid transparent; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 1.25rem;
            transition: 0.2s;
        }
        .btn:hover { background: rgba(128,128,128,0.2); transform: translateY(-2px); }
        .btn.active { background: var(--sys-accent); color: #fff; box-shadow: 0 4px 12px rgba(59,130,246,0.4); }

        .divider { width: 60%; height: 1px; background: var(--sys-border); margin: 4px 0; }
        
        .color-dot { width: 32px; height: 32px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .color-dot.active { border-color: var(--sys-text); transform: scale(1.15); }

        /* SIZE SLIDER */
        .size-slider-container {
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            width: 100%; padding: 0 10px;
        }
        .size-slider {
            -webkit-appearance: none; width: 100%; height: 4px; background: var(--sys-border);
            border-radius: 2px; outline: none; writing-mode: bt-lr; 
        }
        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%;
            background: var(--sys-accent); cursor: pointer;
        }

        /* CURSOR & LAYERS */
        #eraser-cursor {
            position: fixed; pointer-events: none; z-index: 9999;
            border: 2px solid #fff; border-radius: 50%;
            background: rgba(255,255,255,0.2); box-shadow: 0 0 5px rgba(0,0,0,0.5);
            display: none; transform: translate(-50%, -50%);
        }
        .page-wrap { position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
        canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
        .pdf-l { z-index: 1; pointer-events: none; }
        .ink-l { z-index: 10; cursor: crosshair; touch-action: none; }
        #pan-mask { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 500; display: none; }
        
        .spyglass {
            position: fixed; width: 220px; height: 220px;
            border-radius: 50%; border: 4px solid var(--sys-text);
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            overflow: hidden; pointer-events: none; z-index: 9000;
            display: none; background: #fff;
        }

        /* FLOATING APPS (CALC & SHAPES) */
        .float-app {
            position: fixed; background: var(--sys-panel); border: 1px solid var(--sys-border);
            border-radius: 16px; box-shadow: 0 20px 50px rgba(0,0,0,0.6);
            z-index: 9500; display: none; flex-direction: column; overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .app-head {
            padding: 10px 15px; background: rgba(128,128,128,0.1);
            cursor: grab; display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 0.9rem;
        }
        .app-head:active { cursor: grabbing; }

        /* CALCULATOR SPECIFIC */
        #calc-app { top: 100px; right: 100px; width: 260px; }
        .calc-screen { padding: 20px; text-align: right; font-size: 1.8rem; font-family: monospace; border-bottom: 1px solid var(--sys-border); color: var(--sys-accent); }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--sys-border); }
        .calc-btn { background: var(--sys-panel); border: none; padding: 15px; font-size: 1.1rem; color: var(--sys-text); cursor: pointer; }
        .calc-btn:hover { background: rgba(128,128,128,0.1); }
        .calc-btn.op { color: var(--sys-accent); font-weight: bold; }
        .calc-btn.eq { background: var(--sys-accent); color: #fff; grid-column: span 2; }

        /* SHAPE PALETTE SPECIFIC */
        #shape-app { top: 150px; left: 100px; width: 240px; }
        .shape-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 15px; }
        .shape-btn { 
            aspect-ratio: 1; border-radius: 8px; border: 1px solid var(--sys-border);
            background: rgba(128,128,128,0.05); color: var(--sys-text); cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            font-size: 0.7rem; transition: 0.2s;
        }
        .shape-btn i { font-size: 1.2rem; }
        .shape-btn:hover { background: rgba(128,128,128,0.2); }
        .shape-btn.active { background: var(--sys-accent); color: #fff; border-color: var(--sys-accent); }

        /* UPLOAD & TOAST */
        #upload-ol { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .upload-box { padding: 60px 80px; border: 2px dashed var(--sys-border); border-radius: 32px; text-align: center; cursor: pointer; transition: 0.3s; }
        .upload-box:hover { border-color: var(--sys-accent); transform: translateY(-5px); }
        #toast { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--sys-panel); color: var(--sys-text); padding: 12px 24px; border-radius: 50px; font-weight: 600; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 8000; border: 1px solid var(--sys-border); }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    </style>
</head>
<body data-theme="dark">

    <div id="upload-ol">
        <div class="upload-box" onclick="document.getElementById('file-in').click()">
            <i class="fas fa-cubes" style="font-size: 4rem; color: var(--sys-accent); margin-bottom: 24px;"></i>
            <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 10px;">FLIP OS V27</h1>
            <p style="color: #888; font-family: monospace;">Geometry Architect: 2D & 3D Tools</p>
            <div id="loading-txt" style="margin-top: 20px; font-size: 0.9rem; display:none;">Loading...</div>
        </div>
        <input type="file" id="file-in" hidden accept="application/pdf">
    </div>

    <div id="eraser-cursor"></div>

    <div id="calc-app" class="float-app">
        <div class="app-head" onmousedown="Drag.start(event, 'calc-app')">
            <span>CALCULATOR</span>
            <i class="fas fa-times" style="cursor:pointer;" onclick="Toggle.calc()"></i>
        </div>
        <div class="calc-screen" id="calc-disp">0</div>
        <div class="calc-grid">
            <button class="calc-btn" onclick="Calc.clr()">C</button>
            <button class="calc-btn" onclick="Calc.del()">DEL</button>
            <button class="calc-btn op" onclick="Calc.add('/')">/</button>
            <button class="calc-btn op" onclick="Calc.add('*')">Ã—</button>
            <button class="calc-btn" onclick="Calc.add('7')">7</button>
            <button class="calc-btn" onclick="Calc.add('8')">8</button>
            <button class="calc-btn" onclick="Calc.add('9')">9</button>
            <button class="calc-btn op" onclick="Calc.add('-')">-</button>
            <button class="calc-btn" onclick="Calc.add('4')">4</button>
            <button class="calc-btn" onclick="Calc.add('5')">5</button>
            <button class="calc-btn" onclick="Calc.add('6')">6</button>
            <button class="calc-btn op" onclick="Calc.add('+')">+</button>
            <button class="calc-btn" onclick="Calc.add('1')">1</button>
            <button class="calc-btn" onclick="Calc.add('2')">2</button>
            <button class="calc-btn" onclick="Calc.add('3')">3</button>
            <button class="calc-btn" style="grid-row: span 2;" onclick="Calc.exec()">=</button>
            <button class="calc-btn" onclick="Calc.add('0')" style="grid-column: span 2;">0</button>
            <button class="calc-btn" onclick="Calc.add('.')">.</button>
        </div>
    </div>

    <div id="shape-app" class="float-app">
        <div class="app-head" onmousedown="Drag.start(event, 'shape-app')">
            <span>GEOMETRY</span>
            <i class="fas fa-times" style="cursor:pointer;" onclick="Toggle.shape()"></i>
        </div>
        <div class="shape-grid">
            <div class="shape-btn" onclick="Ink.setShape('rect', this)"><i class="far fa-square"></i>Rect</div>
            <div class="shape-btn" onclick="Ink.setShape('circle', this)"><i class="far fa-circle"></i>Circle</div>
            <div class="shape-btn" onclick="Ink.setShape('line', this)"><i class="fas fa-minus"></i>Line</div>
            <div class="shape-btn" onclick="Ink.setShape('arrow', this)"><i class="fas fa-long-arrow-alt-right"></i>Arrow</div>
            <div class="shape-btn" onclick="Ink.setShape('tri', this)"><i class="fas fa-caret-up"></i>Tri</div>
            <div class="shape-btn" onclick="Ink.setShape('cube', this)"><i class="fas fa-cube"></i>Cube</div>
            <div class="shape-btn" onclick="Ink.setShape('cyl', this)"><i class="fas fa-database"></i>Cyl</div>
            <div class="shape-btn" onclick="Ink.setShape('pyr', this)"><i class="fas fa-gopuram"></i>Pyr</div>
        </div>
        <div style="padding: 10px; font-size: 0.7rem; color: #888; text-align: center;">Drag on canvas to draw</div>
    </div>

    <aside class="sidebar" id="ui-left">
        <button class="btn active" id="m-read" onclick="Kernel.mode('READ')"><i class="fas fa-eye"></i></button>
        <button class="btn" id="m-draw" onclick="Kernel.mode('DRAW')"><i class="fas fa-pen"></i></button>
        <div class="divider"></div>
        <button class="btn" id="t-pen" onclick="Ink.tool('pen')"><i class="fas fa-pen-nib"></i></button>
        <button class="btn" id="t-mark" onclick="Ink.tool('marker')"><i class="fas fa-highlighter"></i></button>
        <button class="btn" id="t-erase" onclick="Ink.tool('eraser')"><i class="fas fa-eraser"></i></button>
        <button class="btn" id="t-shape" onclick="Toggle.shape()"><i class="fas fa-shapes"></i></button>
        
        <div class="size-slider-container" title="Size Control">
            <i class="fas fa-circle" style="font-size: 0.5rem; margin-bottom: 5px;"></i>
            <input type="range" class="size-slider" min="5" max="50" value="20" oninput="Ink.setSize(this.value)">
            <i class="fas fa-circle" style="font-size: 1rem; margin-top: 5px;"></i>
        </div>

        <div class="divider"></div>
        <div class="color-dot active" style="background:#ef4444" onclick="Ink.color('#ef4444',this)"></div>
        <div class="color-dot" style="background:#22c55e" onclick="Ink.color('#22c55e',this)"></div>
        <div class="color-dot" style="background:#3b82f6" onclick="Ink.color('#3b82f6',this)"></div>
        <div class="divider"></div>
        <button class="btn" onclick="Ink.undo()"><i class="fas fa-undo"></i></button>
        <button class="btn" onclick="Storage.clear()"><i class="fas fa-hdd"></i></button>
    </aside>

    <main id="stage" ondblclick="View.reset()">
        <div id="transform-target">
            <div id="book-root"></div>
        </div>
        <div id="pan-mask"></div>
    </main>

    <aside class="sidebar" id="ui-right">
        <button class="btn" onclick="UI.theme()"><i class="fas fa-adjust"></i></button>
        <div class="divider"></div>
        <button class="btn" onclick="View.zoom(1)"><i class="fas fa-plus"></i></button>
        <span id="zoom-txt" style="font-family:monospace; font-weight:700; color:var(--sys-accent)">100%</span>
        <button class="btn" onclick="View.zoom(-1)"><i class="fas fa-minus"></i></button>
        <div class="divider"></div>
        <button class="btn" onclick="Book.nav(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="pg-txt" style="font-family:monospace; font-weight:700;">--/--</span>
        <button class="btn" onclick="Book.nav(1)"><i class="fas fa-chevron-right"></i></button>
        <div class="divider"></div>
        <button class="btn" id="btn-calc" onclick="Toggle.calc()"><i class="fas fa-calculator"></i></button>
        <button class="btn" id="btn-spy" onclick="Spy.toggle()"><i class="fas fa-search"></i></button>
        <button class="btn" onclick="UI.full()"><i class="fas fa-expand"></i></button>
    </aside>

    <div class="spyglass" id="spy-root"><canvas id="spy-c"></canvas></div>
    <div id="toast">Ready</div>
    <audio id="sfx" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const State = { pdf: null, book: null, mode: 'READ', zoom: 1, total: 0, current: 0 };

        const DB = {
            name: 'FlipOS_DB', version: 1, db: null,
            init() {
                return new Promise((resolve, reject) => {
                    const req = indexedDB.open(this.name, this.version);
                    req.onupgradeneeded = e => { e.target.result.createObjectStore('files'); };
                    req.onsuccess = e => { this.db = e.target.result; resolve(); };
                    req.onerror = e => reject(e);
                });
            },
            save(data) {
                const tx = this.db.transaction('files', 'readwrite');
                tx.objectStore('files').put(data, 'current_pdf');
            },
            load() {
                return new Promise((resolve) => {
                    const tx = this.db.transaction('files', 'readonly');
                    const req = tx.objectStore('files').get('current_pdf');
                    req.onsuccess = e => resolve(e.target.result);
                    req.onerror = () => resolve(null);
                });
            },
            clear() {
                const tx = this.db.transaction('files', 'readwrite');
                tx.objectStore('files').delete('current_pdf');
            }
        };

        const Kernel = {
            async init() {
                window.addEventListener('contextmenu', e => e.preventDefault());
                await DB.init();
                const savedData = await DB.load();
                if(savedData) {
                    document.getElementById('loading-txt').style.display = 'block';
                    State.pdf = await pdfjsLib.getDocument(savedData).promise;
                    State.total = State.pdf.numPages;
                    await Render.build();
                    UI.toast("Restored Saved File");
                }
                document.getElementById('file-in').addEventListener('change', this.upload);
                window.addEventListener('keydown', e => {
                    if(e.key==='ArrowLeft') Book.nav(-1);
                    if(e.key==='ArrowRight') Book.nav(1);
                    if(e.ctrlKey && e.key==='z') Ink.undo();
                    if(e.key==='+') View.zoom(1);
                    if(e.key==='-') View.zoom(-1);
                });
                Calc.init(); Drag.initGlobal();
            },
            async upload(e) {
                if(!e.target.files[0]) return;
                try {
                    document.querySelector('.upload-box').innerHTML = '<i class="fas fa-spin fa-spinner" style="font-size:3rem"></i>';
                    const ab = await e.target.files[0].arrayBuffer();
                    DB.save(ab); 
                    State.pdf = await pdfjsLib.getDocument(ab).promise;
                    State.total = State.pdf.numPages;
                    await Render.build();
                } catch(err) {
                    alert("Error: " + err.message);
                    location.reload();
                }
            },
            mode(m) {
                State.mode = m;
                document.getElementById('m-read').classList.toggle('active', m==='READ');
                document.getElementById('m-draw').classList.toggle('active', m==='DRAW');
                const mask = document.getElementById('pan-mask');
                if(m==='READ') {
                    if(State.book) State.book.update({useMouseEvents: true});
                    if(State.zoom > 1) mask.style.display = 'block';
                    UI.toast("Reader Mode");
                } else {
                    if(State.book) State.book.update({useMouseEvents: false});
                    mask.style.display = 'none';
                    UI.toast("Studio Mode");
                }
            }
        };

        const Render = {
            async build() {
                const root = document.getElementById('book-root'); root.innerHTML = '';
                for(let i=1; i<=State.total; i++) {
                    const p = await State.pdf.getPage(i);
                    const v = p.getViewport({scale: 1.5});
                    const wrap = document.createElement('div');
                    wrap.className = 'page-wrap'; wrap.dataset.idx = i;
                    const pc = document.createElement('canvas'); pc.className='pdf-l'; pc.width=v.width; pc.height=v.height;
                    await p.render({canvasContext: pc.getContext('2d'), viewport: v}).promise;
                    const ic = document.createElement('canvas'); ic.className='ink-l'; ic.width=v.width; ic.height=v.height;
                    wrap.append(pc, ic); root.append(wrap);
                }
                document.getElementById('upload-ol').style.display = 'none';
                Book.init(); Ink.init(); View.init();
            }
        };

        const Book = {
            init() {
                const w = document.getElementById('stage').clientWidth;
                const isWide = w > 800;
                State.book = new St.PageFlip(document.getElementById('book-root'), {
                    width: isWide ? 550 : 400, height: isWide ? 800 : 600,
                    size: isWide ? 'fixed' : 'stretch', usePortrait: !isWide,
                    showCover: true, useMouseEvents: true
                });
                State.book.loadFromHTML(document.querySelectorAll('.page-wrap'));
                State.book.on('flip', e => {
                    State.current = e.data + 1;
                    document.getElementById('pg-txt').innerText = `${State.current}/${State.total}`;
                    const sfx = document.getElementById('sfx'); sfx.currentTime=0; sfx.play().catch(()=>{});
                });
            },
            nav(d) {
                if(!State.book) return;
                d === -1 ? State.book.flipPrev() : State.book.flipNext();
            }
        };

        const View = {
            pan: {x:0, y:0}, val: 1, isD: false, start: {x:0,y:0},
            init() {
                const m = document.getElementById('pan-mask');
                m.onmousedown = e => { this.isD=true; this.start={x:e.clientX-this.pan.x, y:e.clientY-this.pan.y}; m.style.cursor='grabbing'; };
                window.onmousemove = e => {
                    if(this.isD) { e.preventDefault(); this.pan.x=e.clientX-this.start.x; this.pan.y=e.clientY-this.start.y; this.apply(); }
                    if(Spy.on) Spy.render(e);
                };
                window.onmouseup = () => { this.isD=false; m.style.cursor='grab'; };
            },
            zoom(d) {
                if(d>0 && this.val<4) this.val+=0.5; else if(d<0 && this.val>1) this.val-=0.5;
                this.apply();
            },
            reset() { this.val=1; this.pan={x:0,y:0}; this.apply(); UI.toast("Reset View"); },
            apply() {
                State.zoom = this.val;
                document.getElementById('zoom-txt').innerText = (this.val*100)+'%';
                const t = document.getElementById('transform-target');
                const m = document.getElementById('pan-mask');
                t.style.transform = `translate(${this.pan.x}px, ${this.pan.y}px) scale(${this.val})`;
                if(this.val > 1 && State.mode === 'READ') { m.style.display = 'block'; if(State.book) State.book.update({useMouseEvents: false}); } 
                else { m.style.display = 'none'; if(this.val===1) { this.pan={x:0,y:0}; t.style.transform='scale(1)'; } if(State.mode === 'READ' && State.book) State.book.update({useMouseEvents: true}); }
            }
        };

        const Ink = {
            t: 'pen', c: '#ef4444', isD: false, ctx: null, can: null, hist: {}, last: {x:0,y:0}, startP: {x:0,y:0}, size: 20, dragSnapshot: null, currentShape: null,
            
            init() {
                const s = document.getElementById('stage');
                s.onpointerdown = e => this.down(e);
                window.onpointermove = e => this.move(e);
                window.onpointerup = () => this.up();
            },
            setSize(v) { this.size = v; document.getElementById('eraser-cursor').style.width = v+'px'; document.getElementById('eraser-cursor').style.height = v+'px'; },
            tool(n) {
                this.t = n; this.currentShape = null;
                ['pen','mark','erase','shape'].forEach(id => document.getElementById('t-'+id).classList.remove('active'));
                document.getElementById('t-'+(n==='marker'?'mark':(n==='eraser'?'erase':'pen'))).classList.add('active');
                if(n!=='shape') Toggle.shape(false);
            },
            setShape(s, el) {
                this.tool('shape'); this.currentShape = s;
                document.getElementById('t-shape').classList.add('active');
                document.querySelectorAll('.shape-btn').forEach(b=>b.classList.remove('active'));
                if(el) el.classList.add('active');
                Toggle.shape(false); // Hide palette after selection
            },
            color(hex, el) { this.c = hex; if(this.t==='eraser' || this.t==='shape') this.tool('pen'); document.querySelectorAll('.color-dot').forEach(e => e.classList.remove('active')); el.classList.add('active'); },
            hit(e) { const el = document.elementFromPoint(e.clientX, e.clientY); return el?.classList.contains('ink-l') ? el : null; },
            pos(e, c) { const r = c.getBoundingClientRect(); return { x: (e.clientX-r.left)*(c.width/r.width), y: (e.clientY-r.top)*(c.height/r.height) }; },
            
            cfg(ctx, isRightClick) {
                ctx.lineCap='round'; ctx.lineJoin='round';
                if(isRightClick || this.t === 'eraser') { ctx.globalCompositeOperation='destination-out'; ctx.lineWidth = this.size; ctx.globalAlpha=1.0; }
                else if(this.t==='marker') { ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=this.c; ctx.lineWidth=20; ctx.globalAlpha=0.2; }
                else { ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=this.c; ctx.lineWidth=3; ctx.globalAlpha=1.0; }
            },

            updateCursor(e, show) {
                const c = document.getElementById('eraser-cursor');
                if(show && State.mode === 'DRAW') { c.style.display='block'; c.style.left=e.clientX+'px'; c.style.top=e.clientY+'px'; c.style.width=this.size+'px'; c.style.height=this.size+'px'; } 
                else c.style.display = 'none';
            },

            down(e) {
                if(document.getElementById('pan-mask').style.display === 'block') return;
                const h = this.hit(e); if(!h || State.mode!=='DRAW') return;
                const isRight = e.button === 2;
                e.preventDefault(); 
                this.isD=true; this.can=h; this.ctx=h.getContext('2d');
                
                // Snapshot for dragging shape to prevent permanent drawing until mouseup
                if(this.currentShape) {
                    this.dragSnapshot = this.ctx.getImageData(0,0,h.width,h.height);
                    this.startP = this.pos(e, h);
                } else {
                    this.push(this.can);
                    this.cfg(this.ctx, isRight); 
                    this.last=this.pos(e, h);
                    this.ctx.beginPath(); this.ctx.moveTo(this.last.x, this.last.y); this.ctx.stroke();
                }
                if(isRight || this.t === 'eraser') this.updateCursor(e, true);
            },

            move(e) {
                if(this.t === 'eraser' || (this.isD && e.buttons === 2)) this.updateCursor(e, true); else this.updateCursor(e, false);
                if(!this.isD) return;
                const h = this.hit(e);
                
                // SHAPE LOGIC
                if(this.currentShape && this.can) {
                    const curr = this.pos(e, this.can);
                    this.ctx.putImageData(this.dragSnapshot, 0, 0); // Restore original
                    this.drawShapePreview(curr);
                    return;
                }

                // NORMAL DRAWING
                const isRight = e.buttons === 2;
                if(h && h !== this.can) {
                    this.ctx.closePath(); this.push(h);
                    this.can=h; this.ctx=h.getContext('2d'); this.cfg(this.ctx, isRight);
                    this.last=this.pos(e, h);
                    this.ctx.beginPath(); this.ctx.moveTo(this.last.x, this.last.y);
                }
                if(this.can) {
                    const curr = this.pos(e, this.can);
                    this.ctx.quadraticCurveTo(this.last.x, this.last.y, (this.last.x+curr.x)/2, (this.last.y+curr.y)/2);
                    this.ctx.stroke(); this.last = curr;
                }
            },

            up() { 
                if(this.isD) {
                    // Finalize Shape
                    if(this.currentShape) {
                        this.push(this.can); // Save after shape drawn
                    }
                    this.isD=false; 
                    if(this.ctx) this.ctx.closePath(); 
                    this.updateCursor(null, false);
                }
            },

            drawShapePreview(end) {
                const ctx = this.ctx; const s = this.startP;
                ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=this.c; ctx.lineWidth=3; ctx.globalAlpha=1.0;
                ctx.beginPath();
                const w = end.x - s.x; const h = end.y - s.y;
                
                if(this.currentShape === 'rect') ctx.strokeRect(s.x, s.y, w, h);
                else if(this.currentShape === 'circle') {
                    ctx.beginPath(); ctx.ellipse(s.x + w/2, s.y + h/2, Math.abs(w/2), Math.abs(h/2), 0, 0, 2*Math.PI); ctx.stroke();
                }
                else if(this.currentShape === 'line') { ctx.moveTo(s.x, s.y); ctx.lineTo(end.x, end.y); ctx.stroke(); }
                else if(this.currentShape === 'arrow') { 
                    const headlen = 20; const angle = Math.atan2(end.y-s.y, end.x-s.x);
                    ctx.moveTo(s.x, s.y); ctx.lineTo(end.x, end.y);
                    ctx.lineTo(end.x-headlen*Math.cos(angle-Math.PI/6), end.y-headlen*Math.sin(angle-Math.PI/6));
                    ctx.moveTo(end.x, end.y);
                    ctx.lineTo(end.x-headlen*Math.cos(angle+Math.PI/6), end.y-headlen*Math.sin(angle+Math.PI/6));
                    ctx.stroke();
                }
                else if(this.currentShape === 'tri') {
                    ctx.moveTo(s.x + w/2, s.y); ctx.lineTo(s.x, s.y+h); ctx.lineTo(s.x+w, s.y+h); ctx.closePath(); ctx.stroke();
                }
                else if(this.currentShape === 'cube') {
                    ctx.strokeRect(s.x, s.y, w, h); ctx.strokeRect(s.x+w*0.3, s.y-h*0.3, w, h);
                    ctx.moveTo(s.x, s.y); ctx.lineTo(s.x+w*0.3, s.y-h*0.3);
                    ctx.moveTo(s.x+w, s.y); ctx.lineTo(s.x+w+w*0.3, s.y-h*0.3);
                    ctx.moveTo(s.x, s.y+h); ctx.lineTo(s.x+w*0.3, s.y+h-h*0.3);
                    ctx.moveTo(s.x+w, s.y+h); ctx.lineTo(s.x+w+w*0.3, s.y+h-h*0.3); ctx.stroke();
                }
                else if(this.currentShape === 'cyl') {
                    ctx.beginPath(); ctx.ellipse(s.x+w/2, s.y, Math.abs(w/2), Math.abs(h*0.1), 0, 0, 2*Math.PI); ctx.stroke();
                    ctx.beginPath(); ctx.ellipse(s.x+w/2, s.y+h, Math.abs(w/2), Math.abs(h*0.1), 0, 0, 2*Math.PI); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(s.x, s.y); ctx.lineTo(s.x, s.y+h); ctx.moveTo(s.x+w, s.y); ctx.lineTo(s.x+w, s.y+h); ctx.stroke();
                }
                else if(this.currentShape === 'pyr') {
                    ctx.moveTo(s.x+w/2, s.y); ctx.lineTo(s.x, s.y+h); ctx.lineTo(s.x+w, s.y+h); ctx.closePath(); 
                    ctx.moveTo(s.x+w/2, s.y); ctx.lineTo(s.x+w*0.7, s.y+h*0.8); ctx.stroke(); // Simple wireframe
                }
            },

            push(c) {
                if(!c) return; const i = c.parentElement.dataset.idx;
                if(!this.hist[i]) this.hist[i]=[];
                this.hist[i].push(this.ctx.getImageData(0,0,c.width,c.height));
                if(this.hist[i].length>15) this.hist[i].shift();
            },
            undo() {
                if(!this.can) return; const i = this.can.parentElement.dataset.idx;
                const h = this.hist[i];
                if(h?.length) { h.pop(); const p=h[h.length-1]; if(p) this.ctx.putImageData(p,0,0); else this.ctx.clearRect(0,0,this.can.width,this.can.height); UI.toast("Undo"); }
            },
            clear() {
                if(this.can) { this.push(this.can); this.can.getContext('2d').clearRect(0,0,this.can.width,this.can.height); UI.toast("Cleared"); }
            }
        };

        const Toggle = {
            calc() {
                const el = document.getElementById('calc-app');
                el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
                document.getElementById('btn-calc').classList.toggle('active');
            },
            shape(forceState) {
                const el = document.getElementById('shape-app');
                if (forceState !== undefined) {
                    el.style.display = forceState ? 'flex' : 'none';
                } else {
                    el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
                }
                document.getElementById('t-shape').classList.toggle('active', el.style.display === 'flex');
            }
        };

        const Drag = {
            initGlobal() { this.setup('calc-app', 'calc-drag'); this.setup('shape-app', 'shape-app'); }, // Drag entire shape app by clicking anywhere inside head? No, stick to header
            start(e, id) {
                const el = document.getElementById(id);
                let startX = e.clientX - el.offsetLeft;
                let startY = e.clientY - el.offsetTop;
                const move = (ev) => { el.style.left = (ev.clientX - startX) + 'px'; el.style.top = (ev.clientY - startY) + 'px'; };
                const stop = () => { window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', stop); };
                window.addEventListener('mousemove', move);
                window.addEventListener('mouseup', stop);
            }
        };

        const Spy = {
            on: false,
            toggle() { this.on=!this.on; document.getElementById('btn-spy').classList.toggle('active',this.on); document.getElementById('spy-root').style.display=this.on?'block':'none'; },
            render(e) {
                const s=document.getElementById('spy-root'), c=document.getElementById('spy-c').getContext('2d');
                document.getElementById('spy-c').width=500; document.getElementById('spy-c').height=500;
                s.style.left=(e.clientX+20)+'px'; s.style.top=(e.clientY+20)+'px';
                s.style.display='none'; const el=document.elementFromPoint(e.clientX,e.clientY); s.style.display='block';
                const w=el?.closest('.page-wrap');
                if(w) {
                    const pdf=w.querySelector('.pdf-l'), ink=w.querySelector('.ink-l');
                    const r=pdf.getBoundingClientRect();
                    const rx=pdf.width/r.width, ry=pdf.height/r.height;
                    const x=(e.clientX-r.left)*rx, y=(e.clientY-r.top)*ry;
                    c.fillStyle='#fff'; c.fillRect(0,0,500,500);
                    try { c.drawImage(pdf,x-100,y-100,200,200,0,0,500,500); c.drawImage(ink,x-100,y-100,200,200,0,0,500,500); } catch(e){}
                }
            }
        };

        const Calc = {
            init() { /* Drag handled by global Drag util */ },
            toggle() { Toggle.calc(); },
            add(v) { document.getElementById('calc-disp').innerText += v; },
            clr() { document.getElementById('calc-disp').innerText = ''; },
            del() { const s = document.getElementById('calc-disp').innerText; document.getElementById('calc-disp').innerText = s.substring(0, s.length - 1); },
            exec() { try { document.getElementById('calc-disp').innerText = eval(document.getElementById('calc-disp').innerText); } catch { document.getElementById('calc-disp').innerText = 'Error'; } }
        };

        const Storage = {
            clear() { if(confirm("Clear saved PDF?")) { DB.clear(); UI.toast("Storage Cleared"); setTimeout(() => location.reload(), 1000); } }
        };

        const UI = { 
            theme() { const b=document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')=='dark'?'light':'dark'); },
            full() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); },
            toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); } 
        };

        Kernel.init();
    </script>
</body>
</html>
