<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fixed PDF Flipbook V4</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #1e1e2e;
            --panel-dark: #2d2d3b;
            --text-light: #fff;
            --accent: #ff4757;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-light);
            font-family: sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- TOOLBAR --- */
        .toolbar {
            height: 60px;
            background: var(--panel-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .btn-group { display: flex; gap: 10px; align-items: center; }

        .btn {
            width: 40px; height: 40px;
            border: 1px solid #444;
            background: transparent;
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: 0.2s;
        }

        .btn:hover { background: var(--accent); border-color: var(--accent); }
        .btn.active { background: var(--accent); box-shadow: 0 0 10px var(--accent); }

        /* --- STAGE (VÙNG HIỂN THỊ) --- */
        .stage {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-image: radial-gradient(#444 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* Container chứa sách (để zoom) */
        .zoom-layer {
            transition: transform 0.1s linear; /* Tắt animation mượt để kéo cho nhanh */
            transform-origin: center center;
            will-change: transform;
        }

        /* Lớp phủ dùng để Kéo thả (Pan) - Chỉ hiện khi Zoom */
        #pan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; /* Nằm đè lên sách */
            display: none; /* Mặc định ẩn để còn lật trang */
            cursor: grab;
        }
        #pan-overlay.grabbing { cursor: grabbing; }

        /* --- SÁCH --- */
        .stf__wrapper { box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        
        canvas { 
            width: 100%; height: 100%; 
            object-fit: contain; 
        }

        /* --- KÍNH LÚP --- */
        #magnifier {
            position: absolute;
            width: 250px; height: 250px;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            display: none;
            pointer-events: none; /* Để chuột xuyên qua */
            z-index: 999;
            background-color: #fff;
            background-repeat: no-repeat;
        }

        /* --- UPLOAD UI --- */
        #upload-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .upload-box {
            border: 2px dashed var(--accent);
            padding: 40px; border-radius: 10px;
            cursor: pointer; text-align: center;
        }
        .upload-box:hover { background: rgba(255,255,255,0.1); }
        #progress-bar {
            width: 300px; height: 5px; background: #444; margin-top: 20px;
            border-radius: 3px; overflow: hidden; display: none;
        }
        #progress-fill { width: 0%; height: 100%; background: var(--accent); transition: width 0.2s; }

    </style>
</head>
<body>

    <div id="upload-screen">
        <div class="upload-box" onclick="document.getElementById('inp-file').click()">
            <i class="fas fa-book" style="font-size: 3rem; color: var(--accent); margin-bottom: 15px;"></i>
            <h2>CHỌN FILE PDF</h2>
            <p style="color:#aaa">Click để tải sách lên</p>
        </div>
        <input type="file" id="inp-file" accept="application/pdf" style="display: none;">
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <p id="status-txt" style="margin-top: 10px; display: none;">Đang xử lý...</p>
    </div>

    <div class="toolbar">
        <div style="font-weight: bold; color: var(--accent);">PDF FLIPBOOK V4</div>
        
        <div class="btn-group">
            <button class="btn" id="btn-prev"><i class="fas fa-chevron-left"></i></button>
            <span style="min-width: 80px; text-align: center;" id="page-num">0 / 0</span>
            <button class="btn" id="btn-next"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="btn-group">
            <button class="btn" id="btn-loupe" title="Kính lúp" onclick="toggleLoupe()"><i class="fas fa-search"></i></button>
            <button class="btn" onclick="zoomOut()"><i class="fas fa-minus"></i></button>
            <button class="btn" onclick="resetZoom()"><i class="fas fa-expand"></i></button>
            <button class="btn" onclick="zoomIn()"><i class="fas fa-plus"></i></button>
            <button class="btn" id="btn-sound" onclick="toggleSound()"><i class="fas fa-volume-up"></i></button>
        </div>
    </div>

    <div class="stage">
        <div class="zoom-layer" id="zoom-layer">
            <div id="book"></div>
        </div>
        
        <div id="pan-overlay"></div>
        
        <div id="magnifier"></div>
    </div>

    <audio id="snd-flip" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3" preload="auto"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // --- BIẾN TOÀN CỤC ---
        let pdfDoc = null;
        let pageFlip = null;
        let scaleVal = 1;
        let isSound = true;
        let isLoupe = false;

        // Biến cho việc Kéo thả (Pan)
        let panX = 0, panY = 0;
        let isDragging = false;
        let startX = 0, startY = 0;

        const bookEl = document.getElementById('book');
        const zoomLayer = document.getElementById('zoom-layer');
        const panOverlay = document.getElementById('pan-overlay');
        const magnifier = document.getElementById('magnifier');

        // --- 1. XỬ LÝ UPLOAD ---
        document.getElementById('inp-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            document.querySelector('.upload-box').style.display = 'none';
            document.getElementById('progress-bar').style.display = 'block';
            document.getElementById('status-txt').style.display = 'block';

            // Kích hoạt âm thanh ngay lần click đầu tiên để browser không chặn
            document.getElementById('snd-flip').play().catch(()=>{}); 
            document.getElementById('snd-flip').pause();

            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async (ev) => {
                const data = new Uint8Array(ev.target.result);
                pdfDoc = await pdfjsLib.getDocument(data).promise;
                document.getElementById('page-num').innerText = `1 / ${pdfDoc.numPages}`;
                await renderPages();
            };
        });

        // --- 2. RENDER PDF ---
        async function renderPages() {
            bookEl.innerHTML = '';
            const total = pdfDoc.numPages;
            
            for(let i=1; i<=total; i++) {
                const page = await pdfDoc.getPage(i);
                // Scale 1.5 đủ nét, nhẹ máy
                const viewport = page.getViewport({ scale: 1.5 });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { alpha: false });
                
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.className = 'my-page'; // Class để PageFlip nhận diện
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                bookEl.appendChild(canvas);

                // Update UI
                const pct = Math.round((i/total)*100);
                document.getElementById('progress-fill').style.width = pct + '%';
                document.getElementById('status-txt').innerText = `Đang xử lý trang ${i}`;
            }

            document.getElementById('upload-screen').style.display = 'none';
            initBook();
        }

        // --- 3. KHỞI TẠO SÁCH ---
        function initBook() {
            const isMobile = window.innerWidth < 768;
            
            pageFlip = new St.PageFlip(bookEl, {
                width: isMobile ? 350 : 550,
                height: isMobile ? 500 : 750,
                size: "stretch",
                minWidth: 300,
                maxWidth: 1000,
                minHeight: 400,
                maxHeight: 1200,
                showCover: true,
                usePortrait: isMobile,
                startPage: 0,
                // QUAN TRỌNG: Bật chuột để lật trang
                useMouseEvents: true 
            });

            pageFlip.loadFromHTML(document.querySelectorAll('.my-page'));

            pageFlip.on('flip', (e) => {
                document.getElementById('page-num').innerText = `${e.data + 1} / ${pdfDoc.numPages}`;
                playSound();
            });
        }

        // --- 4. ÂM THANH ---
        function playSound() {
            if(!isSound) return;
            const audio = document.getElementById('snd-flip');
            audio.currentTime = 0;
            audio.play().catch(e => {}); // Bỏ qua lỗi nếu bị chặn
        }

        function toggleSound() {
            isSound = !isSound;
            const btn = document.getElementById('btn-sound');
            btn.innerHTML = isSound ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            btn.style.opacity = isSound ? 1 : 0.5;
        }

        // --- 5. ZOOM & PAN (KÉO THẢ) ---
        function applyTransform() {
            zoomLayer.style.transform = `translate(${panX}px, ${panY}px) scale(${scaleVal})`;
            
            // Logic quan trọng:
            // Nếu Zoom > 1: Hiện lớp PanOverlay để nhận sự kiện kéo thả (chặn lật trang)
            // Nếu Zoom = 1: Ẩn PanOverlay để trả lại sự kiện chuột cho sách (để lật trang)
            if (scaleVal > 1) {
                panOverlay.style.display = 'block';
            } else {
                panOverlay.style.display = 'none';
                panX = 0; panY = 0; // Reset vị trí
                zoomLayer.style.transform = `translate(0px, 0px) scale(1)`;
            }
        }

        function zoomIn() {
            if(scaleVal < 4) { scaleVal += 0.5; applyTransform(); }
        }
        function zoomOut() {
            if(scaleVal > 1) { scaleVal -= 0.5; applyTransform(); }
        }
        function resetZoom() {
            scaleVal = 1; applyTransform();
            // Tắt kính lúp nếu đang bật
            if(isLoupe) toggleLoupe();
        }

        // Xử lý kéo thả trên PanOverlay
        panOverlay.addEventListener('mousedown', (e) => {
            isDragging = true;
            startX = e.clientX - panX;
            startY = e.clientY - panY;
            panOverlay.classList.add('grabbing');
        });
        
        window.addEventListener('mousemove', (e) => {
            // Logic Kéo thả
            if(isDragging) {
                e.preventDefault();
                panX = e.clientX - startX;
                panY = e.clientY - startY;
                applyTransform();
            }

            // Logic Kính lúp
            if(isLoupe) updateMagnifier(e);
        });

        window.addEventListener('mouseup', () => {
            isDragging = false;
            panOverlay.classList.remove('grabbing');
        });

        // --- 6. KÍNH LÚP ---
        function toggleLoupe() {
            isLoupe = !isLoupe;
            const btn = document.getElementById('btn-loupe');
            
            if(isLoupe) {
                btn.classList.add('active');
                magnifier.style.display = 'block';
                // Khi bật kính lúp, bật luôn lớp phủ để tránh lật trang lung tung
                panOverlay.style.display = 'block'; 
                panOverlay.style.cursor = 'crosshair'; // Đổi con trỏ thành dấu cộng
            } else {
                btn.classList.remove('active');
                magnifier.style.display = 'none';
                panOverlay.style.cursor = 'grab';
                // Nếu đang không zoom thì tắt lớp phủ đi để lật trang
                if(scaleVal === 1) panOverlay.style.display = 'none';
            }
        }

        function updateMagnifier(e) {
            // Di chuyển kính lúp theo chuột
            magnifier.style.left = (e.clientX + 20) + 'px';
            magnifier.style.top = (e.clientY + 20) + 'px';

            // Ẩn kính lúp tạm thời để lấy phần tử bên dưới
            magnifier.style.display = 'none';
            const elemBelow = document.elementFromPoint(e.clientX, e.clientY);
            magnifier.style.display = 'block';

            // Kiểm tra xem chuột có đang đè lên Canvas (trang sách) không
            if (elemBelow && elemBelow.tagName === 'CANVAS') {
                const rect = elemBelow.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Hiển thị ảnh trong kính lúp
                // Zoom 2x trong kính
                magnifier.style.backgroundImage = `url(${elemBelow.toDataURL()})`;
                magnifier.style.backgroundSize = `${rect.width * 2}px ${rect.height * 2}px`;
                magnifier.style.backgroundPosition = `-${x * 2 - 125}px -${y * 2 - 125}px`;
            } else {
                magnifier.style.backgroundImage = 'none';
            }
        }

        // Nút điều hướng
        document.getElementById('btn-prev').onclick = () => pageFlip.flipPrev();
        document.getElementById('btn-next').onclick = () => pageFlip.flipNext();
    </script>
</body>
</html>
