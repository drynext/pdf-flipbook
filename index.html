<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipOS V14 (Hybrid Titan)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. CORE & THEME --- */
        :root {
            --bg: #121212; --panel: rgba(30, 30, 35, 0.9);
            --text: #ececec; --accent: #6c5ce7;
            --border: rgba(255, 255, 255, 0.1);
            --shadow: 0 10px 40px rgba(0,0,0,0.6);
            --blur: blur(15px);
        }
        [data-theme="light"] {
            --bg: #f4f5f7; --panel: rgba(255, 255, 255, 0.9);
            --text: #2d3436; --accent: #0984e3; --border: rgba(0, 0, 0, 0.1);
        }
        * { margin:0; padding:0; box-sizing:border-box; outline:none; user-select:none; touch-action:none; }
        
        body {
            background: var(--bg); color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            transition: 0.3s;
        }

        /* --- 2. DYNAMIC ISLANDS (UI) --- */
        .island {
            position: fixed; z-index: 1000;
            background: var(--panel); backdrop-filter: var(--blur);
            border: 1px solid var(--border); box-shadow: var(--shadow);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex; align-items: center; gap: 10px;
        }

        /* --- UI MODE: MOBILE (Default Horizontal) --- */
        body.mode-mobile .island-top {
            top: 20px; left: 50%; transform: translateX(-50%);
            padding: 8px 20px; border-radius: 50px; flex-direction: row;
        }
        body.mode-mobile .island-side {
            bottom: 90px; left: 50%; transform: translateX(-50%) translateY(20px);
            padding: 10px 20px; border-radius: 20px; flex-direction: row;
            opacity: 0; pointer-events: none;
        }
        body.mode-mobile .island-side.visible { opacity: 1; transform: translateX(-50%) translateY(0); pointer-events: all; }
        
        body.mode-mobile .island-bottom {
            bottom: 30px; left: 50%; transform: translateX(-50%);
            padding: 10px 25px; border-radius: 24px; flex-direction: row;
        }

        /* --- UI MODE: DESKTOP (Vertical Sidebars) --- */
        body.mode-desktop .island-top {
            top: 50%; left: 20px; transform: translateY(-50%);
            padding: 20px 8px; border-radius: 24px; flex-direction: column;
        }
        body.mode-desktop .island-side {
            top: 50%; left: 90px; transform: translateY(-50%) translateX(-20px);
            padding: 15px 10px; border-radius: 20px; flex-direction: column;
            opacity: 0; pointer-events: none;
        }
        body.mode-desktop .island-side.visible { opacity: 1; transform: translateY(-50%) translateX(0); pointer-events: all; }

        body.mode-desktop .island-bottom {
            top: 50%; right: 20px; transform: translateY(-50%);
            padding: 20px 10px; border-radius: 24px; flex-direction: column; bottom: auto; left: auto;
        }

        /* Adjust Stage Padding to avoid covering content */
        body.mode-desktop .stage { padding: 0 100px; } 
        body.mode-mobile .stage { padding: 80px 0; }

        /* --- COMPONENTS --- */
        .btn-mode {
            padding: 8px 16px; border-radius: 16px; cursor: pointer; font-weight: 700;
            color: var(--text); background: transparent; opacity: 0.5; transition: 0.2s; border: none;
            white-space: nowrap;
        }
        .btn-mode.active { background: var(--accent); color: #fff; opacity: 1; }
        /* Vertical Text for Desktop Mode */
        body.mode-desktop .btn-mode { writing-mode: vertical-rl; padding: 16px 8px; }

        .btn-icon {
            width: 40px; height: 40px; border-radius: 12px;
            border: 1px solid transparent; background: rgba(128,128,128,0.1);
            color: var(--text); font-size: 1.1rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center; transition: 0.2s;
        }
        .btn-icon:hover { background: var(--accent); color: #fff; transform: scale(1.1); }
        .btn-icon.active { background: var(--accent); color: #fff; box-shadow: 0 0 15px var(--accent); }

        .color-dot { width: 24px; height: 24px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.active { border-color: #fff; transform: scale(1.2); }

        .divider { width: 1px; height: 20px; background: rgba(128,128,128,0.3); }
        body.mode-desktop .divider { width: 20px; height: 1px; }

        /* --- UI SWITCHER BUTTON (FIXED CORNER) --- */
        #ui-switcher {
            position: fixed; bottom: 20px; right: 20px; z-index: 2000;
            width: 50px; height: 50px; border-radius: 50%;
            background: var(--panel); border: 2px solid var(--accent);
            color: var(--accent); font-size: 1.2rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); transition: 0.3s;
        }
        #ui-switcher:hover { transform: rotate(180deg); background: var(--accent); color: #fff; }

        /* --- STAGE --- */
        .stage {
            width: 100%; height: 100%; position: relative;
            background-image: radial-gradient(rgba(128,128,128,0.15) 1px, transparent 1px);
            background-size: 30px 30px; transition: padding 0.4s;
            display: flex; justify-content: center; align-items: center;
        }
        
        .viewport { transition: transform 0.1s linear; transform-style: preserve-3d; }
        .page-wrap { position: relative; background: #fff; overflow: hidden; backface-visibility: hidden; }
        canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
        .ink-layer { z-index: 10; cursor: crosshair; }

        /* --- OVERLAYS --- */
        #pan-ol { position: absolute; top:0; left:0; width:100%; height:100%; z-index:500; display:none; cursor:grab; }
        .spyglass {
            position: absolute; width:200px; height:200px; border-radius:50%; border:4px solid #fff;
            box-shadow: 0 10px 50px rgba(0,0,0,0.6); overflow: hidden; pointer-events: none; z-index: 9999;
            display: none; background: #fff;
        }

        /* --- UPLOAD --- */
        .upload-modal {
            position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:5000;
            display:flex; flex-direction:column; justify-content:center; align-items:center;
        }
        .upload-box {
            padding:40px; border:2px dashed #444; border-radius:30px; text-align:center; cursor:pointer;
        }
        .upload-box:hover { border-color:var(--accent); }
    </style>
</head>
<body class="mode-mobile" data-theme="dark">

    <div id="ui-switcher" onclick="App.toggleUIMode()" title="Chuyển chế độ Desktop/Mobile">
        <i class="fas fa-mobile-alt" id="ui-icon"></i>
    </div>

    <div class="island island-top">
        <button class="btn-mode active" id="btn-read" onclick="App.setMode('READ')">ĐỌC</button>
        <div class="divider"></div>
        <button class="btn-mode" id="btn-draw" onclick="App.setMode('DRAW')">VẼ</button>
        <div class="divider"></div>
        <i class="fas fa-moon btn-icon" onclick="App.toggleTheme()" style="border:none; width:30px;"></i>
    </div>

    <div class="island island-side" id="tools">
        <div class="btn-icon active" id="t-pen" onclick="Pen.tool='pen'; Pen.ui()"><i class="fas fa-pen"></i></div>
        <div class="btn-icon" id="t-marker" onclick="Pen.tool='marker'; Pen.ui()"><i class="fas fa-highlighter"></i></div>
        <div class="btn-icon" id="t-eraser" onclick="Pen.tool='eraser'; Pen.ui()"><i class="fas fa-eraser"></i></div>
        <div class="divider"></div>
        <div class="color-dot active" style="background:#ff4757" onclick="Pen.setColor('#ff4757',this)"></div>
        <div class="color-dot" style="background:#2ed573" onclick="Pen.setColor('#2ed573',this)"></div>
        <div class="color-dot" style="background:#3742fa" onclick="Pen.setColor('#3742fa',this)"></div>
        <div class="divider"></div>
        <div class="btn-icon" onclick="Pen.clear()"><i class="fas fa-trash"></i></div>
    </div>

    <div class="island island-bottom">
        <div class="btn-icon" onclick="App.flip('prev')"><i class="fas fa-chevron-left"></i></div>
        <span id="pg-num" style="font-weight:800; font-variant-numeric:tabular-nums;">--/--</span>
        <div class="btn-icon" onclick="App.flip('next')"><i class="fas fa-chevron-right"></i></div>
        <div class="divider"></div>
        <div class="btn-icon" onclick="Zoom.act(-1)"><i class="fas fa-minus"></i></div>
        <div class="btn-icon" onclick="Zoom.act(1)"><i class="fas fa-plus"></i></div>
        <div class="divider"></div>
        <div class="btn-icon" id="btn-loupe" onclick="Loupe.toggle()"><i class="fas fa-search"></i></div>
    </div>

    <div class="stage">
        <div class="viewport" id="viewport"><div id="book"></div></div>
        <div id="pan-ol"></div>
        <div class="spyglass" id="spy"><canvas id="spy-c"></canvas></div>
    </div>

    <div class="upload-modal" id="modal">
        <div class="upload-box" onclick="document.getElementById('inp').click()">
            <i class="fas fa-meteor" style="font-size:3rem; color:var(--accent); margin-bottom:15px;"></i>
            <h1>FlipOS V14</h1>
            <p style="color:#888">Hybrid Titan Edition</p>
        </div>
        <input type="file" id="inp" hidden accept="application/pdf">
    </div>

    <audio id="sfx" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const S = { pdf:null, flip:null, mode:'READ', zoom:1 };

        const App = {
            init() {
                document.getElementById('inp').onchange = this.load;
                window.onresize = () => this.checkUI();
            },
            async load(e) {
                if(!e.target.files[0]) return;
                document.querySelector('.upload-box').innerHTML = 'Loading System...';
                const ab = await e.target.files[0].arrayBuffer();
                S.pdf = await pdfjsLib.getDocument(ab).promise;
                await App.render();
            },
            async render() {
                const b = document.getElementById('book'); b.innerHTML='';
                for(let i=1; i<=S.pdf.numPages; i++) {
                    const p = await S.pdf.getPage(i);
                    const v = p.getViewport({scale:1.5});
                    const w = document.createElement('div'); w.className='page-wrap';
                    
                    const pc = document.createElement('canvas'); pc.className='pdf-l'; pc.width=v.width; pc.height=v.height;
                    await p.render({canvasContext:pc.getContext('2d'), viewport:v}).promise;
                    
                    const ic = document.createElement('canvas'); ic.className='ink-layer'; ic.width=v.width; ic.height=v.height;
                    
                    w.append(pc, ic); b.append(w);
                }
                document.getElementById('modal').style.display='none';
                this.initFlip(); Pen.init(); Zoom.init();
            },
            initFlip() {
                const w = window.innerWidth;
                S.flip = new St.PageFlip(document.getElementById('book'), {
                    width: w<768?380:550, height: w<768?550:750,
                    size:'stretch', showCover:true, useMouseEvents:true
                });
                S.flip.loadFromHTML(document.querySelectorAll('.page-wrap'));
                S.flip.on('flip', e => {
                    document.getElementById('pg-num').innerText = (e.data+1)+'/'+S.pdf.numPages;
                    document.getElementById('sfx').play().catch(()=>{});
                });
            },
            setMode(m) {
                S.mode = m;
                const r = document.getElementById('btn-read'), d = document.getElementById('btn-draw');
                const t = document.getElementById('tools'), p = document.getElementById('pan-ol');
                
                if(m==='READ') {
                    r.classList.add('active'); d.classList.remove('active');
                    t.classList.remove('visible'); p.style.display='none';
                    if(S.flip) S.flip.update({useMouseEvents:true});
                } else {
                    d.classList.add('active'); r.classList.remove('active');
                    t.classList.add('visible'); p.style.display='none';
                    if(S.flip) S.flip.update({useMouseEvents:false});
                }
            },
            flip(d) { S.flip?.[d==='prev'?'flipPrev':'flipNext'](); },
            toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')=='dark'?'light':'dark'); },
            
            // --- UI SWITCHER LOGIC ---
            toggleUIMode() {
                const b = document.body;
                const i = document.getElementById('ui-icon');
                if(b.classList.contains('mode-mobile')) {
                    b.classList.replace('mode-mobile', 'mode-desktop');
                    i.className = 'fas fa-desktop';
                } else {
                    b.classList.replace('mode-desktop', 'mode-mobile');
                    i.className = 'fas fa-mobile-alt';
                }
                // Resize sách khi đổi layout để ko bị che
                setTimeout(() => { if(S.flip) S.flip.update(); }, 400);
            },
            checkUI() { /* Auto detect if needed, currently manual */ }
        };

        // --- PEN ENGINE (SEAMLESS JUMP) ---
        const Pen = {
            tool:'pen', color:'#ff4757', ctx:null, can:null, isDown:false, last:{x:0,y:0},
            init() {
                // Attach event to wrapper to catch events between pages
                const st = document.querySelector('.stage');
                st.addEventListener('pointerdown', e => this.down(e));
                window.addEventListener('pointermove', e => this.move(e));
                window.addEventListener('pointerup', () => this.up());
            },
            ui() {
                document.querySelectorAll('#tools .btn-icon').forEach(b => b.classList.remove('active'));
                document.getElementById('t-'+this.tool).classList.add('active');
            },
            setColor(c,el) {
                this.color=c; this.tool='pen'; this.ui();
                document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active'));
                el.classList.add('active');
            },
            getHit(e) {
                // Find ink-layer under cursor
                const el = document.elementFromPoint(e.clientX, e.clientY);
                if(el && el.classList.contains('ink-layer')) return el;
                return null;
            },
            down(e) {
                if(S.mode!=='DRAW') return;
                const hit = this.getHit(e);
                if(!hit) return;
                
                e.preventDefault();
                this.isDown = true;
                this.setupCtx(hit);
                this.last = this.pos(e, hit);
                
                this.ctx.beginPath();
                this.ctx.moveTo(this.last.x, this.last.y);
                this.ctx.stroke();
            },
            move(e) {
                if(!this.isDown || S.mode!=='DRAW') return;
                
                let hit = this.getHit(e);
                // INK JUMPING LOGIC: Nếu trượt sang trang khác -> Đổi context
                if(hit && hit !== this.can) {
                    this.ctx.closePath(); // Kết thúc nét cũ
                    this.setupCtx(hit);   // Sang trang mới
                    this.last = this.pos(e, hit); // Reset vị trí
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.last.x, this.last.y);
                }

                if(this.can) {
                    const curr = this.pos(e, this.can);
                    // Curve smooth
                    const mid = {x: (this.last.x+curr.x)/2, y: (this.last.y+curr.y)/2};
                    this.ctx.quadraticCurveTo(this.last.x, this.last.y, mid.x, mid.y);
                    this.ctx.stroke();
                    this.last = curr;
                }
            },
            up() { this.isDown=false; if(this.ctx) this.ctx.closePath(); },
            setupCtx(c) {
                this.can = c; this.ctx = c.getContext('2d');
                this.ctx.lineCap = 'round'; this.ctx.lineJoin = 'round';
                if(this.tool==='eraser') {
                    this.ctx.globalCompositeOperation='destination-out'; this.ctx.lineWidth=30;
                } else if(this.tool==='marker') {
                    this.ctx.globalCompositeOperation='multiply'; this.ctx.strokeStyle=this.color; 
                    this.ctx.lineWidth=20; this.ctx.globalAlpha=0.5;
                } else {
                    this.ctx.globalCompositeOperation='source-over'; this.ctx.strokeStyle=this.color; 
                    this.ctx.lineWidth=3; this.ctx.globalAlpha=1;
                }
            },
            pos(e, c) {
                const r = c.getBoundingClientRect();
                return { x: (e.clientX - r.left)*(c.width/r.width), y: (e.clientY - r.top)*(c.height/r.height) };
            },
            clear() {
                if(this.can) {
                    const ctx = this.can.getContext('2d');
                    ctx.clearRect(0,0,this.can.width, this.can.height);
                }
            }
        };

        const Zoom = {
            v:1, pan:{x:0,y:0}, isD:false, start:{x:0,y:0},
            init() {
                const o = document.getElementById('pan-ol');
                o.onpointerdown=e=>{this.isD=true; this.start={x:e.clientX-this.pan.x, y:e.clientY-this.pan.y}; o.style.cursor='grabbing'};
                window.onpointermove=e=>{
                    if(this.isD){ e.preventDefault(); this.pan={x:e.clientX-this.start.x, y:e.clientY-this.start.y}; this.upd(); }
                    if(Loupe.on) Loupe.draw(e);
                };
                window.onpointerup=()=>{this.isD=false; o.style.cursor='grab'};
            },
            act(d) { if((d>0 && this.v<3) || (d<0 && this.v>1)) { this.v+=d*0.5; this.upd(); } },
            upd() {
                const vp = document.getElementById('viewport');
                vp.style.transform = `translate(${this.pan.x}px,${this.pan.y}px) scale(${this.v})`;
                const p = document.getElementById('pan-ol');
                if(this.v>1 && S.mode==='READ') { p.style.display='block'; if(S.flip) S.flip.update({useMouseEvents:false}); }
                else { p.style.display='none'; this.pan={x:0,y:0}; vp.style.transform='scale(1)'; if(S.mode==='READ' && S.flip) S.flip.update({useMouseEvents:true}); }
            }
        };

        const Loupe = {
            on:false,
            toggle() { this.on=!this.on; document.getElementById('btn-loupe').classList.toggle('active',this.on); document.getElementById('spy').style.display=this.on?'block':'none'; },
            draw(e) {
                const spy=document.getElementById('spy'), ctx=document.getElementById('spy-c').getContext('2d');
                document.getElementById('spy-c').width=500; document.getElementById('spy-c').height=500;
                spy.style.left=(e.clientX+20)+'px'; spy.style.top=(e.clientY+20)+'px';
                
                spy.style.display='none'; const el=document.elementFromPoint(e.clientX,e.clientY); spy.style.display='block';
                const w = el?.closest('.page-wrap');
                if(w) {
                    const pdf=w.querySelector('.pdf-l'), ink=w.querySelector('.ink-layer');
                    const r=pdf.getBoundingClientRect();
                    const x=(e.clientX-r.left)*(pdf.width/r.width), y=(e.clientY-r.top)*(pdf.height/r.height);
                    ctx.fillStyle='#fff'; ctx.fillRect(0,0,500,500);
                    ctx.drawImage(pdf, x-100, y-100, 200, 200, 0,0,500,500);
                    ctx.drawImage(ink, x-100, y-100, 200, 200, 0,0,500,500);
                }
            }
        };

        App.init();
    </script>
</body>
</html>
