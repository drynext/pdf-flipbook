<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FlipOS V21 Enterprise Edition - Advanced PDF Visualization & Annotation System">
    <meta name="author" content="Dang Duc Dai - Lead Architect">
    <title>FlipOS V21 | Thesis Defense Edition</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* * ======================================================================================
         * MODULE 1: GLOBAL DESIGN TOKENS & SYSTEM VARIABLES
         * Description: Centralized configuration for theming and layout metrics.
         * ======================================================================================
         */
        :root {
            /* Semantic Color Palette: Deep Space Dark Mode */
            --sys-color-background-primary: #050505; /* Absolute Black */
            --sys-color-background-secondary: #121212; /* Elevation 1 */
            --sys-color-background-panel: #1a1a1d; /* Elevation 2 */
            
            --sys-color-text-primary: #ffffff;
            --sys-color-text-secondary: #a1a1aa;
            
            --sys-color-accent-main: #3b82f6; /* Enterprise Blue */
            --sys-color-accent-hover: #2563eb;
            
            --sys-color-border-subtle: #27272a;
            --sys-color-border-active: #3f3f46;
            
            /* Layout Metrics */
            --sys-layout-sidebar-width: 72px; /* Fixed Width */
            --sys-layout-z-index-ui: 1000;
            --sys-layout-z-index-stage: 10;
            
            /* Effects */
            --sys-effect-shadow-panel: 0 0 0 1px rgba(255,255,255,0.05), 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        /* Light Mode Override */
        [data-theme="light"] {
            --sys-color-background-primary: #f0f2f5;
            --sys-color-background-secondary: #ffffff;
            --sys-color-background-panel: #ffffff;
            --sys-color-text-primary: #18181b;
            --sys-color-text-secondary: #71717a;
            --sys-color-border-subtle: #e4e4e7;
            --sys-color-border-active: #d4d4d8;
            --sys-effect-shadow-panel: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px 0 rgba(0,0,0,0.06);
        }

        /* Global Reset */
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        /* * ======================================================================================
         * MODULE 2: MASTER GRID LAYOUT ARCHITECTURE (THE "CONCRETE" FIX)
         * Description: Hard-locks the UI regions. They CANNOT move or resize.
         * ======================================================================================
         */
        body {
            background-color: var(--sys-color-background-primary);
            color: var(--sys-color-text-primary);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Critical: Disables body scroll */
            
            /* CSS GRID LEVEL 3: 3-COLUMN HARD LAYOUT */
            display: grid;
            grid-template-columns: var(--sys-layout-sidebar-width) 1fr var(--sys-layout-sidebar-width);
            grid-template-rows: 100%;
            grid-template-areas: "region-sidebar-left region-viewport-center region-sidebar-right";
        }

        /* --- UI REGION: LEFT SIDEBAR (TOOLS) --- */
        .system-sidebar-container {
            background-color: var(--sys-color-background-panel);
            border-right: 1px solid var(--sys-color-border-subtle);
            border-left: 1px solid var(--sys-color-border-subtle);
            z-index: var(--sys-layout-z-index-ui);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            gap: 16px;
            box-shadow: var(--sys-effect-shadow-panel);
        }

        #ui-region-left {
            grid-area: region-sidebar-left;
            border-left: none; /* Leftmost edge */
        }

        #ui-region-right {
            grid-area: region-sidebar-right;
            border-right: none; /* Rightmost edge */
        }

        /* --- VIEWPORT REGION: CENTER STAGE (THE BOOK) --- */
        #system-viewport-stage {
            grid-area: region-viewport-center;
            position: relative;
            overflow: hidden; /* Cages the zoom inside */
            background-image: 
                radial-gradient(var(--sys-color-border-subtle) 1px, transparent 1px);
            background-size: 24px 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: grab;
        }
        #system-viewport-stage:active {
            cursor: grabbing;
        }

        /* The Transformation Matrix Target */
        #visual-transform-matrix {
            /* This div gets Scaled/Translated. It's ISOLATED from the UI */
            transform-origin: center center;
            will-change: transform;
            transition: transform 0.1s linear; /* Smooth linear interpolation */
        }

        /* * ======================================================================================
         * MODULE 3: COMPONENT LIBRARY
         * ======================================================================================
         */
        
        /* Interactive Buttons */
        .sys-btn-control {
            width: 48px; height: 48px;
            border-radius: 12px;
            background-color: rgba(128,128,128,0.05);
            color: var(--sys-color-text-secondary);
            border: 1px solid transparent;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.25rem;
            transition: all 0.2s ease;
        }
        .sys-btn-control:hover {
            background-color: rgba(128,128,128,0.15);
            color: var(--sys-color-text-primary);
            transform: translateY(-2px);
        }
        .sys-btn-control.state-active {
            background-color: var(--sys-color-accent-main);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        /* Mode Switcher Group */
        .sys-mode-group {
            background-color: rgba(0,0,0,0.2);
            padding: 6px;
            border-radius: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .sys-mode-item {
            width: 36px; height: 36px;
            border-radius: 10px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            opacity: 0.5;
            transition: 0.2s;
        }
        .sys-mode-item.state-active {
            background-color: var(--sys-color-background-secondary);
            color: var(--sys-color-accent-main);
            opacity: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Color Indicators */
        .sys-color-swatch {
            width: 32px; height: 32px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .sys-color-swatch.state-active {
            border-color: var(--sys-color-text-primary);
            transform: scale(1.15);
        }

        /* Horizontal Divider */
        .sys-ui-divider {
            width: 60%; height: 1px;
            background-color: var(--sys-color-border-subtle);
            margin: 4px 0;
        }

        /* Zoom Label */
        .sys-zoom-label {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--sys-color-accent-main);
            margin: 5px 0;
        }

        /* * ======================================================================================
         * MODULE 4: RENDERING LAYERS (Canvas & PDF)
         * ======================================================================================
         */
        
        /* The "Book" container managed by St.PageFlip library */
        .document-page-wrapper {
            position: relative;
            background-color: #fff;
            overflow: hidden;
            /* Box shadow for realism */
            box-shadow: inset 20px 0 50px -20px rgba(0,0,0,0.2); 
        }

        /* Layer Stacking Context */
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .layer-type-pdf-raster { z-index: 1; pointer-events: none; }
        
        /* Ink Layer: Receives Input */
        .layer-type-digital-ink { 
            z-index: 10; 
            cursor: crosshair; 
            touch-action: none; 
        }

        /* Interaction Pan Mask (Visible only when Zoom > 1) */
        #interaction-pan-mask {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500; display: none; /* Default Hidden */
        }

        /* * ======================================================================================
         * MODULE 5: UTILITY SCREENS (Upload, Loading)
         * ======================================================================================
         */
        #system-overlay-upload {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(5,5,5,0.96);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .upload-interface-box {
            padding: 60px 80px;
            border: 2px dashed var(--sys-color-border-active);
            border-radius: 32px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(145deg, rgba(255,255,255,0.03), transparent);
        }
        .upload-interface-box:hover {
            border-color: var(--sys-color-accent-main);
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }

        #system-notification-toast {
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%);
            background-color: var(--sys-color-background-panel);
            color: var(--sys-color-text-primary);
            padding: 12px 24px;
            border-radius: 50px;
            border: 1px solid var(--sys-color-border-active);
            font-size: 0.9rem;
            font-weight: 600;
            opacity: 0; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 8000;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #system-notification-toast.state-visible {
            opacity: 1; transform: translateX(-50%) translateY(-10px);
        }

    </style>
</head>
<body data-theme="dark">

    <div id="system-overlay-upload">
        <div class="upload-interface-box" onclick="document.getElementById('core-file-input').click()">
            <i class="fas fa-file-pdf" style="font-size: 4rem; color: var(--sys-color-accent-main); margin-bottom: 24px;"></i>
            <h1 style="font-size: 2.5rem; font-weight: 800; letter-spacing: -1px; margin-bottom: 10px;">FLIP OS V21</h1>
            <p style="color: var(--sys-color-text-secondary); font-family: 'JetBrains Mono';">Enterprise Thesis Edition</p>
            <div style="margin-top: 20px; font-size: 0.8rem; opacity: 0.6;">CLICK TO MOUNT FILE SYSTEM</div>
        </div>
        <input type="file" id="core-file-input" hidden accept="application/pdf">
    </div>

    <aside class="system-sidebar-container" id="ui-region-left">
        <div class="sys-mode-group">
            <div class="sys-mode-item state-active" id="ctrl-mode-read" onclick="FlipOS_Kernel_System.setOperationalMode('MODE_READ')" title="Reader Mode">
                <i class="fas fa-book-open"></i>
            </div>
            <div class="sys-mode-item" id="ctrl-mode-draw" onclick="FlipOS_Kernel_System.setOperationalMode('MODE_STUDIO')" title="Studio Mode">
                <i class="fas fa-pencil-alt"></i>
            </div>
        </div>

        <div class="sys-ui-divider"></div>

        <button class="sys-btn-control" id="tool-pen" onclick="FlipOS_Ink_Subsystem.setActiveInstrument('TOOL_PEN')" title="Ballpoint Pen">
            <i class="fas fa-pen"></i>
        </button>
        <button class="sys-btn-control" id="tool-marker" onclick="FlipOS_Ink_Subsystem.setActiveInstrument('TOOL_MARKER')" title="Highlighter">
            <i class="fas fa-highlighter"></i>
        </button>
        <button class="sys-btn-control" id="tool-eraser" onclick="FlipOS_Ink_Subsystem.setActiveInstrument('TOOL_ERASER')" title="Eraser">
            <i class="fas fa-eraser"></i>
        </button>

        <div class="sys-ui-divider"></div>

        <div class="sys-color-swatch state-active" style="background-color: #ef4444;" onclick="FlipOS_Ink_Subsystem.setInkColor('#ef4444', this)"></div>
        <div class="sys-color-swatch" style="background-color: #22c55e;" onclick="FlipOS_Ink_Subsystem.setInkColor('#22c55e', this)"></div>
        <div class="sys-color-swatch" style="background-color: #3b82f6;" onclick="FlipOS_Ink_Subsystem.setInkColor('#3b82f6', this)"></div>
        <div class="sys-color-swatch" style="background-color: #eab308;" onclick="FlipOS_Ink_Subsystem.setInkColor('#eab308', this)"></div>

        <div class="sys-ui-divider"></div>

        <button class="sys-btn-control" onclick="FlipOS_Ink_Subsystem.executeUndoSequence()" title="Undo (Ctrl+Z)">
            <i class="fas fa-undo"></i>
        </button>
        <button class="sys-btn-control" onclick="FlipOS_Ink_Subsystem.executeClearCanvas()" title="Purge Page">
            <i class="fas fa-trash-alt"></i>
        </button>
    </aside>

    <main id="system-viewport-stage" ondblclick="FlipOS_Viewport_Manager.resetTransformationMatrix()">
        
        <div id="visual-transform-matrix">
            <div id="book-component-root"></div>
        </div>

        <div id="interaction-pan-mask"></div>

    </main>

    <aside class="system-sidebar-container" id="ui-region-right">
        <button class="sys-btn-control" onclick="FlipOS_Interface_Utils.toggleSystemTheme()" title="Toggle Dark/Light">
            <i class="fas fa-adjust"></i>
        </button>

        <div class="sys-ui-divider"></div>

        <button class="sys-btn-control" onclick="FlipOS_Viewport_Manager.modifyZoomFactor(1)" title="Zoom In">
            <i class="fas fa-plus"></i>
        </button>
        <span class="sys-zoom-label" id="display-zoom-metric">100%</span>
        <button class="sys-btn-control" onclick="FlipOS_Viewport_Manager.modifyZoomFactor(-1)" title="Zoom Out">
            <i class="fas fa-minus"></i>
        </button>

        <div class="sys-ui-divider"></div>

        <button class="sys-btn-control" onclick="FlipOS_Book_Engine.navigatePages('NAV_PREV')">
            <i class="fas fa-chevron-up"></i>
        </button>
        <span id="display-pagination-metric" style="font-family:'JetBrains Mono'; font-size:0.75rem; font-weight:700;">--/--</span>
        <button class="sys-btn-control" onclick="FlipOS_Book_Engine.navigatePages('NAV_NEXT')">
            <i class="fas fa-chevron-down"></i>
        </button>

        <div class="sys-ui-divider"></div>

        <button class="sys-btn-control" onclick="FlipOS_Interface_Utils.triggerFullscreen()" title="Fullscreen">
            <i class="fas fa-expand"></i>
        </button>
    </aside>

    <div id="system-notification-toast">System Initialized. Ready.</div>
    
    <audio id="sfx-page-turn" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        /**
         * ======================================================================================
         * FLIP OS CORE KERNEL V21
         * Architecture: Singleton State Management with Event-Driven Services
         * Developed for: Thesis Defense
         * ======================================================================================
         */

        // Configuration: PDF.js Worker Thread
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // --- SINGLETON STATE REGISTRY ---
        const FLIPOS_GLOBAL_STORE = {
            runtime: {
                pdfDocument: null,
                bookInstance: null,
                operationalMode: 'MODE_READ', // Enum: MODE_READ | MODE_STUDIO
                zoomLevel: 1.0,
                totalPages: 0,
                currentPage: 0
            },
            config: {
                maxZoom: 4.0,
                minZoom: 1.0,
                zoomStep: 0.5,
                renderScale: 1.5 // High DPI
            }
        };

        // --- SERVICE: KERNEL SYSTEM CONTROLLER ---
        const FlipOS_Kernel_System = {
            /**
             * Bootstraps the application, binding IO events.
             */
            initializeBootSequence() {
                console.log("[FlipOS Kernel] Boot sequence initiated.");
                
                // Bind File Input
                document.getElementById('core-file-input').addEventListener('change', this.handleFileIngestion);

                // Bind Global Keyboard Shortcuts
                window.addEventListener('keydown', (event) => {
                    switch(event.key) {
                        case 'ArrowLeft': 
                        case 'ArrowUp':
                            FlipOS_Book_Engine.navigatePages('NAV_PREV');
                            break;
                        case 'ArrowRight':
                        case 'ArrowDown':
                            FlipOS_Book_Engine.navigatePages('NAV_NEXT');
                            break;
                        case 'z':
                            if (event.ctrlKey) FlipOS_Ink_Subsystem.executeUndoSequence();
                            break;
                        case '+':
                        case '=':
                            FlipOS_Viewport_Manager.modifyZoomFactor(1);
                            break;
                        case '-':
                            FlipOS_Viewport_Manager.modifyZoomFactor(-1);
                            break;
                    }
                });
            },

            /**
             * Processes the raw binary stream from file input.
             */
            async handleFileIngestion(event) {
                const fileObject = event.target.files[0];
                if (!fileObject) return;

                // UI Feedback
                const uploadBox = document.querySelector('.upload-interface-box');
                uploadBox.innerHTML = '<i class="fas fa-cog fa-spin" style="font-size:3rem; color:var(--sys-color-accent-main)"></i><br><br>INITIALIZING RENDER PIPELINE...';

                try {
                    const arrayBuffer = await fileObject.arrayBuffer();
                    FLIPOS_GLOBAL_STORE.runtime.pdfDocument = await pdfjsLib.getDocument(arrayBuffer).promise;
                    FLIPOS_GLOBAL_STORE.runtime.totalPages = FLIPOS_GLOBAL_STORE.runtime.pdfDocument.numPages;
                    
                    // Trigger Render Pipeline
                    await FlipOS_Render_Engine.constructVisualDOM();
                } catch (exception) {
                    console.error("[FlipOS Kernel] Critical Error:", exception);
                    alert("FATAL ERROR: Unable to parse document structure.");
                    location.reload();
                }
            },

            /**
             * Toggles between Reader (View) and Studio (Draw) modes.
             */
            setOperationalMode(targetMode) {
                FLIPOS_GLOBAL_STORE.runtime.operationalMode = targetMode;
                
                // Update UI Indicators
                document.getElementById('ctrl-mode-read').classList.toggle('state-active', targetMode === 'MODE_READ');
                document.getElementById('ctrl-mode-draw').classList.toggle('state-active', targetMode === 'MODE_STUDIO');

                // Logic Branching
                const interactionMask = document.getElementById('interaction-pan-mask');
                const bookInstance = FLIPOS_GLOBAL_STORE.runtime.bookInstance;

                if (targetMode === 'MODE_READ') {
                    // Enable page flipping mechanics
                    if (bookInstance) bookInstance.update({ useMouseEvents: true });
                    
                    // If zoomed in, ensure pan mask is active
                    if (FLIPOS_GLOBAL_STORE.runtime.zoomLevel > 1) {
                        interactionMask.style.display = 'block';
                    }
                    FlipOS_Interface_Utils.displaySystemToast("Switched to: Reader Mode");
                } else {
                    // Disable page flipping mechanics to prevent conflicts with drawing
                    if (bookInstance) bookInstance.update({ useMouseEvents: false });
                    
                    // Disable pan mask to allow direct canvas interaction
                    interactionMask.style.display = 'none';
                    FlipOS_Interface_Utils.displaySystemToast("Switched to: Studio Mode");
                }
            }
        };

        // --- SERVICE: RENDER ENGINE (DOM CONSTRUCTION) ---
        const FlipOS_Render_Engine = {
            /**
             * Generates HTML Canvas elements for PDF and Ink layers.
             */
            async constructVisualDOM() {
                const bookRoot = document.getElementById('book-component-root');
                bookRoot.innerHTML = ''; // Clean slate

                const totalPages = FLIPOS_GLOBAL_STORE.runtime.totalPages;

                for (let i = 1; i <= totalPages; i++) {
                    const pdfPage = await FLIPOS_GLOBAL_STORE.runtime.pdfDocument.getPage(i);
                    const viewport = pdfPage.getViewport({ scale: FLIPOS_GLOBAL_STORE.config.renderScale });

                    // Create Page Container (Wrapper)
                    const pageWrapper = document.createElement('div');
                    pageWrapper.className = 'document-page-wrapper';
                    pageWrapper.dataset.pageIndex = i;

                    // Layer 1: Raster PDF Content
                    const rasterCanvas = document.createElement('canvas');
                    rasterCanvas.className = 'layer-type-pdf-raster';
                    rasterCanvas.width = viewport.width;
                    rasterCanvas.height = viewport.height;
                    
                    // Render PDF to Canvas
                    const rasterContext = rasterCanvas.getContext('2d', { alpha: false });
                    await pdfPage.render({ canvasContext: rasterContext, viewport: viewport }).promise;

                    // Layer 2: Vector Ink Content
                    const vectorCanvas = document.createElement('canvas');
                    vectorCanvas.className = 'layer-type-digital-ink';
                    vectorCanvas.width = viewport.width;
                    vectorCanvas.height = viewport.height;

                    // Assemble DOM Hierarchy
                    pageWrapper.appendChild(rasterCanvas);
                    pageWrapper.appendChild(vectorCanvas);
                    bookRoot.appendChild(pageWrapper);
                }

                // Cleanup & Init Subsystems
                document.getElementById('system-overlay-upload').style.display = 'none';
                FlipOS_Book_Engine.initializeLibrary();
                FlipOS_Ink_Subsystem.attachEventListeners();
                FlipOS_Viewport_Manager.initializePanLogic();
            }
        };

        // --- SERVICE: BOOK ENGINE (PAGE FLIP LOGIC) ---
        const FlipOS_Book_Engine = {
            /**
             * Initializes the 3rd party St.PageFlip library.
             */
            initializeLibrary() {
                // Calculate available viewport width (Dynamic)
                const stageWidth = document.getElementById('system-viewport-stage').clientWidth;
                
                // Logic: Desktop usually fits 2 pages (Landscape), Mobile fits 1 (Portrait)
                // We force specific dimensions to ensure it looks good.
                const bookWidth = stageWidth < 800 ? 400 : 550;
                const bookHeight = stageWidth < 800 ? 600 : 800;

                FLIPOS_GLOBAL_STORE.runtime.bookInstance = new St.PageFlip(document.getElementById('book-component-root'), {
                    width: bookWidth,
                    height: bookHeight,
                    size: 'stretch',
                    minWidth: 300,
                    maxWidth: 1000,
                    minHeight: 400,
                    maxHeight: 1200,
                    showCover: true,
                    maxShadowOpacity: 0.5,
                    useMouseEvents: true // Enabled by default
                });

                // Load pages into engine
                FLIPOS_GLOBAL_STORE.runtime.bookInstance.loadFromHTML(document.querySelectorAll('.document-page-wrapper'));

                // Bind Flip Events
                FLIPOS_GLOBAL_STORE.runtime.bookInstance.on('flip', (e) => {
                    FLIPOS_GLOBAL_STORE.runtime.currentPage = e.data + 1;
                    document.getElementById('display-pagination-metric').innerText = 
                        `${FLIPOS_GLOBAL_STORE.runtime.currentPage} / ${FLIPOS_GLOBAL_STORE.runtime.totalPages}`;
                    
                    // Audio Playback
                    const sfx = document.getElementById('sfx-page-turn');
                    sfx.currentTime = 0;
                    sfx.play().catch(() => { /* Silent fail */ });
                });
            },

            navigatePages(command) {
                const book = FLIPOS_GLOBAL_STORE.runtime.bookInstance;
                if (!book) return;
                
                if (command === 'NAV_PREV') book.flipPrev();
                if (command === 'NAV_NEXT') book.flipNext();
            }
        };

        // --- SERVICE: VIEWPORT MANAGER (ZOOM & PAN) ---
        const FlipOS_Viewport_Manager = {
            state: {
                panX: 0,
                panY: 0,
                isPanning: false,
                startCoords: { x: 0, y: 0 }
            },

            initializePanLogic() {
                const mask = document.getElementById('interaction-pan-mask');
                
                mask.addEventListener('mousedown', (e) => {
                    this.state.isPanning = true;
                    this.state.startCoords = {
                        x: e.clientX - this.state.panX,
                        y: e.clientY - this.state.panY
                    };
                    mask.style.cursor = 'grabbing';
                });

                window.addEventListener('mousemove', (e) => {
                    if (this.state.isPanning) {
                        e.preventDefault();
                        this.state.panX = e.clientX - this.state.startCoords.x;
                        this.state.panY = e.clientY - this.state.startCoords.y;
                        this.applyTransformation();
                    }
                });

                window.addEventListener('mouseup', () => {
                    this.state.isPanning = false;
                    mask.style.cursor = 'grab';
                });
            },

            modifyZoomFactor(direction) {
                const cfg = FLIPOS_GLOBAL_STORE.config;
                let newZoom = FLIPOS_GLOBAL_STORE.runtime.zoomLevel + (direction * cfg.zoomStep);

                // Clamp values
                if (newZoom < cfg.minZoom) newZoom = cfg.minZoom;
                if (newZoom > cfg.maxZoom) newZoom = cfg.maxZoom;

                FLIPOS_GLOBAL_STORE.runtime.zoomLevel = newZoom;
                this.applyTransformation();
            },

            resetTransformationMatrix() {
                FLIPOS_GLOBAL_STORE.runtime.zoomLevel = 1.0;
                this.state.panX = 0;
                this.state.panY = 0;
                this.applyTransformation();
                FlipOS_Interface_Utils.displaySystemToast("Viewport Reset");
            },

            applyTransformation() {
                const target = document.getElementById('visual-transform-matrix');
                const mask = document.getElementById('interaction-pan-mask');
                const display = document.getElementById('display-zoom-metric');
                const currentZoom = FLIPOS_GLOBAL_STORE.runtime.zoomLevel;

                // Update UI Display
                display.innerText = Math.round(currentZoom * 100) + '%';

                // Apply CSS Transform
                target.style.transform = 
                    `translate(${this.state.panX}px, ${this.state.panY}px) scale(${currentZoom})`;

                // Logic: Interaction Mask Visibility
                // If Zoomed IN and in READ mode -> Enable Mask to allow Panning
                if (currentZoom > 1 && FLIPOS_GLOBAL_STORE.runtime.operationalMode === 'MODE_READ') {
                    mask.style.display = 'block';
                    if (FLIPOS_GLOBAL_STORE.runtime.bookInstance) 
                        FLIPOS_GLOBAL_STORE.runtime.bookInstance.update({ useMouseEvents: false });
                } else {
                    mask.style.display = 'none';
                    // Auto-center if reset to 1.0
                    if (currentZoom === 1) {
                        this.state.panX = 0; this.state.panY = 0;
                        target.style.transform = 'scale(1)';
                    }
                    // Re-enable page flipping if in Read mode
                    if (FLIPOS_GLOBAL_STORE.runtime.operationalMode === 'MODE_READ' && FLIPOS_GLOBAL_STORE.runtime.bookInstance) {
                        FLIPOS_GLOBAL_STORE.runtime.bookInstance.update({ useMouseEvents: true });
                    }
                }
            }
        };

        // --- SERVICE: INK SUBSYSTEM (DRAWING ENGINE) ---
        const FlipOS_Ink_Subsystem = {
            runtime: {
                activeInstrument: 'TOOL_PEN',
                activeColor: '#ef4444',
                isDrawing: false,
                currentCanvasContext: null,
                currentCanvasElement: null,
                lastCoordinate: { x: 0, y: 0 },
                historyStack: {} // Key: PageIndex, Value: Array<ImageData>
            },

            attachEventListeners() {
                // Attach to stage area to capture events across multiple canvases (Seamless Drawing)
                const stage = document.getElementById('system-viewport-stage');
                
                stage.addEventListener('pointerdown', (e) => this.handlePointerDown(e));
                window.addEventListener('pointermove', (e) => this.handlePointerMove(e));
                window.addEventListener('pointerup', () => this.handlePointerUp());
            },

            setActiveInstrument(toolID) {
                this.runtime.activeInstrument = toolID;
                
                // UI Refresh
                ['tool-pen', 'tool-marker', 'tool-eraser'].forEach(id => 
                    document.getElementById(id).classList.remove('state-active')
                );
                
                let targetId = 'tool-pen';
                if (toolID === 'TOOL_MARKER') targetId = 'tool-marker';
                if (toolID === 'TOOL_ERASER') targetId = 'tool-eraser';
                
                document.getElementById(targetId).classList.add('state-active');
            },

            setInkColor(hexColor, domElement) {
                this.runtime.activeColor = hexColor;
                this.setActiveInstrument('TOOL_PEN'); // Auto-switch back to pen
                
                // UI Refresh
                document.querySelectorAll('.sys-color-swatch').forEach(el => el.classList.remove('state-active'));
                domElement.classList.add('state-active');
            },

            // --- Vector Calculation Logic ---

            identifyTargetLayer(event) {
                // Raycasting to find element under cursor
                const element = document.elementFromPoint(event.clientX, event.clientY);
                return element && element.classList.contains('layer-type-digital-ink') ? element : null;
            },

            calculateLocalCoordinates(event, canvas) {
                const rect = canvas.getBoundingClientRect();
                // Map screen coordinates to internal canvas resolution
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (event.clientX - rect.left) * scaleX,
                    y: (event.clientY - rect.top) * scaleY
                };
            },

            configureContextAttributes(ctx) {
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                if (this.runtime.activeInstrument === 'TOOL_MARKER') {
                    ctx.globalCompositeOperation = 'multiply';
                    ctx.strokeStyle = this.runtime.activeColor;
                    ctx.lineWidth = 20;
                    ctx.globalAlpha = 0.5;
                } else if (this.runtime.activeInstrument === 'TOOL_ERASER') {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 30;
                    ctx.globalAlpha = 1.0;
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = this.runtime.activeColor;
                    ctx.lineWidth = 3;
                    ctx.globalAlpha = 1.0;
                }
            },

            // --- Event Handlers ---

            handlePointerDown(event) {
                // Security check: Only draw in Studio Mode and when Pan Mask is hidden
                if (FLIPOS_GLOBAL_STORE.runtime.operationalMode !== 'MODE_STUDIO') return;
                if (document.getElementById('interaction-pan-mask').style.display === 'block') return;

                const target = this.identifyTargetLayer(event);
                if (!target) return;

                event.preventDefault();
                this.runtime.isDrawing = true;
                this.runtime.currentCanvasElement = target;
                this.runtime.currentCanvasContext = target.getContext('2d');
                
                this.configureContextAttributes(this.runtime.currentCanvasContext);
                this.runtime.lastCoordinate = this.calculateLocalCoordinates(event, target);
                
                // Draw initial dot (Point)
                const ctx = this.runtime.currentCanvasContext;
                ctx.beginPath();
                ctx.moveTo(this.runtime.lastCoordinate.x, this.runtime.lastCoordinate.y);
                ctx.stroke();
            },

            handlePointerMove(event) {
                if (!this.runtime.isDrawing) return;

                const target = this.identifyTargetLayer(event);
                
                // ALGORITHM: CONTEXT HANDOVER (SEAMLESS DRAWING)
                // Detects if cursor moved to a different page/canvas
                if (target && target !== this.runtime.currentCanvasElement) {
                    // Close path on old canvas
                    this.runtime.currentCanvasContext.closePath();
                    this.pushToHistory(this.runtime.currentCanvasElement); // Autosave history
                    
                    // Switch to new canvas
                    this.runtime.currentCanvasElement = target;
                    this.runtime.currentCanvasContext = target.getContext('2d');
                    this.configureContextAttributes(this.runtime.currentCanvasContext);
                    
                    // Reset coordinates relative to new canvas
                    this.runtime.lastCoordinate = this.calculateLocalCoordinates(event, target);
                    
                    this.runtime.currentCanvasContext.beginPath();
                    this.runtime.currentCanvasContext.moveTo(this.runtime.lastCoordinate.x, this.runtime.lastCoordinate.y);
                }

                if (this.runtime.currentCanvasElement) {
                    const currentPos = this.calculateLocalCoordinates(event, this.runtime.currentCanvasElement);
                    const ctx = this.runtime.currentCanvasContext;

                    // Render Bezier Curve for smoothness
                    const midPoint = {
                        x: (this.runtime.lastCoordinate.x + currentPos.x) / 2,
                        y: (this.runtime.lastCoordinate.y + currentPos.y) / 2
                    };

                    ctx.quadraticCurveTo(this.runtime.lastCoordinate.x, this.runtime.lastCoordinate.y, midPoint.x, midPoint.y);
                    ctx.stroke();
                    
                    this.runtime.lastCoordinate = currentPos;
                }
            },

            handlePointerUp() {
                if (this.runtime.isDrawing) {
                    this.runtime.isDrawing = false;
                    if (this.runtime.currentCanvasContext) {
                        this.runtime.currentCanvasContext.closePath();
                    }
                    if (this.runtime.currentCanvasElement) {
                        this.pushToHistory(this.runtime.currentCanvasElement);
                    }
                }
            },

            // --- History Manager (Undo/Redo) ---

            pushToHistory(canvasElement) {
                const pageIdx = canvasElement.parentElement.dataset.pageIndex;
                if (!this.runtime.historyStack[pageIdx]) this.runtime.historyStack[pageIdx] = [];
                
                const snapshot = this.runtime.currentCanvasContext.getImageData(0, 0, canvasElement.width, canvasElement.height);
                this.runtime.historyStack[pageIdx].push(snapshot);
                
                // Memory Optimization: Limit 15 steps
                if (this.runtime.historyStack[pageIdx].length > 15) this.runtime.historyStack[pageIdx].shift();
            },

            executeUndoSequence() {
                if (!this.runtime.currentCanvasElement) return;
                
                const pageIdx = this.runtime.currentCanvasElement.parentElement.dataset.pageIndex;
                const stack = this.runtime.historyStack[pageIdx];
                
                if (stack && stack.length > 0) {
                    stack.pop(); // Remove current state
                    const previousState = stack[stack.length - 1];
                    const ctx = this.runtime.currentCanvasElement.getContext('2d');
                    
                    if (previousState) {
                        ctx.putImageData(previousState, 0, 0);
                    } else {
                        // If no history left, clear canvas
                        ctx.clearRect(0, 0, this.runtime.currentCanvasElement.width, this.runtime.currentCanvasElement.height);
                    }
                    FlipOS_Interface_Utils.displaySystemToast("Undo Operation Successful");
                }
            },

            executeClearCanvas() {
                if (this.runtime.currentCanvasElement) {
                    const ctx = this.runtime.currentCanvasElement.getContext('2d');
                    ctx.clearRect(0, 0, this.runtime.currentCanvasElement.width, this.runtime.currentCanvasElement.height);
                    this.pushToHistory(this.runtime.currentCanvasElement);
                    FlipOS_Interface_Utils.displaySystemToast("Page Cleared");
                }
            }
        };

        // --- SERVICE: INTERFACE UTILITIES ---
        const FlipOS_Interface_Utils = {
            toggleSystemTheme() {
                const body = document.body;
                const currentTheme = body.getAttribute('data-theme');
                body.setAttribute('data-theme', currentTheme === 'dark' ? 'light' : 'dark');
            },

            triggerFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            },

            displaySystemToast(message) {
                const toast = document.getElementById('system-notification-toast');
                toast.innerText = message;
                toast.classList.add('state-visible');
                
                // Debounce timeout
                if (this.toastTimeout) clearTimeout(this.toastTimeout);
                this.toastTimeout = setTimeout(() => {
                    toast.classList.remove('state-visible');
                }, 2500);
            }
        };

        // --- KERNEL INITIALIZATION ---
        FlipOS_Kernel_System.initializeBootSequence();

    </script>
</body>
</html>
