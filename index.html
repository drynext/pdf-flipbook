<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PDF Flipbook V7 (Ultimate)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. GIAO DIỆN CHÍNH --- */
        :root {
            --bg-color: #222;
            --panel-color: #333;
            --text-color: #fff;
            --accent-color: #e74c3c;
            --btn-border: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* TOOLBAR */
        .toolbar {
            height: 60px;
            background: var(--panel-color);
            border-bottom: 1px solid #444;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000;
        }

        .group { display: flex; align-items: center; gap: 8px; }

        .btn {
            width: 40px; height: 40px;
            border: 1px solid var(--btn-border);
            background: #2a2a2a; color: #eee;
            border-radius: 6px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; transition: 0.2s;
        }
        .btn:hover { background: var(--accent-color); border-color: var(--accent-color); color: #fff; }
        .btn:active { transform: scale(0.95); }
        .btn.active { background: var(--accent-color); box-shadow: 0 0 10px var(--accent-color); }

        .zoom-lbl {
            font-variant-numeric: tabular-nums;
            font-weight: bold; min-width: 55px; text-align: center;
            color: var(--accent-color); font-size: 0.95rem;
        }

        /* STAGE */
        .stage {
            flex: 1; position: relative; overflow: hidden;
            background-image: radial-gradient(#444 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex; justify-content: center; align-items: center;
        }

        .zoom-view {
            transition: transform 0.2s cubic-bezier(0.1, 0.7, 1.0, 0.1);
            transform-origin: center center;
            will-change: transform;
        }

        /* Lớp phủ thông minh (Smart Layer) */
        #smart-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500; display: none; /* Chỉ hiện khi Zoom */
            cursor: grab;
        }
        #smart-layer.grabbing { cursor: grabbing; }
        #smart-layer.crosshair { cursor: crosshair; }

        /* SÁCH */
        .stf__wrapper { box-shadow: 0 20px 50px rgba(0,0,0,0.6); }
        canvas { width: 100%; height: 100%; object-fit: contain; }

        /* KÍNH LÚP (V5 RESTORED) */
        #magnifier {
            position: absolute; width: 250px; height: 250px;
            border: 4px solid #fff; border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; pointer-events: none; z-index: 9999;
            background: #000; overflow: hidden;
        }
        #mag-canvas { display: block; width: 100%; height: 100%; }

        /* UPLOAD */
        #upload-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .upload-card {
            padding: 40px; border: 2px dashed var(--accent-color);
            border-radius: 12px; cursor: pointer; text-align: center;
            color: #ccc; transition: 0.3s;
        }
        .upload-card:hover { background: rgba(231, 76, 60, 0.1); color: #fff; }
        .progress-bar {
            width: 300px; height: 6px; background: #444; margin-top: 20px;
            border-radius: 3px; overflow: hidden; display: none;
        }
        .progress-fill { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.1s; }

    </style>
</head>
<body>

    <div id="upload-modal">
        <div class="upload-card" onclick="document.getElementById('inp-file').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; margin-bottom: 15px;"></i>
            <h3>CHỌN FILE PDF</h3>
            <p>Click hoặc Kéo thả file vào đây</p>
        </div>
        <input type="file" id="inp-file" accept="application/pdf" style="display: none;">
        <div class="progress-bar"><div class="progress-fill" id="prog-fill"></div></div>
        <p id="status-txt" style="margin-top: 10px; display:none; color: #888;">Đang xử lý...</p>
    </div>

    <div class="toolbar">
        <div class="group">
            <b style="color:var(--accent-color); font-size:1.2rem;">PDF V7</b>
        </div>

        <div class="group">
            <button class="btn" id="btn-prev" title="Trang trước"><i class="fas fa-chevron-left"></i></button>
            <span style="min-width: 90px; text-align: center; font-weight: bold;" id="page-txt">0 / 0</span>
            <button class="btn" id="btn-next" title="Trang sau"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="group">
            <button class="btn" id="btn-loupe" title="Kính lúp" onclick="Tools.toggleLoupe()"><i class="fas fa-search"></i></button>
            
            <div style="width:1px; height:25px; background:#444; margin:0 5px;"></div>
            
            <button class="btn" onclick="Tools.zoomOut()"><i class="fas fa-minus"></i></button>
            <span class="zoom-lbl" id="zoom-txt">100%</span>
            <button class="btn" onclick="Tools.zoomIn()"><i class="fas fa-plus"></i></button>
            
            <div style="width:1px; height:25px; background:#444; margin:0 5px;"></div>
            
            <button class="btn" onclick="Tools.toggleSound()" id="btn-sound"><i class="fas fa-volume-up"></i></button>
            <button class="btn" onclick="Tools.toggleFullscreen()"><i class="fas fa-expand"></i></button>
        </div>
    </div>

    <div class="stage">
        <div class="zoom-view" id="zoom-view">
            <div id="book"></div>
        </div>
        
        <div id="smart-layer"></div>

        <div id="magnifier"><canvas id="mag-canvas"></canvas></div>
    </div>

    <audio id="snd" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let pdfDoc = null;
        let pageFlip = null;
        let isSound = true;
        
        // DOM Elements
        const el = {
            book: document.getElementById('book'),
            zoomView: document.getElementById('zoom-view'),
            smartLayer: document.getElementById('smart-layer'),
            magCanvas: document.getElementById('mag-canvas'),
            magnifier: document.getElementById('magnifier'),
            uploadModal: document.getElementById('upload-modal'),
            magCtx: document.getElementById('mag-canvas').getContext('2d')
        };
        
        // Cấu hình Canvas Kính lúp
        el.magCanvas.width = 500; el.magCanvas.height = 500;

        // --- 1. CORE TOOLS ---
        const Tools = {
            // Các mức Zoom chuẩn
            levels: [0.25, 0.5, 0.75, 1.0, 1.5, 2.0],
            zoomIdx: 3, // Bắt đầu ở 1.0
            panX: 0, panY: 0,
            
            // Biến xử lý Kéo/Click
            isDragging: false,
            startX: 0, startY: 0,
            isLoupe: false,

            init() {
                this.updateTransform();
                // Sự kiện Smart Layer
                el.smartLayer.addEventListener('mousedown', e => this.onDown(e));
                window.addEventListener('mousemove', e => this.onMove(e));
                window.addEventListener('mouseup', e => this.onUp(e));
            },

            // --- ZOOM LOGIC ---
            zoomIn() {
                if(this.zoomIdx < this.levels.length-1) {
                    this.zoomIdx++; this.updateTransform();
                }
            },
            zoomOut() {
                if(this.zoomIdx > 0) {
                    this.zoomIdx--; this.updateTransform();
                }
            },
            updateTransform() {
                const scale = this.levels[this.zoomIdx];
                document.getElementById('zoom-txt').innerText = (scale * 100) + '%';
                el.zoomView.style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${scale})`;

                // LOGIC THÔNG MINH:
                // Nếu Scale > 1 hoặc đang bật Kính lúp -> Hiện Smart Layer để xử lý
                if(scale > 1 || this.isLoupe) {
                    el.smartLayer.style.display = 'block';
                    // Reset vị trí pan nếu về 100% (chỉ khi không bật kính lúp)
                } else {
                    el.smartLayer.style.display = 'none';
                    this.panX = 0; this.panY = 0;
                    el.zoomView.style.transform = `translate(0,0) scale(1)`;
                }
                
                // Cập nhật con trỏ chuột
                if(this.isLoupe) el.smartLayer.className = 'crosshair';
                else el.smartLayer.className = '';
            },

            // --- SMART TOUCH (KÉO & LẬT) ---
            onDown(e) {
                this.isDragging = false; // Reset cờ kéo
                this.startX = e.clientX - this.panX;
                this.startY = e.clientY - this.panY;
                this.mouseDownPos = { x: e.clientX, y: e.clientY }; // Lưu vị trí click xuống
                
                if(!this.isLoupe) el.smartLayer.style.cursor = 'grabbing';
            },

            onMove(e) {
                // 1. Xử lý Kính lúp
                if(this.isLoupe) {
                    this.renderMagnifier(e);
                    return; 
                }

                // 2. Xử lý Kéo (Pan)
                // Chỉ kéo khi chuột nhấn và di chuyển
                if(e.buttons === 1) { // 1 là chuột trái
                    const dx = Math.abs(e.clientX - this.mouseDownPos.x);
                    const dy = Math.abs(e.clientY - this.mouseDownPos.y);
                    
                    // Nếu di chuyển quá 5px thì mới tính là ĐANG KÉO (Dragging)
                    if(dx > 5 || dy > 5) {
                        this.isDragging = true;
                        e.preventDefault();
                        this.panX = e.clientX - this.startX;
                        this.panY = e.clientY - this.startY;
                        this.updateTransform();
                    }
                }
            },

            onUp(e) {
                if(!this.isLoupe) el.smartLayer.style.cursor = 'grab';

                // NẾU KHÔNG PHẢI LÀ KÉO (Tức là Click) -> THÌ LẬT TRANG
                if(!this.isDragging && !this.isLoupe && pageFlip) {
                    const width = window.innerWidth;
                    // Click bên trái -> Prev
                    if(e.clientX < width / 2) pageFlip.flipPrev();
                    // Click bên phải -> Next
                    else pageFlip.flipNext();
                }
                this.isDragging = false;
            },

            // --- KÍNH LÚP (V5 Engine) ---
            toggleLoupe() {
                this.isLoupe = !this.isLoupe;
                const btn = document.getElementById('btn-loupe');
                
                if(this.isLoupe) {
                    btn.classList.add('active');
                    el.magnifier.style.display = 'block';
                    // Bật SmartLayer để bắt sự kiện chuột
                    el.smartLayer.style.display = 'block';
                    this.updateTransform(); // Cập nhật cursor
                } else {
                    btn.classList.remove('active');
                    el.magnifier.style.display = 'none';
                    this.updateTransform(); // Tắt SmartLayer nếu đang ở zoom 100%
                }
            },

            renderMagnifier(e) {
                // Di chuyển kính
                const m = el.magnifier;
                m.style.left = (e.clientX + 20) + 'px';
                m.style.top = (e.clientY + 20) + 'px';

                // Ẩn kính tạm thời để soi phần tử bên dưới
                m.style.display = 'none';
                const elem = document.elementFromPoint(e.clientX, e.clientY);
                m.style.display = 'block';

                if(elem && elem.tagName === 'CANVAS') {
                    const rect = elem.getBoundingClientRect();
                    const ratioX = elem.width / rect.width;
                    const ratioY = elem.height / rect.height;
                    
                    const x = (e.clientX - rect.left) * ratioX;
                    const y = (e.clientY - rect.top) * ratioY;

                    // Vẽ lại vào kính lúp (Zoom 5x)
                    el.magCtx.fillStyle = '#fff';
                    el.magCtx.fillRect(0,0,500,500);
                    
                    // Cắt ảnh từ canvas gốc
                    try {
                        el.magCtx.drawImage(elem, 
                            x - 50, y - 50, 100, 100, // Lấy vùng 100x100
                            0, 0, 500, 500 // Vẽ phóng to ra 500x500
                        );
                    } catch(err){}
                }
            },

            // --- TIỆN ÍCH KHÁC ---
            toggleSound() {
                isSound = !isSound;
                const btn = document.getElementById('btn-sound');
                btn.innerHTML = isSound ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
                btn.style.opacity = isSound ? 1 : 0.5;
            },
            toggleFullscreen() {
                if(!document.fullscreenElement) document.documentElement.requestFullscreen();
                else if(document.exitFullscreen) document.exitFullscreen();
            }
        };

        Tools.init();

        // --- 2. UPLOAD & RENDER PDF ---
        document.getElementById('inp-file').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            document.querySelector('.upload-card').style.display = 'none';
            document.querySelector('.progress-bar').style.display = 'block';
            document.getElementById('status-txt').style.display = 'block';

            // Mồi âm thanh
            document.getElementById('snd').play().catch(()=>{}); 
            document.getElementById('snd').pause();

            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async (ev) => {
                const data = new Uint8Array(ev.target.result);
                pdfDoc = await pdfjsLib.getDocument(data).promise;
                document.getElementById('page-txt').innerText = `1 / ${pdfDoc.numPages}`;
                
                await renderBook();
            };
        });

        async function renderBook() {
            el.book.innerHTML = '';
            const total = pdfDoc.numPages;

            for(let i=1; i<=total; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 });
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { alpha: false });
                canvas.width = viewport.width; canvas.height = viewport.height;
                canvas.className = 'pg';
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                el.book.appendChild(canvas);

                const pct = (i/total)*100;
                document.getElementById('prog-fill').style.width = pct + '%';
                document.getElementById('status-txt').innerText = `Đang xử lý ${i}/${total}`;
            }

            el.uploadModal.style.display = 'none';
            initFlip();
        }

        function initFlip() {
            const isMobile = window.innerWidth < 768;
            pageFlip = new St.PageFlip(el.book, {
                width: isMobile ? 350 : 550, height: isMobile ? 500 : 750,
                size: "stretch", showCover: true, usePortrait: isMobile,
                minWidth: 300, maxWidth: 1000, minHeight: 400, maxHeight: 1200,
                // QUAN TRỌNG: Tắt chuột của thư viện để dùng Smart Layer của mình
                useMouseEvents: false 
            });

            pageFlip.loadFromHTML(document.querySelectorAll('.pg'));

            pageFlip.on('flip', (e) => {
                document.getElementById('page-txt').innerText = `${e.data+1} / ${pdfDoc.numPages}`;
                if(isSound) {
                    const aud = document.getElementById('snd');
                    aud.currentTime=0; aud.play().catch(()=>{});
                }
            });
        }

        // --- 3. ĐIỀU HƯỚNG ---
        document.getElementById('btn-prev').onclick = () => pageFlip && pageFlip.flipPrev();
        document.getElementById('btn-next').onclick = () => pageFlip && pageFlip.flipNext();
        
        document.addEventListener('keydown', (e) => {
            if(el.uploadModal.style.display !== 'none') return;
            if(e.key === 'ArrowLeft') pageFlip.flipPrev();
            if(e.key === 'ArrowRight') pageFlip.flipNext();
            if(e.key === '+' || e.key === '=') Tools.zoomIn();
            if(e.key === '-') Tools.zoomOut();
        });

    </script>
</body>
</html>
