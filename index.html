<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FlipOS Enterprise Edition - Advanced PDF Rendering Engine">
    <meta name="author" content="Dang Duc Dai">
    <title>FlipOS V20 | Enterprise Architect Edition</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* * ==========================================================================
         * SECTION 1: CORE VARIABLES & RESET
         * Description: Defining system-wide design tokens for consistency.
         * ==========================================================================
         */
        :root {
            /* Palette: Deep Space Theme */
            --sys-color-bg-primary: #050505;
            --sys-color-bg-secondary: #121212;
            --sys-color-panel-glass: rgba(20, 20, 25, 0.85);
            --sys-color-border: rgba(255, 255, 255, 0.08);
            --sys-color-text-primary: #e0e0e0;
            --sys-color-text-secondary: #a0a0a0;
            
            /* Accent Colors */
            --sys-color-accent: #6366f1; /* Indigo */
            --sys-color-accent-hover: #4f46e5;
            --sys-color-danger: #ef4444;
            --sys-color-success: #22c55e;

            /* Metrics */
            --sys-spacing-unit: 8px;
            --sys-border-radius-sm: 8px;
            --sys-border-radius-md: 16px;
            --sys-border-radius-lg: 24px;
            
            /* Effects */
            --sys-shadow-elevation-low: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --sys-shadow-elevation-high: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            --sys-blur-intensity: blur(20px);
            --sys-transition-fast: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Light Theme Override */
        [data-theme="light"] {
            --sys-color-bg-primary: #f8fafc;
            --sys-color-bg-secondary: #ffffff;
            --sys-color-panel-glass: rgba(255, 255, 255, 0.85);
            --sys-color-border: rgba(0, 0, 0, 0.08);
            --sys-color-text-primary: #1e293b;
            --sys-color-text-secondary: #64748b;
            --sys-color-accent: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-font-smoothing: antialiased; }
        
        body {
            background-color: var(--sys-color-bg-primary);
            color: var(--sys-color-text-primary);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* Critical: Prevent scrollbars on body */
            position: relative;
        }

        /* * ==========================================================================
         * SECTION 2: Z-INDEX ARCHITECTURE (The Fix for Overlapping)
         * Level 0: Background / World
         * Level 10: Canvas Content
         * Level 100: Pan Overlay
         * Level 1000: UI Layer (Fixed, Untouchable by Zoom)
         * Level 9999: Modals / Popups
         * ==========================================================================
         */

        /* The container for the PDF book. This is what gets Scaled/Zoomed */
        #world-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Grid background for professional look */
            background-image: 
                linear-gradient(var(--sys-color-border) 1px, transparent 1px),
                linear-gradient(90deg, var(--sys-color-border) 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center center;
            overflow: hidden;
        }

        #world-transform-target {
            transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: center center;
            will-change: transform;
        }

        /* The UI Layer. Position Fixed ensures it NEVER zooms */
        #hud-layer {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1000;
            pointer-events: none; /* Let clicks pass through empty spaces */
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* * ==========================================================================
         * SECTION 3: COMPONENT STYLING (The "Classy" Look)
         * ==========================================================================
         */

        .ui-panel {
            pointer-events: auto; /* Re-enable clicks for buttons */
            background: var(--sys-color-panel-glass);
            backdrop-filter: var(--sys-blur-intensity);
            border: 1px solid var(--sys-color-border);
            border-radius: var(--sys-border-radius-lg);
            box-shadow: var(--sys-shadow-elevation-high);
            padding: 12px;
            display: flex;
            gap: 12px;
            align-items: center;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* Top Bar Configuration */
        .panel-top {
            align-self: center;
            border-radius: 50px;
            padding: 8px 24px;
        }

        /* Side Bars Configuration */
        .panel-side-left {
            position: absolute; top: 50%; left: 24px;
            transform: translateY(-50%);
            flex-direction: column;
        }

        .panel-side-right {
            position: absolute; top: 50%; right: 24px;
            transform: translateY(-50%);
            flex-direction: column;
        }

        /* Bottom Bar Configuration */
        .panel-bottom {
            align-self: center;
            margin-bottom: 10px;
            border-radius: 20px;
        }

        /* Button Styling - Neo-brutalism Soft */
        .btn-control {
            width: 44px; height: 44px;
            border: 1px solid transparent;
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            color: var(--sys-color-text-primary);
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.1rem;
            transition: var(--sys-transition-fast);
        }
        .btn-control:hover {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
            color: #fff;
        }
        .btn-control.active {
            background: var(--sys-color-accent);
            color: white;
            box-shadow: 0 0 15px var(--sys-color-accent);
            border-color: rgba(255,255,255,0.2);
        }

        .btn-text-mode {
            padding: 0 20px; height: 40px;
            border-radius: 20px;
            font-weight: 700; font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            display: flex; align-items: center;
            background: transparent; color: var(--sys-color-text-secondary);
            border: 1px solid transparent; cursor: pointer;
            transition: var(--sys-transition-fast);
        }
        .btn-text-mode.active {
            background: var(--sys-color-accent);
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Dividers */
        .ui-divider-h { width: 1px; height: 24px; background: var(--sys-color-border); margin: 0 4px; }
        .ui-divider-v { width: 24px; height: 1px; background: var(--sys-color-border); margin: 4px 0; }

        /* Color Picker Dots */
        .color-swatch {
            width: 32px; height: 32px; border-radius: 50%;
            border: 2px solid var(--sys-color-border);
            cursor: pointer; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .color-swatch.active {
            transform: scale(1.25);
            border-color: #fff;
            box-shadow: 0 0 10px currentColor;
        }

        /* * ==========================================================================
         * SECTION 4: INTERACTIVE ELEMENTS (Upload, Toast, Lens)
         * ==========================================================================
         */
        #upload-overlay-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 5, 5, 0.95);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
        }
        .upload-card {
            background: #1a1a1a;
            border: 1px solid #333;
            padding: 60px;
            border-radius: 32px;
            text-align: center;
            cursor: pointer;
            transition: 0.4s;
            max-width: 500px;
        }
        .upload-card:hover {
            border-color: var(--sys-color-accent);
            transform: scale(1.02);
            box-shadow: 0 0 50px rgba(99, 102, 241, 0.2);
        }

        /* Spyglass (Magnifier) */
        .tool-spyglass-lens {
            position: absolute; width: 250px; height: 250px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            overflow: hidden; pointer-events: none; z-index: 5000;
            display: none; background: #fff;
        }

        /* Pan Overlay (Invisible layer for dragging) */
        #interaction-mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            z-index: 200; display: none; cursor: grab;
        }
        #interaction-mask.grabbing { cursor: grabbing; }

        /* Canvas Layers */
        .page-container { position: relative; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); overflow: hidden; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .layer-pdf { z-index: 1; }
        .layer-ink { z-index: 5; cursor: crosshair; touch-action: none; }

    </style>
</head>
<body data-theme="dark">

    <div id="upload-overlay-container">
        <div class="upload-card" onclick="document.getElementById('sys-file-input').click()">
            <i class="fas fa-microchip" style="font-size: 4rem; color: var(--sys-color-accent); margin-bottom: 24px;"></i>
            <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 10px;">FLIP OS V20</h1>
            <p style="color: var(--sys-color-text-secondary); font-family: 'JetBrains Mono';">Enterprise Architect Edition</p>
            <div style="margin-top: 20px; padding: 10px 20px; background: #333; border-radius: 8px; font-size: 0.8rem; color: #888;">
                CLICK TO INITIALIZE CORE
            </div>
        </div>
        <input type="file" id="sys-file-input" hidden accept="application/pdf">
    </div>

    <div id="hud-layer">
        
        <div class="ui-panel panel-top">
            <button class="btn-text-mode active" id="mode-read" onclick="FlipOS_Kernel.setOperationMode('READ')">
                <i class="fas fa-book-reader" style="margin-right: 8px;"></i> READER
            </button>
            <div class="ui-divider-h"></div>
            <button class="btn-text-mode" id="mode-draw" onclick="FlipOS_Kernel.setOperationMode('DRAW')">
                <i class="fas fa-pencil-alt" style="margin-right: 8px;"></i> STUDIO
            </button>
            <div class="ui-divider-h"></div>
            <button class="btn-control" onclick="FlipOS_UI.toggleTheme()" title="Toggle Theme">
                <i class="fas fa-adjust"></i>
            </button>
        </div>

        <div class="ui-panel panel-side-left" id="panel-tools">
            <button class="btn-control active" id="tool-pen" onclick="FlipOS_InkEngine.selectTool('pen')"><i class="fas fa-pen"></i></button>
            <button class="btn-control" id="tool-marker" onclick="FlipOS_InkEngine.selectTool('marker')"><i class="fas fa-highlighter"></i></button>
            <button class="btn-control" id="tool-eraser" onclick="FlipOS_InkEngine.selectTool('eraser')"><i class="fas fa-eraser"></i></button>
            
            <div class="ui-divider-v"></div>
            
            <div class="color-swatch active" style="background:#ff4757" onclick="FlipOS_InkEngine.setColor('#ff4757', this)"></div>
            <div class="color-swatch" style="background:#2ed573" onclick="FlipOS_InkEngine.setColor('#2ed573', this)"></div>
            <div class="color-swatch" style="background:#2f3542" style="border-color:#555" onclick="FlipOS_InkEngine.setColor('#2f3542', this)"></div>
            
            <div class="ui-divider-v"></div>
            
            <button class="btn-control" onclick="FlipOS_InkEngine.undoAction()"><i class="fas fa-undo"></i></button>
            <button class="btn-control" onclick="FlipOS_InkEngine.clearPage()"><i class="fas fa-trash"></i></button>
        </div>

        <div class="ui-panel panel-side-right">
            <button class="btn-control" onclick="FlipOS_Viewport.executeZoom(1)" title="Zoom In"><i class="fas fa-plus"></i></button>
            <span id="ui-zoom-display" style="font-family:'JetBrains Mono'; font-size:0.8rem; font-weight:bold; color:var(--sys-color-accent)">100%</span>
            <button class="btn-control" onclick="FlipOS_Viewport.executeZoom(-1)" title="Zoom Out"><i class="fas fa-minus"></i></button>
            
            <div class="ui-divider-v"></div>
            
            <button class="btn-control" onclick="FlipOS_Viewport.resetViewport()" title="Reset View"><i class="fas fa-compress"></i></button>
            <button class="btn-control" id="btn-spyglass" onclick="FlipOS_Lens.toggleState()"><i class="fas fa-search"></i></button>
            <button class="btn-control" onclick="FlipOS_UI.toggleFullscreen()"><i class="fas fa-expand"></i></button>
        </div>

        <div class="ui-panel panel-bottom">
            <button class="btn-control" onclick="FlipOS_BookEngine.navigate('PREV')"><i class="fas fa-chevron-left"></i></button>
            <span id="ui-page-display" style="min-width: 80px; text-align: center; font-weight: 700; font-variant-numeric: tabular-nums;">-- / --</span>
            <button class="btn-control" onclick="FlipOS_BookEngine.navigate('NEXT')"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <div id="world-layer" ondblclick="FlipOS_Viewport.resetViewport()">
        <div id="world-transform-target">
            <div id="book-container"></div>
        </div>
        
        <div id="interaction-mask"></div>
        
        <div class="tool-spyglass-lens" id="spyglass-component">
            <canvas id="spyglass-canvas"></canvas>
        </div>
    </div>

    <audio id="sfx-page-flip" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        /**
         * ==========================================================================
         * FLIP OS KERNEL V20 - ENTERPRISE EDITION
         * Architecture: Monolithic State Management with Modular Services
         * Author: Dang Duc Dai
         * ==========================================================================
         */

        // Configure PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        // --- GLOBAL STATE REGISTRY ---
        const FlipOS_State = {
            pdfDocument: null,
            bookInstance: null,
            currentMode: 'READ', // Enum: 'READ' | 'DRAW'
            zoomLevel: 1.0,
            totalPages: 0,
            currentPage: 0
        };

        // --- SERVICE: KERNEL CONTROLLER ---
        const FlipOS_Kernel = {
            /**
             * Initialize the application event listeners and layout
             */
            initializeSystem() {
                console.log("[FlipOS] System Boot Sequence Initiated...");
                document.getElementById('sys-file-input').addEventListener('change', this.handleFileUpload);
                
                // Global Keyboard Shortcuts
                window.addEventListener('keydown', (e) => {
                    if(e.key === 'ArrowLeft') FlipOS_BookEngine.navigate('PREV');
                    if(e.key === 'ArrowRight') FlipOS_BookEngine.navigate('NEXT');
                    if(e.ctrlKey && e.key === 'z') FlipOS_InkEngine.undoAction();
                    if(e.key === '+' || e.key === '=') FlipOS_Viewport.executeZoom(1);
                    if(e.key === '-') FlipOS_Viewport.executeZoom(-1);
                });
            },

            /**
             * Handle PDF file upload and parsing
             */
            async handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                document.querySelector('.upload-card').innerHTML = '<i class="fas fa-circle-notch fa-spin" style="font-size:3rem;"></i><br><br>PROCESSING DATA STREAM...';
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    FlipOS_State.pdfDocument = await pdfjsLib.getDocument(arrayBuffer).promise;
                    FlipOS_State.totalPages = FlipOS_State.pdfDocument.numPages;
                    await FlipOS_RenderEngine.generatePages();
                } catch (error) {
                    console.error("[FlipOS] Critical Error:", error);
                    alert("System Failure: Corrupted PDF Data");
                }
            },

            /**
             * Switch between Reading and Studio modes
             */
            setOperationMode(mode) {
                FlipOS_State.currentMode = mode;
                
                // UI State Updates
                document.getElementById('mode-read').classList.toggle('active', mode === 'READ');
                document.getElementById('mode-draw').classList.toggle('active', mode === 'DRAW');
                
                // Layout Logic
                const mask = document.getElementById('interaction-mask');
                
                if (mode === 'READ') {
                    // Enable book flipping
                    if (FlipOS_State.bookInstance) FlipOS_State.bookInstance.update({ useMouseEvents: true });
                    // If zoomed in, enable drag mask
                    if (FlipOS_State.zoomLevel > 1) mask.style.display = 'block';
                } else {
                    // Disable book flipping to allow drawing
                    if (FlipOS_State.bookInstance) FlipOS_State.bookInstance.update({ useMouseEvents: false });
                    // Disable drag mask to allow drawing on canvas
                    mask.style.display = 'none';
                }
            }
        };

        // --- SERVICE: RENDER ENGINE (PDF & CANVAS) ---
        const FlipOS_RenderEngine = {
            async generatePages() {
                const bookContainer = document.getElementById('book-container');
                bookContainer.innerHTML = ''; // Clear previous

                for (let i = 1; i <= FlipOS_State.totalPages; i++) {
                    const pdfPage = await FlipOS_State.pdfDocument.getPage(i);
                    const viewport = pdfPage.getViewport({ scale: 1.5 }); // High-DPI Rendering
                    
                    // Create Page Wrapper
                    const pageWrap = document.createElement('div');
                    pageWrap.className = 'page-container';
                    pageWrap.dataset.pageIndex = i;

                    // 1. PDF Raster Layer
                    const pdfCanvas = document.createElement('canvas');
                    pdfCanvas.className = 'layer-pdf';
                    pdfCanvas.width = viewport.width;
                    pdfCanvas.height = viewport.height;
                    const pdfCtx = pdfCanvas.getContext('2d', { alpha: false });
                    
                    await pdfPage.render({ canvasContext: pdfCtx, viewport: viewport }).promise;

                    // 2. Ink Vector Layer
                    const inkCanvas = document.createElement('canvas');
                    inkCanvas.className = 'layer-ink';
                    inkCanvas.width = viewport.width;
                    inkCanvas.height = viewport.height;

                    // Assembly
                    pageWrap.appendChild(pdfCanvas);
                    pageWrap.appendChild(inkCanvas);
                    bookContainer.appendChild(pageWrap);
                }

                // Transition to Main UI
                document.getElementById('upload-overlay-container').style.display = 'none';
                FlipOS_BookEngine.initializeBook();
                FlipOS_InkEngine.initializeListeners();
                FlipOS_Viewport.initializePanSystem();
            }
        };

        // --- SERVICE: BOOK ENGINE (PAGE FLIP) ---
        const FlipOS_BookEngine = {
            initializeBook() {
                const stageWidth = document.getElementById('world-layer').clientWidth;
                // Responsive calculation
                const width = stageWidth < 800 ? 400 : 550;
                const height = stageWidth < 800 ? 600 : 800;

                FlipOS_State.bookInstance = new St.PageFlip(document.getElementById('book-container'), {
                    width: width,
                    height: height,
                    size: 'stretch',
                    minWidth: 300,
                    maxWidth: 1000,
                    minHeight: 400,
                    maxHeight: 1200,
                    showCover: true,
                    maxShadowOpacity: 0.5,
                    useMouseEvents: true // Enabled by default
                });

                FlipOS_State.bookInstance.loadFromHTML(document.querySelectorAll('.page-container'));

                // Event Subscription
                FlipOS_State.bookInstance.on('flip', (e) => {
                    FlipOS_State.currentPage = e.data + 1;
                    document.getElementById('ui-page-display').innerText = 
                        `${FlipOS_State.currentPage} / ${FlipOS_State.totalPages}`;
                    
                    // Audio Feedback
                    const audio = document.getElementById('sfx-page-flip');
                    audio.currentTime = 0;
                    audio.play().catch(() => {});
                });
            },

            navigate(direction) {
                if (!FlipOS_State.bookInstance) return;
                if (direction === 'PREV') FlipOS_State.bookInstance.flipPrev();
                if (direction === 'NEXT') FlipOS_State.bookInstance.flipNext();
            }
        };

        // --- SERVICE: VIEWPORT MANAGER (ZOOM & PAN) ---
        const FlipOS_Viewport = {
            panX: 0, panY: 0,
            isDragging: false,
            startX: 0, startY: 0,

            initializePanSystem() {
                const mask = document.getElementById('interaction-mask');
                
                mask.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    this.startX = e.clientX - this.panX;
                    this.startY = e.clientY - this.panY;
                    mask.classList.add('grabbing');
                });

                window.addEventListener('mousemove', (e) => {
                    if (this.isDragging) {
                        e.preventDefault();
                        this.panX = e.clientX - this.startX;
                        this.panY = e.clientY - this.startY;
                        this.applyTransform();
                    }
                    if (FlipOS_Lens.isActive) FlipOS_Lens.render(e);
                });

                window.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    mask.classList.remove('grabbing');
                });
            },

            executeZoom(direction) {
                const step = 0.5;
                let newZoom = FlipOS_State.zoomLevel + (direction * step);
                
                // Constraints
                if (newZoom < 1) newZoom = 1;
                if (newZoom > 4) newZoom = 4;
                
                FlipOS_State.zoomLevel = newZoom;
                this.applyTransform();
            },

            resetViewport() {
                FlipOS_State.zoomLevel = 1.0;
                this.panX = 0;
                this.panY = 0;
                this.applyTransform();
            },

            applyTransform() {
                const target = document.getElementById('world-transform-target');
                const mask = document.getElementById('interaction-mask');
                const display = document.getElementById('ui-zoom-display');

                // Update Display
                display.innerText = Math.round(FlipOS_State.zoomLevel * 100) + '%';

                // Apply CSS Transform (Hardware Accelerated)
                target.style.transform = 
                    `translate(${this.panX}px, ${this.panY}px) scale(${FlipOS_State.zoomLevel})`;

                // Interaction Logic
                if (FlipOS_State.zoomLevel > 1 && FlipOS_State.currentMode === 'READ') {
                    mask.style.display = 'block'; // Enable panning
                    if (FlipOS_State.bookInstance) FlipOS_State.bookInstance.update({ useMouseEvents: false });
                } else {
                    mask.style.display = 'none'; // Disable panning
                    // Auto-center if reset
                    if (FlipOS_State.zoomLevel === 1) {
                        this.panX = 0; this.panY = 0;
                        target.style.transform = 'scale(1)';
                    }
                    if (FlipOS_State.currentMode === 'READ' && FlipOS_State.bookInstance) {
                        FlipOS_State.bookInstance.update({ useMouseEvents: true });
                    }
                }
            }
        };

        // --- SERVICE: INK ENGINE (DRAWING) ---
        const FlipOS_InkEngine = {
            activeTool: 'pen',
            activeColor: '#ff4757',
            isDrawing: false,
            currentCanvas: null,
            ctx: null,
            lastPos: { x: 0, y: 0 },
            historyBuffer: {}, // Stores Undo states per page

            initializeListeners() {
                const world = document.getElementById('world-layer');
                // Use pointer events for universal input (Mouse/Touch/Pen)
                world.addEventListener('pointerdown', (e) => this.onPointerDown(e));
                window.addEventListener('pointermove', (e) => this.onPointerMove(e));
                window.addEventListener('pointerup', () => this.onPointerUp());
            },

            selectTool(toolName) {
                this.activeTool = toolName;
                
                // UI Updates
                const buttons = ['tool-pen', 'tool-marker', 'tool-eraser'];
                buttons.forEach(id => document.getElementById(id).classList.remove('active'));
                
                const targetId = toolName === 'marker' ? 'tool-marker' : 
                                 toolName === 'eraser' ? 'tool-eraser' : 'tool-pen';
                document.getElementById(targetId).classList.add('active');
            },

            setColor(hexColor, element) {
                this.activeColor = hexColor;
                this.selectTool('pen'); // Auto-switch to pen
                
                // UI Updates
                document.querySelectorAll('.color-swatch').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            },

            // --- Drawing Logic ---

            getTargetLayer(e) {
                // Use elementFromPoint to find the ink-layer canvas under cursor
                const el = document.elementFromPoint(e.clientX, e.clientY);
                return el && el.classList.contains('layer-ink') ? el : null;
            },

            getCanvasCoordinates(e, canvas) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            },

            setupContext(ctx) {
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                
                if (this.activeTool === 'marker') {
                    ctx.globalCompositeOperation = 'multiply';
                    ctx.strokeStyle = this.activeColor;
                    ctx.lineWidth = 20;
                    ctx.globalAlpha = 0.5;
                } else if (this.activeTool === 'eraser') {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 30;
                    ctx.globalAlpha = 1.0;
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = this.activeColor;
                    ctx.lineWidth = 3;
                    ctx.globalAlpha = 1.0;
                }
            },

            onPointerDown(e) {
                // Ignore if in READ mode or Panning
                if (FlipOS_State.currentMode !== 'DRAW' || 
                    document.getElementById('interaction-mask').style.display === 'block') return;

                const target = this.getTargetLayer(e);
                if (!target) return;

                e.preventDefault(); // Prevent scroll
                this.isDrawing = true;
                this.currentCanvas = target;
                this.ctx = target.getContext('2d');
                
                this.setupContext(this.ctx);
                this.lastPos = this.getCanvasCoordinates(e, target);
                
                // Initial Dot
                this.ctx.beginPath();
                this.ctx.moveTo(this.lastPos.x, this.lastPos.y);
                this.ctx.stroke();

                // Save state for Undo *before* drawing starts? 
                // Usually better to save on MouseUp for performance
            },

            onPointerMove(e) {
                if (!this.isDrawing) return;

                const target = this.getTargetLayer(e);
                
                // Seamless Jumping Logic (Cross-page drawing)
                if (target && target !== this.currentCanvas) {
                    this.ctx.closePath();
                    this.saveHistory(this.currentCanvas); // Save prev page
                    
                    this.currentCanvas = target;
                    this.ctx = target.getContext('2d');
                    this.setupContext(this.ctx);
                    this.lastPos = this.getCanvasCoordinates(e, target);
                    
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.lastPos.x, this.lastPos.y);
                }

                if (this.currentCanvas) {
                    const currentPos = this.getCanvasCoordinates(e, this.currentCanvas);
                    
                    // Quadratic Curve for smoothness
                    const midPoint = {
                        x: (this.lastPos.x + currentPos.x) / 2,
                        y: (this.lastPos.y + currentPos.y) / 2
                    };

                    this.ctx.quadraticCurveTo(this.lastPos.x, this.lastPos.y, midPoint.x, midPoint.y);
                    this.ctx.stroke();
                    
                    this.lastPos = currentPos;
                }
            },

            onPointerUp() {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    if (this.ctx) this.ctx.closePath();
                    if (this.currentCanvas) this.saveHistory(this.currentCanvas);
                }
            },

            // --- History System (Undo) ---

            saveHistory(canvas) {
                const pageId = canvas.parentElement.dataset.pageIndex;
                if (!this.historyBuffer[pageId]) this.historyBuffer[pageId] = [];
                
                // Save image data
                const snap = this.ctx.getImageData(0, 0, canvas.width, canvas.height);
                this.historyBuffer[pageId].push(snap);
                
                // Cap history limit
                if (this.historyBuffer[pageId].length > 15) this.historyBuffer[pageId].shift();
            },

            undoAction() {
                if (!this.currentCanvas) return;
                const pageId = this.currentCanvas.parentElement.dataset.pageIndex;
                const stack = this.historyBuffer[pageId];
                
                if (stack && stack.length > 0) {
                    stack.pop(); // Remove current state
                    const prevState = stack[stack.length - 1];
                    const ctx = this.currentCanvas.getContext('2d');
                    
                    if (prevState) {
                        ctx.putImageData(prevState, 0, 0);
                    } else {
                        ctx.clearRect(0, 0, this.currentCanvas.width, this.currentCanvas.height);
                    }
                }
            },

            clearPage() {
                if (this.currentCanvas) {
                    const ctx = this.currentCanvas.getContext('2d');
                    ctx.clearRect(0, 0, this.currentCanvas.width, this.currentCanvas.height);
                    this.saveHistory(this.currentCanvas);
                }
            }
        };

        // --- SERVICE: LENS ENGINE (SPYGLASS) ---
        const FlipOS_Lens = {
            isActive: false,
            
            toggleState() {
                this.isActive = !this.isActive;
                const btn = document.getElementById('btn-spyglass');
                const lens = document.getElementById('spyglass-component');
                
                if (this.isActive) {
                    btn.classList.add('active');
                    lens.style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    lens.style.display = 'none';
                }
            },

            render(e) {
                const lens = document.getElementById('spyglass-component');
                const lensCtx = document.getElementById('spyglass-canvas').getContext('2d');
                const size = 500; // Resolution of lens
                document.getElementById('spyglass-canvas').width = size;
                document.getElementById('spyglass-canvas').height = size;

                // Move Lens
                lens.style.left = (e.clientX + 25) + 'px';
                lens.style.top = (e.clientY + 25) + 'px';

                // Temporarily hide lens to find element underneath
                lens.style.display = 'none';
                const elementBelow = document.elementFromPoint(e.clientX, e.clientY);
                lens.style.display = 'block';

                const pageWrapper = elementBelow?.closest('.page-container');
                
                if (pageWrapper) {
                    const pdfCanvas = pageWrapper.querySelector('.layer-pdf');
                    const inkCanvas = pageWrapper.querySelector('.layer-ink');
                    const rect = pdfCanvas.getBoundingClientRect();

                    // Calculate relative coordinates
                    const relX = e.clientX - rect.left;
                    const relY = e.clientY - rect.top;

                    // Calculate actual canvas coordinates (handling scale)
                    const scaleX = pdfCanvas.width / rect.width;
                    const scaleY = pdfCanvas.height / rect.height;
                    
                    const srcX = relX * scaleX;
                    const srcY = relY * scaleY;

                    // Clear lens
                    lensCtx.fillStyle = '#ffffff';
                    lensCtx.fillRect(0, 0, size, size);

                    // Draw Composite (PDF + Ink)
                    // Zoom Factor 2x in lens (source 100px -> dest 200px)
                    const zoom = 200; 
                    const region = 100;

                    try {
                        lensCtx.drawImage(pdfCanvas, srcX - region, srcY - region, region*2, region*2, 0, 0, size, size);
                        lensCtx.drawImage(inkCanvas, srcX - region, srcY - region, region*2, region*2, 0, 0, size, size);
                    } catch (err) {
                        // Handle edge cases where source is out of bounds
                    }
                }
            }
        };

        // --- SERVICE: UI UTILITIES ---
        const FlipOS_UI = {
            toggleTheme() {
                const body = document.body;
                const current = body.getAttribute('data-theme');
                body.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
            },
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) document.exitFullscreen();
                }
            }
        };

        // --- BOOTSTRAP ---
        FlipOS_Kernel.initializeSystem();

    </script>
</body>
</html>
