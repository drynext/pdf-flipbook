<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PDF Flipbook V6 (Remastered)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CẤU HÌNH GIAO DIỆN --- */
        :root {
            --bg-color: #1a1a1a;
            --panel-color: #252525;
            --text-color: #eee;
            --accent-color: #3498db;
            --border-color: #444;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 1. THANH CÔNG CỤ (TOOLBAR) */
        .toolbar {
            height: 55px;
            background: var(--panel-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 1000; /* Luôn nổi trên cùng */
        }

        .tool-group { display: flex; align-items: center; gap: 8px; }

        .btn {
            height: 36px; min-width: 36px; padding: 0 10px;
            border: 1px solid var(--border-color);
            background: #333; color: #fff;
            border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .btn:hover { background: var(--accent-color); border-color: var(--accent-color); }
        .btn:active { transform: translateY(1px); }
        .btn i { pointer-events: none; }

        .zoom-display {
            font-variant-numeric: tabular-nums;
            font-weight: bold; min-width: 50px; text-align: center;
            font-size: 0.9rem; color: var(--accent-color);
        }

        /* 2. KHUNG HIỂN THỊ (STAGE) */
        .stage {
            flex: 1;
            position: relative;
            overflow: hidden; /* Ẩn thanh cuộn mặc định */
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Lớp chứa sách (Dùng để Zoom Scale) */
        .zoom-container {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: center center;
            will-change: transform;
        }

        /* Lớp phủ tàng hình để KÉO THẢ (Chỉ hiện khi Zoom > 100%) */
        #pan-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500;
            display: none;
            cursor: grab;
        }
        #pan-layer.grabbing { cursor: grabbing; }

        /* Sách */
        .stf__wrapper { box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        canvas { width: 100%; height: 100%; object-fit: contain; }

        /* 3. MÀN HÌNH UPLOAD */
        #upload-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .upload-btn {
            padding: 20px 40px; border: 2px dashed var(--accent-color);
            border-radius: 10px; cursor: pointer; font-size: 1.2rem;
            color: var(--accent-color); transition: 0.3s;
        }
        .upload-btn:hover { background: rgba(52, 152, 219, 0.1); scale: 1.05; }
        
        #loading-bar { 
            width: 300px; height: 6px; background: #333; 
            margin-top: 20px; border-radius: 3px; overflow: hidden; display: none; 
        }
        #loading-fill { width: 0%; height: 100%; background: var(--accent-color); transition: width 0.1s; }

        /* Kính lúp (Ẩn mặc định) */
        #magnifier {
            position: absolute; width: 220px; height: 220px;
            border: 3px solid #fff; border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            display: none; pointer-events: none; z-index: 999;
            background: #fff no-repeat;
        }
    </style>
</head>
<body>

    <div id="upload-overlay">
        <div class="upload-btn" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-file-pdf"></i> CHỌN FILE PDF
        </div>
        <input type="file" id="file-input" accept="application/pdf" style="display: none;">
        <div id="loading-bar"><div id="loading-fill"></div></div>
        <div id="status-text" style="margin-top: 10px; color: #888; display: none;">Đang xử lý...</div>
    </div>

    <div class="toolbar">
        <div class="tool-group">
            <span style="font-weight:bold; color:#fff;">PDF READER V6</span>
        </div>

        <div class="tool-group">
            <button class="btn" id="btn-prev" title="Trang trước (Mũi tên trái)"><i class="fas fa-arrow-left"></i></button>
            <span style="min-width: 80px; text-align: center;" id="page-indicator">0 / 0</span>
            <button class="btn" id="btn-next" title="Trang sau (Mũi tên phải)"><i class="fas fa-arrow-right"></i></button>
        </div>

        <div class="tool-group">
            <button class="btn" onclick="ZoomManager.zoomOut()" title="Giảm"><i class="fas fa-minus"></i></button>
            <span class="zoom-display" id="zoom-text">100%</span>
            <button class="btn" onclick="ZoomManager.zoomIn()" title="Tăng"><i class="fas fa-plus"></i></button>
            <button class="btn" onclick="ZoomManager.reset()" title="Mặc định"><i class="fas fa-compress"></i></button>
            <div style="width: 1px; height: 20px; background: #444; margin: 0 5px;"></div>
            <button class="btn" onclick="toggleSound()" id="btn-sound"><i class="fas fa-volume-up"></i></button>
            <button class="btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i></button>
        </div>
    </div>

    <div class="stage">
        <div class="zoom-container" id="zoom-container">
            <div id="book"></div>
        </div>

        <div id="pan-layer"></div>

        <div id="magnifier"></div>
    </div>

    <audio id="snd-flip" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let pdfDoc = null;
        let pageFlip = null;
        let isSound = true;

        const ui = {
            book: document.getElementById('book'),
            zoomContainer: document.getElementById('zoom-container'),
            panLayer: document.getElementById('pan-layer'),
            uploadOverlay: document.getElementById('upload-overlay'),
            pageText: document.getElementById('page-indicator')
        };

        // --- 1. QUẢN LÝ ZOOM (Logic mới) ---
        const ZoomManager = {
            levels: [0.25, 0.5, 0.75, 1.0, 1.5, 2.0], // Các mức zoom cố định
            currentIndex: 3, // Mặc định là 1.0 (index 3)
            panX: 0, panY: 0,
            isDragging: false,
            startX: 0, startY: 0,

            init() {
                this.render();
                // Sự kiện kéo thả
                ui.panLayer.addEventListener('mousedown', (e) => this.startDrag(e));
                window.addEventListener('mousemove', (e) => this.doDrag(e));
                window.addEventListener('mouseup', () => this.stopDrag());
            },

            zoomIn() {
                if (this.currentIndex < this.levels.length - 1) {
                    this.currentIndex++;
                    this.render();
                }
            },

            zoomOut() {
                if (this.currentIndex > 0) {
                    this.currentIndex--;
                    this.render();
                }
            },

            reset() {
                this.currentIndex = 3; // Về 1.0
                this.panX = 0; this.panY = 0;
                this.render();
            },

            render() {
                const scale = this.levels[this.currentIndex];
                
                // Cập nhật text hiển thị
                document.getElementById('zoom-text').innerText = (scale * 100) + '%';

                // Apply Transform
                ui.zoomContainer.style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${scale})`;

                // LOGIC QUAN TRỌNG:
                // Nếu Scale > 1 (100%): Bật lớp PanLayer lên để chặn click vào sách -> Cho phép kéo thả.
                // Nếu Scale <= 1: Tắt PanLayer -> Cho phép click vào sách để lật trang.
                if (scale > 1) {
                    ui.panLayer.style.display = 'block';
                } else {
                    ui.panLayer.style.display = 'none';
                    // Reset vị trí khi về 100% cho đẹp
                    this.panX = 0; this.panY = 0;
                    ui.zoomContainer.style.transform = `translate(0,0) scale(${scale})`;
                }
            },

            // Xử lý Kéo thả (Pan)
            startDrag(e) {
                this.isDragging = true;
                this.startX = e.clientX - this.panX;
                this.startY = e.clientY - this.panY;
                ui.panLayer.classList.add('grabbing');
            },
            doDrag(e) {
                if (!this.isDragging) return;
                e.preventDefault();
                this.panX = e.clientX - this.startX;
                this.panY = e.clientY - this.startY;
                
                const scale = this.levels[this.currentIndex];
                ui.zoomContainer.style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${scale})`;
            },
            stopDrag() {
                this.isDragging = false;
                ui.panLayer.classList.remove('grabbing');
            }
        };

        ZoomManager.init();

        // --- 2. XỬ LÝ UPLOAD & RENDER ---
        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            document.querySelector('.upload-btn').style.display = 'none';
            document.getElementById('loading-bar').style.display = 'block';
            document.getElementById('status-text').style.display = 'block';

            // Mồi âm thanh
            const audio = document.getElementById('snd-flip');
            audio.play().catch(()=>{}); audio.pause();

            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async (ev) => {
                const data = new Uint8Array(ev.target.result);
                pdfDoc = await pdfjsLib.getDocument(data).promise;
                ui.pageText.innerText = `1 / ${pdfDoc.numPages}`;
                await generatePages();
            };
        });

        async function generatePages() {
            ui.book.innerHTML = '';
            const total = pdfDoc.numPages;

            for(let i=1; i<=total; i++) {
                const page = await pdfDoc.getPage(i);
                const viewport = page.getViewport({ scale: 1.5 }); // Scale 1.5 cho nét
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d', { alpha: false });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                canvas.className = 'page-class';
                
                await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                ui.book.appendChild(canvas);

                // Progress Bar
                const pct = (i/total)*100;
                document.getElementById('loading-fill').style.width = pct + '%';
            }

            document.getElementById('upload-overlay').style.display = 'none';
            initBookEngine();
        }

        // --- 3. PAGE FLIP ENGINE ---
        function initBookEngine() {
            const isMobile = window.innerWidth < 768;

            pageFlip = new St.PageFlip(ui.book, {
                width: isMobile ? 350 : 550,
                height: isMobile ? 500 : 750,
                size: "stretch",
                minWidth: 300, maxWidth: 1000,
                minHeight: 400, maxHeight: 1200,
                showCover: true,
                usePortrait: isMobile,
                startPage: 0,
                useMouseEvents: true // Để nhận click lật trang ở mức Zoom 100%
            });

            pageFlip.loadFromHTML(document.querySelectorAll('.page-class'));

            pageFlip.on('flip', (e) => {
                ui.pageText.innerText = `${e.data + 1} / ${pdfDoc.numPages}`;
                playSound();
            });
        }

        // --- 4. ĐIỀU HƯỚNG PHÍM CỨNG (QUAN TRỌNG) ---
        // Xử lý sự kiện bàn phím toàn cục
        document.addEventListener('keydown', (e) => {
            // Nếu đang ở màn hình upload thì bỏ qua
            if (document.getElementById('upload-overlay').style.display !== 'none') return;

            // Mũi tên TRÁI -> Lật lại
            if (e.key === 'ArrowLeft') {
                if (pageFlip) pageFlip.flipPrev();
            }
            // Mũi tên PHẢI -> Lật đi
            if (e.key === 'ArrowRight') {
                if (pageFlip) pageFlip.flipNext();
            }
            // Phím + / - để zoom
            if (e.key === '=' || e.key === '+') ZoomManager.zoomIn();
            if (e.key === '-') ZoomManager.zoomOut();
        });

        // Nút Toolbar
        document.getElementById('btn-prev').onclick = () => pageFlip && pageFlip.flipPrev();
        document.getElementById('btn-next').onclick = () => pageFlip && pageFlip.flipNext();


        // --- 5. CÁC TIỆN ÍCH KHÁC ---
        function playSound() {
            if(!isSound) return;
            const audio = document.getElementById('snd-flip');
            audio.currentTime = 0;
            audio.play().catch(()=>{});
        }

        function toggleSound() {
            isSound = !isSound;
            const btn = document.getElementById('btn-sound');
            btn.innerHTML = isSound ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            btn.style.opacity = isSound ? 1 : 0.5;
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen();
            else if (document.exitFullscreen) document.exitFullscreen();
        }

    </script>
</body>
</html>
