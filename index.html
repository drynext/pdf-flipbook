<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipOS X (Studio Edition)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #121212;
            --panel-dark: rgba(28, 28, 30, 0.95);
            --accent: #0a84ff;
            --text: #ffffff;
            --border: rgba(255,255,255,0.15);
            --shadow: 0 8px 32px rgba(0,0,0,0.5);
            --radius: 18px;
        }

        [data-theme="light"] {
            --bg-dark: #f2f2f7;
            --panel-dark: rgba(255, 255, 255, 0.95);
            --accent: #007aff;
            --text: #000000;
            --border: rgba(0,0,0,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        
        body {
            background-color: var(--bg-dark); color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .island-top {
            position: fixed; top: 20px; z-index: 1000;
            background: var(--panel-dark); backdrop-filter: blur(20px);
            padding: 8px 16px; border-radius: 50px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; align-items: center; gap: 15px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .mode-switch {
            background: rgba(128,128,128,0.2); border-radius: 30px;
            display: flex; padding: 4px; position: relative;
        }
        
        .mode-opt {
            padding: 8px 20px; border-radius: 25px; cursor: pointer;
            font-weight: 600; font-size: 0.9rem; z-index: 2;
            transition: color 0.2s;
        }
        
        .mode-blob {
            position: absolute; top: 4px; left: 4px; height: calc(100% - 8px);
            background: var(--accent); border-radius: 25px;
            z-index: 1; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        .island-tools {
            position: fixed; top: 100px; left: 20px; z-index: 900;
            background: var(--panel-dark); backdrop-filter: blur(20px);
            padding: 15px; border-radius: var(--radius);
            box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 15px;
            transform: translateX(-150%); opacity: 0;
            transition: 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .island-tools.visible { transform: translateX(0); opacity: 1; }

        .tool-btn {
            width: 44px; height: 44px; border-radius: 12px;
            background: rgba(128,128,128,0.1); border: 1px solid transparent;
            color: var(--text); font-size: 1.2rem; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s; position: relative;
        }
        .tool-btn:hover { background: rgba(128,128,128,0.2); }
        .tool-btn.active { background: var(--accent); color: white; box-shadow: 0 4px 15px var(--accent); transform: scale(1.1); }

        .color-dot {
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer;
            border: 2px solid transparent; transition: 0.2s;
        }
        .color-dot.active { border-color: var(--text); transform: scale(1.2); }

        .island-bottom {
            position: fixed; bottom: 30px; z-index: 1000;
            background: var(--panel-dark); backdrop-filter: blur(20px);
            padding: 10px 25px; border-radius: 40px;
            box-shadow: var(--shadow); border: 1px solid var(--border);
            display: flex; gap: 20px; align-items: center;
        }

        .icon-btn {
            background: none; border: none; color: var(--text);
            font-size: 1.2rem; cursor: pointer; opacity: 0.7;
            transition: 0.2s;
        }
        .icon-btn:hover { opacity: 1; transform: translateY(-2px); }

        .stage {
            width: 100vw; height: 100vh;
            position: relative; overflow: hidden;
            background-image: radial-gradient(rgba(128,128,128,0.2) 1px, transparent 1px);
            background-size: 40px 40px;
            display: flex; justify-content: center; align-items: center;
        }

        .book-container {
            transition: transform 0.1s linear; 
            transform-style: preserve-3d;
            will-change: transform;
        }

        .page-wrapper {
            position: relative; background: #fff; overflow: hidden;
            backface-visibility: hidden;
        }

        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .pdf-layer { z-index: 1; }
        .ink-layer { z-index: 10; cursor: crosshair; }

        .upload-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
        }
        .drop-zone {
            width: 400px; height: 250px; border: 3px dashed var(--accent);
            border-radius: 20px; display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer;
            transition: 0.3s;
        }
        .drop-zone:hover { background: rgba(10, 132, 255, 0.1); transform: scale(1.02); }

        .toast {
            position: fixed; top: 90px; left: 50%; transform: translateX(-50%) translateY(-20px);
            background: #222; color: #fff; padding: 10px 20px; border-radius: 30px;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 6000; font-weight: 600;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body data-theme="dark">

    <div class="upload-modal" id="modal">
        <div class="drop-zone" onclick="document.getElementById('file-in').click()">
            <i class="fas fa-feather-alt" style="font-size: 4rem; color: var(--accent); margin-bottom: 15px;"></i>
            <h2>FLIP OS X</h2>
            <p style="opacity: 0.7;">Chạm để mở Studio</p>
        </div>
        <input type="file" id="file-in" accept="application/pdf" style="display: none;">
        <div id="loading" style="margin-top:20px; font-weight:bold; display:none;">INITIALIZING INK ENGINE...</div>
    </div>

    <div class="island-top">
        <div class="mode-switch">
            <div class="mode-blob" id="blob"></div>
            <div class="mode-opt" onclick="App.setMode(0)" style="width: 80px; text-align: center;">READ</div>
            <div class="mode-opt" onclick="App.setMode(1)" style="width: 80px; text-align: center;">DRAW</div>
        </div>
        <div style="width:1px; height:20px; background:rgba(128,128,128,0.3)"></div>
        <i class="fas fa-moon icon-btn" onclick="App.toggleTheme()"></i>
    </div>

    <div class="island-tools" id="tool-panel">
        <div class="tool-btn active" id="tool-pen" onclick="Ink.setTool('pen')" title="Bút máy"><i class="fas fa-pen-nib"></i></div>
        <div class="tool-btn" id="tool-marker" onclick="Ink.setTool('marker')" title="Bút nhớ"><i class="fas fa-highlighter"></i></div>
        <div class="tool-btn" id="tool-eraser" onclick="Ink.setTool('eraser')" title="Tẩy"><i class="fas fa-eraser"></i></div>
        
        <div style="height:1px; background:rgba(128,128,128,0.3); margin: 5px 0;"></div>

        <div class="color-dot active" style="background:#fff" onclick="Ink.setColor('#ffffff', this)"></div>
        <div class="color-dot" style="background:#0a84ff" onclick="Ink.setColor('#0a84ff', this)"></div>
        <div class="color-dot" style="background:#ff453a" onclick="Ink.setColor('#ff453a', this)"></div>
        <div class="color-dot" style="background:#ffd60a" onclick="Ink.setColor('#ffd60a', this)"></div>
        
        <div style="height:1px; background:rgba(128,128,128,0.3); margin: 5px 0;"></div>
        
        <div class="tool-btn" onclick="Ink.undo()" title="Hoàn tác"><i class="fas fa-undo"></i></div>
        <div class="tool-btn" onclick="Ink.clear()" title="Xóa hết trang"><i class="fas fa-trash-alt"></i></div>
    </div>

    <div class="island-bottom">
        <button class="icon-btn" onclick="App.prev()"><i class="fas fa-chevron-left"></i></button>
        <span id="page-txt" style="font-weight:700; font-variant-numeric: tabular-nums; width:80px; text-align:center;">---</span>
        <button class="icon-btn" onclick="App.next()"><i class="fas fa-chevron-right"></i></button>
        <div style="width:1px; height:20px; background:rgba(128,128,128,0.3)"></div>
        <button class="icon-btn" onclick="Zoom.out()"><i class="fas fa-minus"></i></button>
        <span id="zoom-txt" style="font-weight:700;">100%</span>
        <button class="icon-btn" onclick="Zoom.in()"><i class="fas fa-plus"></i></button>
    </div>

    <div class="stage" id="stage">
        <div class="book-container" id="book"></div>
    </div>

    <div class="toast" id="toast">Thông báo</div>

    <audio id="snd-flip" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const State = {
            mode: 0,
            zoom: 1,
            pdf: null,
            flip: null,
            isDark: true
        };

        const App = {
            init() {
                document.getElementById('file-in').addEventListener('change', this.loadPDF);
                document.addEventListener('keydown', e => {
                    if(e.ctrlKey && e.key === 'z') Ink.undo();
                });
            },

            async loadPDF(e) {
                const file = e.target.files[0];
                if(!file) return;
                
                document.querySelector('.drop-zone').style.display='none';
                document.getElementById('loading').style.display='block';
                
                const snd = document.getElementById('snd-flip'); snd.play().catch(()=>{}); snd.pause();

                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = async (ev) => {
                    const data = new Uint8Array(ev.target.result);
                    State.pdf = await pdfjsLib.getDocument(data).promise;
                    await App.renderBook();
                }
            },

            async renderBook() {
                const container = document.getElementById('book');
                container.innerHTML = '';
                const total = State.pdf.numPages;

                for(let i=1; i<=total; i++) {
                    const page = await State.pdf.getPage(i);
                    const viewport = page.getViewport({scale: 1.5});
                    
                    const wrap = document.createElement('div');
                    wrap.className = 'page-wrapper';
                    wrap.dataset.density = 1.5;

                    const pdfCan = document.createElement('canvas');
                    pdfCan.className = 'pdf-layer';
                    pdfCan.width = viewport.width; pdfCan.height = viewport.height;
                    const ctx = pdfCan.getContext('2d', {alpha: false});
                    await page.render({canvasContext: ctx, viewport}).promise;

                    const inkCan = document.createElement('canvas');
                    inkCan.className = 'ink-layer';
                    inkCan.width = viewport.width; inkCan.height = viewport.height;
                    
                    wrap.appendChild(pdfCan);
                    wrap.appendChild(inkCan);
                    container.appendChild(wrap);
                }

                document.getElementById('modal').style.display='none';
                this.initFlip();
                Ink.init();
            },

            initFlip() {
                const isMobile = window.innerWidth < 768;
                State.flip = new St.PageFlip(document.getElementById('book'), {
                    width: isMobile ? 380 : 600, height: isMobile ? 550 : 850,
                    size: "stretch", showCover: true, usePortrait: isMobile,
                    minWidth: 300, maxWidth: 1000,
                    useMouseEvents: true
                });
                
                State.flip.loadFromHTML(document.querySelectorAll('.page-wrapper'));
                
                State.flip.on('flip', (e) => {
                    document.getElementById('page-txt').innerText = `${e.data+1} / ${State.pdf.numPages}`;
                    UI.sound();
                });
            },

            setMode(m) {
                State.mode = m;
                const blob = document.getElementById('blob');
                const panel = document.getElementById('tool-panel');
                
                if(m === 0) {
                    blob.style.transform = 'translateX(0)';
                    panel.classList.remove('visible');
                    if(State.flip) State.flip.update({useMouseEvents: true});
                    document.body.style.cursor = 'default';
                    UI.notify("Read Mode");
                } else {
                    blob.style.transform = 'translateX(100%)';
                    panel.classList.add('visible');
                    if(State.flip) State.flip.update({useMouseEvents: false});
                    UI.notify("Studio Mode Active");
                }
            },

            toggleTheme() {
                State.isDark = !State.isDark;
                document.body.setAttribute('data-theme', State.isDark ? 'dark' : 'light');
            },

            prev() { State.flip?.flipPrev(); },
            next() { State.flip?.flipNext(); }
        };

        const Ink = {
            tool: 'pen',
            color: '#ffffff',
            size: 3,
            isDrawing: false,
            points: [],
            ctx: null,
            canvas: null,
            
            startTime: 0,
            holdTimer: null,
            startPoint: null,
            snapshot: null,

            init() {
                const layers = document.querySelectorAll('.ink-layer');
                layers.forEach(can => {
                    can.addEventListener('pointerdown', e => this.start(e, can));
                    can.addEventListener('pointermove', e => this.move(e));
                    can.addEventListener('pointerup', e => this.end(e));
                    can.addEventListener('pointercancel', e => this.end(e));
                });
            },

            setTool(t) {
                this.tool = t;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(`tool-${t}`).classList.add('active');
            },

            setColor(c, el) {
                this.color = c; this.tool = 'pen';
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
                el.classList.add('active');
                this.setTool('pen');
            },

            getPoint(e, canvas) {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY,
                    pressure: e.pressure || 0.5,
                    time: Date.now()
                };
            },

            start(e, canvas) {
                if(State.mode !== 1) return;
                e.preventDefault();
                canvas.setPointerCapture(e.pointerId);

                this.isDrawing = true;
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.points = [];
                
                this.snapshot = this.ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                const p = this.getPoint(e, canvas);
                this.points.push(p);
                this.startPoint = p;

                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                
                if(this.tool === 'marker') {
                    this.ctx.globalCompositeOperation = 'multiply';
                    this.ctx.strokeStyle = this.color + '66';
                    this.ctx.lineWidth = 20;
                } else if (this.tool === 'eraser') {
                    this.ctx.globalCompositeOperation = 'destination-out';
                    this.ctx.lineWidth = 25;
                } else {
                    this.ctx.globalCompositeOperation = 'source-over';
                    this.ctx.strokeStyle = this.color;
                    this.ctx.lineWidth = this.size;
                }

                this.startTime = Date.now();
                clearTimeout(this.holdTimer);
                this.holdTimer = setTimeout(() => {
                    if(this.isDrawing && this.points.length > 10) {
                        this.snapToShape();
                    }
                }, 600);
            },

            move(e) {
                if(!this.isDrawing) return;
                
                const p = this.getPoint(e, this.canvas);
                this.points.push(p);

                if(this.points.length > 2) {
                    const lastTwo = this.points.slice(-2);
                    const p1 = lastTwo[0];
                    const p2 = lastTwo[1];
                    const mid = {
                        x: p1.x + (p2.x - p1.x) / 2,
                        y: p1.y + (p2.y - p1.y) / 2
                    };

                    this.ctx.beginPath();
                    this.ctx.moveTo(p1.x, p1.y);
                    this.ctx.quadraticCurveTo(p1.x, p1.y, mid.x, mid.y);
                    this.ctx.stroke();
                }
            },

            end(e) {
                clearTimeout(this.holdTimer);
                this.isDrawing = false;
                this.points = [];
                this.ctx.beginPath();
            },

            snapToShape() {
                this.ctx.putImageData(this.snapshot, 0, 0);

                const start = this.startPoint;
                const current = this.points[this.points.length - 1];

                this.ctx.beginPath();
                this.ctx.moveTo(start.x, start.y);
                this.ctx.lineTo(current.x, current.y);
                this.ctx.stroke();
                
                UI.notify("Shape Snapped!");
                UI.sound();
            },

            clear() {
                if(this.canvas) {
                    const ctx = this.canvas.getContext('2d');
                    ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                }
            },
            
            undo() {
                UI.notify("Undo not available in V10 Core");
            }
        };

        const Zoom = {
            val: 1,
            pan: {x:0, y:0},
            
            in() { if(this.val<3) {this.val+=0.5; this.apply();} },
            out() { if(this.val>1) {this.val-=0.5; this.apply();} },
            
            apply() {
                document.getElementById('zoom-txt').innerText = (this.val*100)+'%';
                const el = document.getElementById('book');
                el.style.transform = `scale(${this.val})`;
                
                if(this.val > 1) {
                     UI.notify("Zoom Active - Use Scrollbars");
                     document.querySelector('.stage').style.overflow = 'auto';
                } else {
                     document.querySelector('.stage').style.overflow = 'hidden';
                     el.style.transform = `translate(0,0) scale(1)`;
                }
            }
        };

        const UI = {
            notify(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg; t.classList.add('show');
                setTimeout(()=>t.classList.remove('show'), 2000);
            },
            sound() {}
        };

        App.init();

    </script>
</body>
</html>
