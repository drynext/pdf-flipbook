<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="FlipOS V23 Stable - Fixed Upload & Syntax">
    <title>FlipOS V23 | Stable Studio</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* CORE VARIABLES */
        :root {
            --sys-bg: #050505;
            --sys-panel: #1a1a1d;
            --sys-text: #ffffff;
            --sys-accent: #3b82f6;
            --sys-border: #27272a;
            --sys-sidebar-w: 72px;
        }
        [data-theme="light"] {
            --sys-bg: #f0f2f5;
            --sys-panel: #ffffff;
            --sys-text: #18181b;
            --sys-border: #e4e4e7;
            --sys-accent: #2563eb;
        }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; }
        
        body {
            background-color: var(--sys-bg); color: var(--sys-text);
            font-family: 'Inter', sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            display: grid;
            grid-template-columns: var(--sys-sidebar-w) 1fr var(--sys-sidebar-w);
            grid-template-rows: 100%;
            grid-template-areas: "left stage right";
        }

        /* SIDEBARS */
        .sidebar {
            background-color: var(--sys-panel);
            border-left: 1px solid var(--sys-border);
            border-right: 1px solid var(--sys-border);
            z-index: 1000; display: flex; flex-direction: column; 
            align-items: center; padding: 20px 0; gap: 16px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
        }
        #ui-left { grid-area: left; border-left: none; }
        #ui-right { grid-area: right; border-right: none; }

        /* STAGE */
        #stage {
            grid-area: stage; position: relative; overflow: hidden;
            background-image: radial-gradient(var(--sys-border) 1px, transparent 1px);
            background-size: 24px 24px;
            display: flex; justify-content: center; align-items: center;
            cursor: grab;
        }
        #stage:active { cursor: grabbing; }

        #transform-target {
            transform-origin: center center;
            will-change: transform;
            transition: transform 0.1s linear;
        }

        /* COMPONENTS */
        .btn {
            width: 48px; height: 48px; border-radius: 12px;
            background: rgba(128,128,128,0.05); color: inherit;
            border: 1px solid transparent; cursor: pointer;
            display: flex; justify-content: center; align-items: center; font-size: 1.25rem;
            transition: 0.2s;
        }
        .btn:hover { background: rgba(128,128,128,0.2); transform: translateY(-2px); }
        .btn.active { background: var(--sys-accent); color: #fff; box-shadow: 0 4px 12px rgba(59,130,246,0.4); }

        .divider { width: 60%; height: 1px; background: var(--sys-border); margin: 4px 0; }
        
        .color-dot { width: 32px; height: 32px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; }
        .color-dot.active { border-color: var(--sys-text); transform: scale(1.15); }

        /* BOOK LAYERS */
        .page-wrap { position: relative; background: #fff; overflow: hidden; box-shadow: 0 0 20px rgba(0,0,0,0.3); }
        canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
        .pdf-l { z-index: 1; pointer-events: none; }
        .ink-l { z-index: 10; cursor: crosshair; touch-action: none; }

        /* OVERLAYS */
        #pan-mask { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 500; display: none; }
        
        .spyglass {
            position: fixed; width: 220px; height: 220px;
            border-radius: 50%; border: 4px solid var(--sys-text);
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            overflow: hidden; pointer-events: none; z-index: 9000;
            display: none; background: #fff;
        }

        /* UPLOAD */
        #upload-ol { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        .upload-box { 
            padding: 60px 80px; border: 2px dashed var(--sys-border); border-radius: 32px; 
            text-align: center; cursor: pointer; transition: 0.3s; 
        }
        .upload-box:hover { border-color: var(--sys-accent); transform: translateY(-5px); }

        #toast { 
            position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); 
            background: var(--sys-panel); color: var(--sys-text); padding: 12px 24px; 
            border-radius: 50px; font-weight: 600; opacity: 0; pointer-events: none; 
            transition: 0.3s; z-index: 8000; border: 1px solid var(--sys-border);
        }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    </style>
</head>
<body data-theme="dark">

    <div id="upload-ol">
        <div class="upload-box" onclick="document.getElementById('file-in').click()">
            <i class="fas fa-file-pdf" style="font-size: 4rem; color: var(--sys-accent); margin-bottom: 24px;"></i>
            <h1 style="font-size: 2.5rem; font-weight: 800; margin-bottom: 10px;">FLIP OS V23</h1>
            <p style="color: #888; font-family: monospace;">Stable Kernel â€¢ Dual Spread</p>
        </div>
        <input type="file" id="file-in" hidden accept="application/pdf">
    </div>

    <aside class="sidebar" id="ui-left">
        <button class="btn active" id="m-read" onclick="Kernel.mode('READ')"><i class="fas fa-eye"></i></button>
        <button class="btn" id="m-draw" onclick="Kernel.mode('DRAW')"><i class="fas fa-pen"></i></button>
        <div class="divider"></div>
        <button class="btn" id="t-pen" onclick="Ink.tool('pen')"><i class="fas fa-pen-nib"></i></button>
        <button class="btn" id="t-mark" onclick="Ink.tool('marker')"><i class="fas fa-highlighter"></i></button>
        <button class="btn" id="t-erase" onclick="Ink.tool('eraser')"><i class="fas fa-eraser"></i></button>
        <div class="divider"></div>
        <div class="color-dot active" style="background:#ef4444" onclick="Ink.color('#ef4444',this)"></div>
        <div class="color-dot" style="background:#22c55e" onclick="Ink.color('#22c55e',this)"></div>
        <div class="color-dot" style="background:#3b82f6" onclick="Ink.color('#3b82f6',this)"></div>
        <div class="divider"></div>
        <button class="btn" onclick="Ink.undo()"><i class="fas fa-undo"></i></button>
        <button class="btn" onclick="Ink.clear()"><i class="fas fa-trash"></i></button>
    </aside>

    <main id="stage" ondblclick="View.reset()">
        <div id="transform-target">
            <div id="book-root"></div>
        </div>
        <div id="pan-mask"></div>
    </main>

    <aside class="sidebar" id="ui-right">
        <button class="btn" onclick="UI.theme()"><i class="fas fa-adjust"></i></button>
        <div class="divider"></div>
        <button class="btn" onclick="View.zoom(1)"><i class="fas fa-plus"></i></button>
        <span id="zoom-txt" style="font-family:monospace; font-weight:700; color:var(--sys-accent)">100%</span>
        <button class="btn" onclick="View.zoom(-1)"><i class="fas fa-minus"></i></button>
        <div class="divider"></div>
        <button class="btn" onclick="Book.nav(-1)"><i class="fas fa-chevron-left"></i></button>
        <span id="pg-txt" style="font-family:monospace; font-weight:700;">--/--</span>
        <button class="btn" onclick="Book.nav(1)"><i class="fas fa-chevron-right"></i></button>
        <div class="divider"></div>
        <button class="btn" id="btn-spy" onclick="Spy.toggle()"><i class="fas fa-search"></i></button>
        <button class="btn" onclick="UI.full()"><i class="fas fa-expand"></i></button>
    </aside>

    <div class="spyglass" id="spy-root"><canvas id="spy-c"></canvas></div>
    <div id="toast">Ready</div>
    <audio id="sfx" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const State = { pdf: null, book: null, mode: 'READ', zoom: 1, total: 0, current: 0 };

        const Kernel = {
            init() {
                document.getElementById('file-in').addEventListener('change', this.upload);
                window.addEventListener('keydown', e => {
                    if(e.key==='ArrowLeft') Book.nav(-1);
                    if(e.key==='ArrowRight') Book.nav(1);
                    if(e.ctrlKey && e.key==='z') Ink.undo();
                    if(e.key==='+') View.zoom(1);
                    if(e.key==='-') View.zoom(-1);
                });
            },
            async upload(e) {
                if(!e.target.files[0]) return;
                try {
                    document.querySelector('.upload-box').innerHTML = '<i class="fas fa-spin fa-spinner" style="font-size:3rem"></i>';
                    const ab = await e.target.files[0].arrayBuffer();
                    State.pdf = await pdfjsLib.getDocument(ab).promise;
                    State.total = State.pdf.numPages;
                    await Render.build();
                } catch(err) {
                    alert("Error loading PDF: " + err.message);
                    location.reload();
                }
            },
            mode(m) {
                State.mode = m;
                document.getElementById('m-read').classList.toggle('active', m==='READ');
                document.getElementById('m-draw').classList.toggle('active', m==='DRAW');
                const mask = document.getElementById('pan-mask');
                
                if(m==='READ') {
                    if(State.book) State.book.update({useMouseEvents: true});
                    if(State.zoom > 1) mask.style.display = 'block';
                    UI.toast("Reader Mode");
                } else {
                    if(State.book) State.book.update({useMouseEvents: false});
                    mask.style.display = 'none';
                    UI.toast("Studio Mode");
                }
            }
        };

        const Render = {
            async build() {
                const root = document.getElementById('book-root'); root.innerHTML = '';
                for(let i=1; i<=State.total; i++) {
                    const p = await State.pdf.getPage(i);
                    const v = p.getViewport({scale: 1.5});
                    const wrap = document.createElement('div');
                    wrap.className = 'page-wrap'; wrap.dataset.idx = i;
                    
                    const pc = document.createElement('canvas'); pc.className='pdf-l'; pc.width=v.width; pc.height=v.height;
                    await p.render({canvasContext: pc.getContext('2d'), viewport: v}).promise;
                    
                    const ic = document.createElement('canvas'); ic.className='ink-l'; ic.width=v.width; ic.height=v.height;
                    
                    wrap.append(pc, ic); root.append(wrap);
                }
                document.getElementById('upload-ol').style.display = 'none';
                Book.init(); Ink.init(); View.init();
            }
        };

        const Book = {
            init() {
                const w = document.getElementById('stage').clientWidth;
                // Force landscape spread if width allows
                const isWide = w > 800;
                State.book = new St.PageFlip(document.getElementById('book-root'), {
                    width: isWide ? 550 : 400, height: isWide ? 800 : 600,
                    size: isWide ? 'fixed' : 'stretch',
                    usePortrait: !isWide,
                    showCover: true, useMouseEvents: true
                });
                State.book.loadFromHTML(document.querySelectorAll('.page-wrap'));
                State.book.on('flip', e => {
                    State.current = e.data + 1;
                    document.getElementById('pg-txt').innerText = `${State.current}/${State.total}`;
                    const sfx = document.getElementById('sfx'); sfx.currentTime=0; sfx.play().catch(()=>{});
                });
            },
            nav(d) {
                if(!State.book) return;
                d === -1 ? State.book.flipPrev() : State.book.flipNext();
            }
        };

        const View = {
            pan: {x:0, y:0}, val: 1, isD: false, start: {x:0,y:0},
            init() {
                const m = document.getElementById('pan-mask');
                m.onmousedown = e => { this.isD=true; this.start={x:e.clientX-this.pan.x, y:e.clientY-this.pan.y}; m.style.cursor='grabbing'; };
                window.onmousemove = e => {
                    if(this.isD) { e.preventDefault(); this.pan.x=e.clientX-this.start.x; this.pan.y=e.clientY-this.start.y; this.apply(); }
                    if(Spy.on) Spy.render(e);
                };
                window.onmouseup = () => { this.isD=false; m.style.cursor='grab'; };
            },
            zoom(d) {
                if(d>0 && this.val<4) this.val+=0.5; else if(d<0 && this.val>1) this.val-=0.5;
                this.apply();
            },
            reset() { this.val=1; this.pan={x:0,y:0}; this.apply(); UI.toast("Reset View"); },
            apply() {
                State.zoom = this.val;
                document.getElementById('zoom-txt').innerText = (this.val*100)+'%';
                const t = document.getElementById('transform-target');
                const m = document.getElementById('pan-mask');
                
                t.style.transform = `translate(${this.pan.x}px, ${this.pan.y}px) scale(${this.val})`;
                
                if(this.val > 1 && State.mode === 'READ') {
                    m.style.display = 'block';
                    if(State.book) State.book.update({useMouseEvents: false});
                } else {
                    m.style.display = 'none';
                    if(this.val===1) { this.pan={x:0,y:0}; t.style.transform='scale(1)'; }
                    if(State.mode === 'READ' && State.book) State.book.update({useMouseEvents: true});
                }
            }
        };

        const Ink = {
            t: 'pen', c: '#ef4444', isD: false, ctx: null, can: null, hist: {}, last: {x:0,y:0},
            init() {
                const s = document.getElementById('stage');
                s.onpointerdown = e => this.down(e);
                window.onpointermove = e => this.move(e);
                window.onpointerup = () => this.up();
            },
            tool(n) {
                this.t = n;
                ['pen','mark','erase'].forEach(id => document.getElementById('t-'+id).classList.remove('active'));
                document.getElementById('t-'+(n==='marker'?'mark':(n==='eraser'?'erase':'pen'))).classList.add('active');
            },
            color(hex, el) {
                this.c = hex; this.tool('pen');
                document.querySelectorAll('.color-dot').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
            },
            hit(e) { const el = document.elementFromPoint(e.clientX, e.clientY); return el?.classList.contains('ink-l') ? el : null; },
            pos(e, c) { const r = c.getBoundingClientRect(); return { x: (e.clientX-r.left)*(c.width/r.width), y: (e.clientY-r.top)*(c.height/r.height) }; },
            cfg(ctx) {
                ctx.lineCap='round'; ctx.lineJoin='round';
                if(this.t==='marker') { ctx.globalCompositeOperation='multiply'; ctx.strokeStyle=this.c; ctx.lineWidth=20; ctx.globalAlpha=0.5; }
                else if(this.t==='eraser') { ctx.globalCompositeOperation='destination-out'; ctx.lineWidth=30; ctx.globalAlpha=1; }
                else { ctx.globalCompositeOperation='source-over'; ctx.strokeStyle=this.c; ctx.lineWidth=3; ctx.globalAlpha=1; }
            },
            down(e) {
                if(document.getElementById('pan-mask').style.display === 'block') return;
                const h = this.hit(e); if(!h || State.mode!=='DRAW') return;
                e.preventDefault(); this.isD=true; this.can=h; this.ctx=h.getContext('2d');
                this.cfg(this.ctx); this.last=this.pos(e, h);
                this.ctx.beginPath(); this.ctx.moveTo(this.last.x, this.last.y); this.ctx.stroke();
            },
            move(e) {
                if(!this.isD) return;
                const h = this.hit(e);
                if(h && h !== this.can) {
                    this.ctx.closePath(); this.push(this.can);
                    this.can=h; this.ctx=h.getContext('2d'); this.cfg(this.ctx);
                    this.last=this.pos(e, h);
                    this.ctx.beginPath(); this.ctx.moveTo(this.last.x, this.last.y);
                }
                if(this.can) {
                    const curr = this.pos(e, this.can);
                    this.ctx.quadraticCurveTo(this.last.x, this.last.y, (this.last.x+curr.x)/2, (this.last.y+curr.y)/2);
                    this.ctx.stroke(); this.last = curr;
                }
            },
            up() { this.isD=false; if(this.ctx) { this.ctx.closePath(); this.push(this.can); } },
            push(c) {
                if(!c) return; const i = c.parentElement.dataset.idx;
                if(!this.hist[i]) this.hist[i]=[];
                this.hist[i].push(this.ctx.getImageData(0,0,c.width,c.height));
                if(this.hist[i].length>10) this.hist[i].shift();
            },
            undo() {
                if(!this.can) return; const i = this.can.parentElement.dataset.idx;
                const h = this.hist[i];
                if(h?.length) { h.pop(); const p=h[h.length-1]; p ? this.ctx.putImageData(p,0,0) : this.ctx.clearRect(0,0,this.can.width,this.can.height); }
            },
            clear() {
                if(this.can) {
                    this.can.getContext('2d').clearRect(0,0,this.can.width,this.can.height);
                    this.push(this.can);
                }
            }
        };

        const Spy = {
            on: false,
            toggle() {
                this.on = !this.on;
                document.getElementById('btn-spy').classList.toggle('active', this.on);
                document.getElementById('spy-root').style.display = this.on ? 'block' : 'none';
            },
            render(e) {
                const s=document.getElementById('spy-root'), c=document.getElementById('spy-c').getContext('2d');
                document.getElementById('spy-c').width=500; document.getElementById('spy-c').height=500;
                s.style.left=(e.clientX+20)+'px'; s.style.top=(e.clientY+20)+'px';
                s.style.display='none'; const el=document.elementFromPoint(e.clientX, e.clientY); s.style.display='block';
                const w = el?.closest('.page-wrap');
                if(w) {
                    const pdf=w.querySelector('.pdf-l'), ink=w.querySelector('.ink-l');
                    const r=pdf.getBoundingClientRect();
                    const x=(e.clientX-r.left)*(pdf.width/r.width), y=(e.clientY-r.top)*(pdf.height/r.height);
                    c.fillStyle='#fff'; c.fillRect(0,0,500,500);
                    try { c.drawImage(pdf, x-100, y-100, 200, 200, 0,0,500,500); c.drawImage(ink, x-100, y-100, 200, 200, 0,0,500,500); } catch(e){}
                }
            }
        };

        const UI = {
            theme() { const b=document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')=='dark'?'light':'dark'); },
            full() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); },
            toast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
        };

        Kernel.init();
    </script>
</body>
</html>
