<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipOS V18 (Studio Layout)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-body: #1e1e1e;
            --bg-panel: #252526;
            --accent: #007acc;
            --text: #cccccc;
            --border: #333333;
            --hover: #2a2d2e;
        }
        [data-theme="light"] {
            --bg-body: #f3f3f3;
            --bg-panel: #ffffff;
            --text: #333;
            --accent: #0078d4;
            --border: #e5e5e5;
            --hover: #f0f0f0;
        }

        * { margin:0; padding:0; box-sizing:border-box; outline:none; -webkit-tap-highlight-color:transparent; user-select: none; }
        
        body {
            background: var(--bg-body); color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh; width: 100vw; overflow: hidden;
            display: grid;
            /* CHIA MÀN HÌNH: Trái (60px) - Giữa (Tự động) - Phải (60px) */
            grid-template-columns: 60px 1fr 60px;
            grid-template-areas: "left stage right";
        }

        /* --- SIDEBARS --- */
        .sidebar {
            background: var(--bg-panel); 
            border-left: 1px solid var(--border);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column; align-items: center;
            padding: 15px 0; gap: 15px; z-index: 100;
        }

        #panel-left { grid-area: left; border-right: 1px solid var(--border); border-left: none; }
        #panel-right { grid-area: right; border-left: 1px solid var(--border); border-right: none; }

        /* --- STAGE (SÁCH) --- */
        #stage-area {
            grid-area: stage;
            position: relative; overflow: hidden;
            background-image: radial-gradient(rgba(128,128,128,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            display: flex; justify-content: center; align-items: center;
        }

        #book-transform {
            transition: transform 0.1s linear;
            transform-origin: center center;
            will-change: transform;
        }

        /* --- COMPONENTS --- */
        .btn {
            width: 40px; height: 40px; border-radius: 8px;
            color: var(--text); background: transparent;
            border: none; cursor: pointer; font-size: 1.1rem;
            display: flex; justify-content: center; align-items: center;
            transition: 0.2s; position: relative;
        }
        .btn:hover { background: var(--hover); color: #fff; }
        .btn.active { background: var(--accent); color: #fff; }
        
        /* Mode Switcher Style */
        .mode-group {
            display: flex; flex-direction: column; gap: 5px; background: rgba(0,0,0,0.2);
            padding: 5px; border-radius: 10px; margin-bottom: 10px;
        }
        .mode-item {
            width: 30px; height: 30px; border-radius: 6px; display: flex; 
            justify-content: center; align-items: center; cursor: pointer; font-size: 0.9rem;
            opacity: 0.5; transition: 0.2s;
        }
        .mode-item.active { background: var(--accent); color: white; opacity: 1; }

        .divider { width: 60%; height: 1px; background: var(--border); margin: 5px 0; }

        .color-dot {
            width: 24px; height: 24px; border-radius: 50%; border: 2px solid transparent; cursor: pointer;
        }
        .color-dot.active { border-color: #fff; transform: scale(1.2); box-shadow: 0 0 5px var(--accent); }

        .zoom-display { font-size: 0.7rem; font-weight: bold; color: var(--accent); }

        /* --- LAYERS --- */
        .page-wrap { position: relative; background: #fff; overflow: hidden; }
        canvas { position: absolute; top:0; left:0; width:100%; height:100%; }
        .pdf-layer { z-index: 1; }
        .ink-layer { z-index: 10; cursor: crosshair; touch-action: none; }

        /* --- OVERLAYS --- */
        #pan-mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            z-index: 50; display: none; cursor: grab;
        }
        #pan-mask.grabbing { cursor: grabbing; }

        .spyglass {
            position: absolute; width: 200px; height: 200px; border-radius: 50%;
            border: 4px solid #fff; box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            overflow: hidden; pointer-events: none; z-index: 9999;
            display: none; background: #fff;
        }

        /* --- UPLOAD --- */
        #upload-layer {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .upload-btn {
            padding: 40px; border: 2px dashed #555; border-radius: 20px;
            color: #888; cursor: pointer; text-align: center; transition: 0.3s;
        }
        .upload-btn:hover { border-color: var(--accent); color: #fff; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 8px 16px; border-radius: 20px;
            opacity: 0; transition: 0.3s; pointer-events: none; z-index: 8000; font-size: 0.9rem;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(-10px); }
    </style>
</head>
<body data-theme="dark">

    <div id="upload-layer">
        <div class="upload-btn" onclick="document.getElementById('inp').click()">
            <i class="fas fa-book-open" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <h2>MỞ FILE PDF</h2>
            <p>Giao diện Studio - Không che lấp</p>
        </div>
        <input type="file" id="inp" hidden accept="application/pdf">
    </div>

    <div class="sidebar" id="panel-left">
        <div class="mode-group">
            <div class="mode-item active" id="m-read" onclick="App.setMode('READ')" title="Đọc"><i class="fas fa-eye"></i></div>
            <div class="mode-item" id="m-draw" onclick="App.setMode('DRAW')" title="Vẽ"><i class="fas fa-pen"></i></div>
        </div>
        
        <div class="divider"></div>

        <button class="btn" id="t-pen" onclick="Pen.set('pen')"><i class="fas fa-pen-nib"></i></button>
        <button class="btn" id="t-high" onclick="Pen.set('marker')"><i class="fas fa-highlighter"></i></button>
        <button class="btn" id="t-erase" onclick="Pen.set('eraser')"><i class="fas fa-eraser"></i></button>
        
        <div class="divider"></div>

        <div class="color-dot active" style="background:#ff4757" onclick="Pen.col('#ff4757',this)"></div>
        <div class="color-dot" style="background:#2ed573" onclick="Pen.col('#2ed573',this)"></div>
        <div class="color-dot" style="background:#2f3542" style="border:1px solid #777" onclick="Pen.col('#2f3542',this)"></div>
        
        <div class="divider"></div>
        
        <button class="btn" onclick="Pen.undo()" title="Undo"><i class="fas fa-undo"></i></button>
        <button class="btn" onclick="Pen.clear()" title="Clear Page"><i class="fas fa-trash"></i></button>
    </div>

    <div id="stage-area">
        <div id="book-transform">
            <div id="book"></div>
        </div>
        <div id="pan-mask"></div>
        <div class="spyglass" id="spy"><canvas id="spy-c"></canvas></div>
    </div>

    <div class="sidebar" id="panel-right">
        <button class="btn" onclick="App.theme()"><i class="fas fa-adjust"></i></button>
        <div class="divider"></div>
        
        <button class="btn" onclick="Zoom.do(1)"><i class="fas fa-plus"></i></button>
        <span class="zoom-display" id="z-val">100%</span>
        <button class="btn" onclick="Zoom.do(-1)"><i class="fas fa-minus"></i></button>
        
        <div class="divider"></div>

        <button class="btn" onclick="App.flip('prev')"><i class="fas fa-chevron-up"></i></button>
        <span id="pg-txt" style="font-size:0.8rem; font-weight:bold">--</span>
        <button class="btn" onclick="App.flip('next')"><i class="fas fa-chevron-down"></i></button>
        
        <div class="divider"></div>
        
        <button class="btn" id="btn-loupe" onclick="Loupe.toggle()"><i class="fas fa-search"></i></button>
        <button class="btn" onclick="App.full()"><i class="fas fa-expand"></i></button>
    </div>

    <div class="toast" id="toast">Ready</div>
    <audio id="sfx" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        const S = { pdf:null, flip:null, mode:'READ', zoom:1 };

        const App = {
            init() {
                document.getElementById('inp').onchange = this.load;
                window.onkeydown = e => {
                    if(e.key==='ArrowLeft') this.flip('prev');
                    if(e.key==='ArrowRight') this.flip('next');
                    if(e.ctrlKey && e.key==='z') Pen.undo();
                };
            },
            async load(e) {
                if(!e.target.files[0]) return;
                const ab = await e.target.files[0].arrayBuffer();
                S.pdf = await pdfjsLib.getDocument(ab).promise;
                App.render();
            },
            async render() {
                const b = document.getElementById('book'); b.innerHTML='';
                for(let i=1; i<=S.pdf.numPages; i++){
                    const p = await S.pdf.getPage(i);
                    const v = p.getViewport({scale:1.5});
                    const w = document.createElement('div'); w.className='page-wrap'; w.dataset.idx=i;
                    
                    const pc = document.createElement('canvas'); pc.className='pdf-layer'; pc.width=v.width; pc.height=v.height;
                    await p.render({canvasContext:pc.getContext('2d'), viewport:v}).promise;
                    
                    const ic = document.createElement('canvas'); ic.className='ink-layer'; ic.width=v.width; ic.height=v.height;
                    w.append(pc,ic); b.append(w);
                }
                document.getElementById('upload-layer').style.display='none';
                this.initFlip(); Pen.init(); Zoom.init();
            },
            initFlip() {
                const w = document.getElementById('stage-area').clientWidth;
                S.flip = new St.PageFlip(document.getElementById('book'), {
                    width: w<600?350:550, height: w<600?500:750,
                    size:'stretch', showCover:true, useMouseEvents:true 
                });
                S.flip.loadFromHTML(document.querySelectorAll('.page-wrap'));
                S.flip.on('flip', e=>{
                    document.getElementById('pg-txt').innerText = (e.data+1)+'/'+S.pdf.numPages;
                    document.getElementById('sfx').currentTime=0; document.getElementById('sfx').play().catch(()=>{});
                });
            },
            flip(d) { S.flip?.[d==='prev'?'flipPrev':'flipNext'](); },
            setMode(m) {
                S.mode=m;
                document.getElementById('m-read').classList.toggle('active', m==='READ');
                document.getElementById('m-draw').classList.toggle('active', m==='DRAW');
                document.getElementById('pan-mask').style.display = 'none';
                
                if(m==='READ') {
                    if(S.flip) S.flip.update({useMouseEvents:true});
                    UI.msg("Chế độ Đọc");
                } else {
                    if(S.flip) S.flip.update({useMouseEvents:false});
                    UI.msg("Chế độ Vẽ");
                }
            },
            theme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme')=='dark'?'light':'dark'); },
            full() { !document.fullscreenElement ? document.documentElement.requestFullscreen() : document.exitFullscreen(); }
        };

        const Pen = {
            tool:'pen', color:'#ff4757', ctx:null, can:null, isDown:false, last:{x:0,y:0}, history:{},
            init() {
                const s = document.getElementById('stage-area');
                s.onpointerdown = e => this.down(e);
                window.onpointermove = e => this.move(e);
                window.onpointerup = () => this.up();
            },
            set(t) {
                this.tool=t;
                ['pen','high','erase'].forEach(id => document.getElementById('t-'+id).classList.remove('active'));
                document.getElementById('t-'+(t==='marker'?'high':(t==='eraser'?'erase':'pen'))).classList.add('active');
            },
            col(c,el) {
                this.color=c; this.set('pen');
                document.querySelectorAll('.color-dot').forEach(d=>d.classList.remove('active'));
                el.classList.add('active');
            },
            getHit(e) {
                const el = document.elementFromPoint(e.clientX, e.clientY);
                return el?.classList.contains('ink-layer') ? el : null;
            },
            down(e) {
                if(document.getElementById('pan-mask').style.display === 'block') return;
                const hit = this.getHit(e);
                if(!hit || S.mode!=='DRAW') return;
                e.preventDefault(); 
                this.isDown=true; this.can=hit; this.ctx=hit.getContext('2d');
                this.setupCtx();
                const r = hit.getBoundingClientRect();
                this.last = { x:(e.clientX-r.left)*(hit.width/r.width), y:(e.clientY-r.top)*(hit.height/r.height) };
                
                this.ctx.beginPath(); this.ctx.moveTo(this.last.x, this.last.y); this.ctx.stroke();
            },
            move(e) {
                if(!this.isDown) return;
                const hit = this.getHit(e);
                if(hit && hit !== this.can) {
                    this.ctx.closePath(); this.can=hit; this.ctx=hit.getContext('2d');
                    this.setupCtx();
                    const r = hit.getBoundingClientRect();
                    this.last = { x:(e.clientX-r.left)*(hit.width/r.width), y:(e.clientY-r.top)*(hit.height/r.height) };
                    this.ctx.beginPath(); this.ctx.moveTo(this.last.x, this.last.y);
                }
                if(this.can) {
                    const r = this.can.getBoundingClientRect();
                    const curr = { x:(e.clientX-r.left)*(this.can.width/r.width), y:(e.clientY-r.top)*(this.can.height/r.height) };
                    this.ctx.quadraticCurveTo(this.last.x, this.last.y, (this.last.x+curr.x)/2, (this.last.y+curr.y)/2);
                    this.ctx.stroke();
                    this.last = curr;
                }
            },
            up() { this.isDown=false; if(this.ctx) { this.ctx.closePath(); this.save(this.can); } },
            setupCtx() {
                this.ctx.lineCap='round'; this.ctx.lineJoin='round';
                if(this.tool==='marker') {
                    this.ctx.globalCompositeOperation='multiply'; this.ctx.strokeStyle=this.color; this.ctx.lineWidth=20; this.ctx.globalAlpha=0.5;
                } else if(this.tool==='eraser') {
                    this.ctx.globalCompositeOperation='destination-out'; this.ctx.lineWidth=30; this.ctx.globalAlpha=1;
                } else {
                    this.ctx.globalCompositeOperation='source-over'; this.ctx.strokeStyle=this.color; this.ctx.lineWidth=3; this.ctx.globalAlpha=1;
                }
            },
            save(c) {
                const i = c.parentElement.dataset.idx;
                if(!this.history[i]) this.history[i]=[];
                this.history[i].push(this.ctx.getImageData(0,0,c.width,c.height));
                if(this.history[i].length>10) this.history[i].shift();
            },
            undo() {
                if(!this.can) return;
                const h = this.history[this.can.parentElement.dataset.idx];
                if(h?.length) { h.pop(); const p=h[h.length-1]; p ? this.ctx.putImageData(p,0,0) : this.clear(); }
            },
            clear() { if(this.can) { this.can.getContext('2d').clearRect(0,0,this.can.width,this.can.height); this.save(this.can); } }
        };

        const Zoom = {
            v:1, pan:{x:0,y:0}, isD:false, start:{x:0,y:0},
            init() {
                const m = document.getElementById('pan-mask');
                m.onmousedown=e=>{this.isD=true; this.start={x:e.clientX-this.pan.x, y:e.clientY-this.pan.y}; m.classList.add('grabbing');};
                window.onmousemove=e=>{
                    if(this.isD) { e.preventDefault(); this.pan.x=e.clientX-this.start.x; this.pan.y=e.clientY-this.start.y; this.upd(); }
                    if(Loupe.on) Loupe.draw(e);
                };
                window.onmouseup=()=>{this.isD=false; m.classList.remove('grabbing');};
            },
            do(d) {
                if(d>0 && this.v<4) this.v+=0.5; else if(d<0 && this.v>1) this.v-=0.5;
                this.upd();
            },
            upd() {
                document.getElementById('z-val').innerText=(this.v*100)+'%';
                const t=document.getElementById('book-transform'), m=document.getElementById('pan-mask');
                t.style.transform=`translate(${this.pan.x}px,${this.pan.y}px) scale(${this.v})`;
                if(this.v>1 && S.mode==='READ') { m.style.display='block'; if(S.flip) S.flip.update({useMouseEvents:false}); }
                else { m.style.display='none'; this.pan={x:0,y:0}; t.style.transform='scale(1)'; if(S.mode==='READ') S.flip.update({useMouseEvents:true}); }
            }
        };

        const Loupe = {
            on:false,
            toggle() { this.on=!this.on; document.getElementById('btn-loupe').classList.toggle('active',this.on); document.getElementById('spy').style.display=this.on?'block':'none'; },
            draw(e) {
                const s=document.getElementById('spy'), c=document.getElementById('spy-c').getContext('2d');
                document.getElementById('spy-c').width=500; document.getElementById('spy-c').height=500;
                s.style.left=(e.clientX+20)+'px'; s.style.top=(e.clientY+20)+'px';
                s.style.display='none'; const el=document.elementFromPoint(e.clientX,e.clientY); s.style.display='block';
                const w=el?.closest('.page-wrap');
                if(w) {
                    const pdf=w.querySelector('.pdf-layer'), ink=w.querySelector('.ink-layer');
                    const r=pdf.getBoundingClientRect();
                    const rx=pdf.width/r.width, ry=pdf.height/r.height;
                    const x=(e.clientX-r.left)*rx, y=(e.clientY-r.top)*ry;
                    c.fillStyle='#fff'; c.fillRect(0,0,500,500);
                    try { c.drawImage(pdf,x-100,y-100,200,200,0,0,500,500); c.drawImage(ink,x-100,y-100,200,200,0,0,500,500); } catch(e){}
                }
            }
        };

        const UI = { msg(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); } };

        App.init();
    </script>
</body>
</html>
