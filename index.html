<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>PDF Flipbook V8 (Artist Edition)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- 1. THEME VARIABLES --- */
        :root {
            --bg-color: #1a1a1a;
            --panel-bg: #2d2d2d;
            --text-color: #fff;
            --accent: #3498db;
            --border: #444;
        }

        [data-theme="light"] {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            --text-color: #333;
            --accent: #2980b9;
            --border: #ccc;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: 0.3s;
        }

        /* --- 2. TOOLBAR --- */
        .toolbar {
            height: 60px;
            background: var(--panel-bg);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; z-index: 1000;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .group { display: flex; gap: 8px; align-items: center; }

        .btn {
            width: 40px; height: 40px;
            border: 1px solid var(--border);
            background: rgba(128,128,128,0.1);
            color: var(--text-color);
            border-radius: 6px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.1rem; transition: 0.2s;
        }
        .btn:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .btn.active { background: var(--accent); color: white; box-shadow: 0 0 10px var(--accent); }

        /* Color Picker cho bút */
        .color-dot {
            width: 20px; height: 20px; border-radius: 50%;
            cursor: pointer; border: 2px solid transparent;
        }
        .color-dot.selected { border-color: var(--text-color); transform: scale(1.2); }

        /* --- 3. STAGE & BOOK --- */
        .stage {
            flex: 1; position: relative; overflow: hidden;
            display: flex; justify-content: center; align-items: center;
            background-image: radial-gradient(rgba(128,128,128,0.2) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .zoom-layer {
            transition: transform 0.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            transform-origin: center center;
            will-change: transform;
        }

        /* Container của mỗi trang (Chứa PDF + Lớp Vẽ) */
        .page-wrapper {
            position: relative; overflow: hidden;
            background: white; /* Giấy trắng */
        }

        canvas.pdf-layer {
            position: absolute; top: 0; left: 0; z-index: 1;
            width: 100%; height: 100%; object-fit: contain;
        }
        
        canvas.draw-layer {
            position: absolute; top: 0; left: 0; z-index: 2;
            width: 100%; height: 100%; cursor: crosshair;
            touch-action: none;
        }

        /* --- 4. PAN OVERLAY (Kéo thả khi Zoom) --- */
        #pan-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 500; display: none; cursor: grab;
        }
        #pan-overlay.grabbing { cursor: grabbing; }

        /* --- 5. KÍNH LÚP --- */
        #magnifier {
            position: absolute; width: 220px; height: 220px;
            border: 4px solid #fff; border-radius: 50%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: none; pointer-events: none; z-index: 9999;
            background: #fff; overflow: hidden;
        }

        /* --- 6. UPLOAD UI --- */
        #upload-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .upload-card {
            padding: 40px; border: 2px dashed var(--accent); color: #ccc;
            border-radius: 15px; cursor: pointer; text-align: center;
        }
        .upload-card:hover { color: #fff; background: rgba(255,255,255,0.05); }
        
    </style>
</head>
<body data-theme="dark">

    <div id="upload-modal">
        <div class="upload-card" onclick="document.getElementById('inp-file').click()">
            <i class="fas fa-palette" style="font-size: 3rem; margin-bottom: 20px; color: var(--accent);"></i>
            <h2>CHỌN FILE PDF</h2>
            <p>Phiên bản V8: Vẽ, Kính lúp, Giao diện chuẩn</p>
        </div>
        <input type="file" id="inp-file" accept="application/pdf" style="display: none;">
        <div id="loading-txt" style="margin-top:20px; color:var(--accent); display:none;">Đang xử lý...</div>
    </div>

    <div class="toolbar">
        <div class="group">
            <button class="btn" onclick="UI.toggleTheme()" title="Sáng/Tối"><i class="fas fa-adjust"></i></button>
            <button class="btn" id="btn-sound" onclick="UI.toggleSound()"><i class="fas fa-volume-up"></i></button>
        </div>

        <div class="group">
            <button class="btn" id="btn-prev"><i class="fas fa-chevron-left"></i></button>
            <span id="page-num" style="font-weight:bold; min-width:80px; text-align:center;">0/0</span>
            <button class="btn" id="btn-next"><i class="fas fa-chevron-right"></i></button>
        </div>

        <div class="group" style="border-left:1px solid var(--border); padding-left:10px;">
            <button class="btn" id="btn-pen" onclick="Pen.toggle()" title="Bật bút vẽ"><i class="fas fa-pen"></i></button>
            <div class="group" id="pen-controls" style="display:none;">
                <div class="color-dot selected" style="background:red;" onclick="Pen.setColor('red', this)"></div>
                <div class="color-dot" style="background:blue;" onclick="Pen.setColor('blue', this)"></div>
                <div class="color-dot" style="background:black;" onclick="Pen.setColor('black', this)"></div>
                <button class="btn" onclick="Pen.toggleEraser()" id="btn-eraser" title="Tẩy"><i class="fas fa-eraser"></i></button>
            </div>
        </div>

        <div class="group" style="border-left:1px solid var(--border); padding-left:10px;">
            <button class="btn" id="btn-loupe" onclick="Loupe.toggle()" title="Kính lúp"><i class="fas fa-search"></i></button>
            <button class="btn" onclick="Zoom.out()"><i class="fas fa-minus"></i></button>
            <span id="zoom-lvl" style="font-size:0.9rem; font-weight:bold;">100%</span>
            <button class="btn" onclick="Zoom.in()"><i class="fas fa-plus"></i></button>
        </div>
    </div>

    <div class="stage">
        <div class="zoom-layer" id="zoom-layer">
            <div id="book"></div>
        </div>
        
        <div id="pan-overlay"></div>
        
        <div id="magnifier"><canvas id="mag-canvas"></canvas></div>
    </div>

    <audio id="snd" src="https://www.soundjay.com/books/sounds/book-page-turn-03.mp3"></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';

        let pdfDoc = null;
        let pageFlip = null;
        
        // --- 1. QUẢN LÝ UI & FILE ---
        const UI = {
            isSound: true,
            isDark: true,
            
            init() {
                // Upload Event
                document.getElementById('inp-file').addEventListener('change', this.handleUpload);
                // Buttons
                document.getElementById('btn-prev').onclick = () => pageFlip && pageFlip.flipPrev();
                document.getElementById('btn-next').onclick = () => pageFlip && pageFlip.flipNext();
            },

            async handleUpload(e) {
                const file = e.target.files[0];
                if(!file) return;
                
                document.querySelector('.upload-card').style.display='none';
                document.getElementById('loading-txt').style.display='block';
                
                // Mồi âm thanh
                document.getElementById('snd').play().catch(()=>{}); 
                document.getElementById('snd').pause();

                const reader = new FileReader();
                reader.readAsArrayBuffer(file);
                reader.onload = async (ev) => {
                    const data = new Uint8Array(ev.target.result);
                    pdfDoc = await pdfjsLib.getDocument(data).promise;
                    document.getElementById('page-num').innerText = `1 / ${pdfDoc.numPages}`;
                    await UI.renderPages();
                };
            },

            async renderPages() {
                const book = document.getElementById('book');
                book.innerHTML = '';
                const total = pdfDoc.numPages;

                for(let i=1; i<=total; i++) {
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    
                    // Tạo Wrapper chứa (PDF Canvas + Draw Canvas)
                    const wrapper = document.createElement('div');
                    wrapper.className = 'page-wrapper'; 
                    // Set cứng kích thước wrapper theo viewport để tránh lỗi layout
                    // (Sẽ được PageFlip override nhưng cần set ban đầu)
                    
                    // 1. PDF Canvas
                    const pdfCan = document.createElement('canvas');
                    pdfCan.className = 'pdf-layer';
                    pdfCan.width = viewport.width; pdfCan.height = viewport.height;
                    const ctx = pdfCan.getContext('2d', {alpha: false});
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    
                    // 2. Drawing Canvas (Nằm đè lên PDF)
                    const drawCan = document.createElement('canvas');
                    drawCan.className = 'draw-layer';
                    drawCan.width = viewport.width; drawCan.height = viewport.height;
                    
                    // Ghép vào wrapper
                    wrapper.appendChild(pdfCan);
                    wrapper.appendChild(drawCan);
                    book.appendChild(wrapper);

                    document.getElementById('loading-txt').innerText = `Đang xử lý ${i}/${total}`;
                }

                document.getElementById('upload-modal').style.display='none';
                UI.initBook();
                Pen.init(); // Khởi tạo bút
            },

            initBook() {
                const isMobile = window.innerWidth < 768;
                pageFlip = new St.PageFlip(document.getElementById('book'), {
                    width: isMobile ? 350 : 550, height: isMobile ? 500 : 750,
                    size: "stretch", showCover: true, usePortrait: isMobile,
                    minWidth: 300, maxWidth: 1000, minHeight: 400, maxHeight: 1200,
                    // QUAN TRỌNG: Để true để dùng chuột lật trang khi ko vẽ/zoom
                    useMouseEvents: true 
                });

                pageFlip.loadFromHTML(document.querySelectorAll('.page-wrapper'));

                pageFlip.on('flip', (e) => {
                    document.getElementById('page-num').innerText = `${e.data+1}/${pdfDoc.numPages}`;
                    if(UI.isSound) {
                        const aud = document.getElementById('snd'); aud.currentTime=0; aud.play().catch(()=>{});
                    }
                });
            },

            toggleTheme() {
                this.isDark = !this.isDark;
                document.body.setAttribute('data-theme', this.isDark ? 'dark' : 'light');
            },

            toggleSound() {
                this.isSound = !this.isSound;
                const btn = document.getElementById('btn-sound');
                btn.style.opacity = this.isSound ? 1 : 0.5;
            }
        };

        // --- 2. BÚT VẼ (PEN SYSTEM) ---
        const Pen = {
            enabled: false,
            color: 'red',
            isEraser: false,
            lineWidth: 2,
            isDrawing: false,
            lastX: 0, lastY: 0,

            init() {
                // Gán sự kiện vẽ cho TOÀN BỘ drawing canvas
                const layers = document.querySelectorAll('.draw-layer');
                layers.forEach(canvas => {
                    canvas.addEventListener('mousedown', e => this.start(e, canvas));
                    canvas.addEventListener('mousemove', e => this.move(e, canvas));
                    canvas.addEventListener('mouseup', () => this.stop());
                    canvas.addEventListener('mouseleave', () => this.stop());
                });
            },

            toggle() {
                this.enabled = !this.enabled;
                const btn = document.getElementById('btn-pen');
                const ctrls = document.getElementById('pen-controls');
                
                if(this.enabled) {
                    btn.classList.add('active');
                    ctrls.style.display = 'flex';
                    // Tắt chuột lật trang để ưu tiên vẽ
                    if(pageFlip) pageFlip.update({ useMouseEvents: false });
                    Zoom.disablePan(); // Tắt kéo trang
                } else {
                    btn.classList.remove('active');
                    ctrls.style.display = 'none';
                    // Bật lại lật trang
                    if(pageFlip) pageFlip.update({ useMouseEvents: true });
                }
            },

            setColor(c, el) {
                this.color = c; this.isEraser = false;
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                el.classList.add('selected');
                document.getElementById('btn-eraser').classList.remove('active');
            },

            toggleEraser() {
                this.isEraser = !this.isEraser;
                const btn = document.getElementById('btn-eraser');
                if(this.isEraser) btn.classList.add('active'); else btn.classList.remove('active');
            },

            // Logic Vẽ
            getPos(e, canvas) {
                const rect = canvas.getBoundingClientRect();
                // Phải tính tỉ lệ scale vì canvas size thực tế khác size hiển thị
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY
                };
            },

            start(e, canvas) {
                if(!this.enabled) return;
                this.isDrawing = true;
                const pos = this.getPos(e, canvas);
                this.lastX = pos.x; this.lastY = pos.y;
            },

            move(e, canvas) {
                if(!this.isDrawing || !this.enabled) return;
                const ctx = canvas.getContext('2d');
                const pos = this.getPos(e, canvas);

                ctx.beginPath();
                ctx.moveTo(this.lastX, this.lastY);
                ctx.lineTo(pos.x, pos.y);
                
                if(this.isEraser) {
                    ctx.globalCompositeOperation = 'destination-out';
                    ctx.lineWidth = 20;
                } else {
                    ctx.globalCompositeOperation = 'source-over';
                    ctx.strokeStyle = this.color;
                    ctx.lineWidth = 3;
                }
                
                ctx.lineCap = 'round';
                ctx.stroke();

                this.lastX = pos.x; this.lastY = pos.y;
            },

            stop() { this.isDrawing = false; }
        };

        // --- 3. ZOOM & KÍNH LÚP ---
        const Zoom = {
            scale: 1,
            panX: 0, panY: 0,
            isDragging: false, startX:0, startY:0,

            in() { if(this.scale < 3) { this.scale += 0.5; this.apply(); } },
            out() { if(this.scale > 1) { this.scale -= 0.5; this.apply(); } },
            
            apply() {
                document.getElementById('zoom-lvl').innerText = (this.scale*100)+'%';
                document.getElementById('zoom-layer').style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${this.scale})`;
                
                const overlay = document.getElementById('pan-overlay');
                if(this.scale > 1) {
                    overlay.style.display = 'block';
                    // Tắt chuột lật trang khi zoom
                    if(pageFlip) pageFlip.update({ useMouseEvents: false });
                } else {
                    overlay.style.display = 'none';
                    this.panX=0; this.panY=0;
                    document.getElementById('zoom-layer').style.transform = `translate(0,0) scale(1)`;
                    // Bật lại lật trang nếu ko vẽ
                    if(pageFlip && !Pen.enabled) pageFlip.update({ useMouseEvents: true });
                }
            },
            
            disablePan() { document.getElementById('pan-overlay').style.display='none'; }
        };

        // Pan Logic
        const panOv = document.getElementById('pan-overlay');
        panOv.addEventListener('mousedown', e => {
            Zoom.isDragging = true;
            Zoom.startX = e.clientX - Zoom.panX;
            Zoom.startY = e.clientY - Zoom.panY;
            panOv.style.cursor='grabbing';
        });
        window.addEventListener('mousemove', e => {
            if(Zoom.isDragging) {
                e.preventDefault();
                Zoom.panX = e.clientX - Zoom.startX;
                Zoom.panY = e.clientY - Zoom.startY;
                Zoom.apply();
            }
            if(Loupe.active) Loupe.update(e);
        });
        window.addEventListener('mouseup', () => { Zoom.isDragging = false; panOv.style.cursor='grab'; });


        // --- 4. KÍNH LÚP (FIXED) ---
        const Loupe = {
            active: false,
            
            toggle() {
                this.active = !this.active;
                const btn = document.getElementById('btn-loupe');
                const mag = document.getElementById('magnifier');
                if(this.active) {
                    btn.classList.add('active');
                    mag.style.display = 'block';
                } else {
                    btn.classList.remove('active');
                    mag.style.display = 'none';
                }
            },

            update(e) {
                const mag = document.getElementById('magnifier');
                mag.style.left = (e.clientX + 20) + 'px';
                mag.style.top = (e.clientY + 20) + 'px';

                // Tìm canvas bên dưới chuột
                mag.style.display = 'none';
                const el = document.elementFromPoint(e.clientX, e.clientY);
                mag.style.display = 'block';

                if(el && (el.classList.contains('pdf-layer') || el.classList.contains('draw-layer'))) {
                    // Nếu trỏ vào draw-layer, ta cần lấy cả pdf-layer bên dưới nó để soi cho đủ
                    const wrapper = el.parentElement;
                    if(!wrapper.classList.contains('page-wrapper')) return;

                    const pdfCan = wrapper.querySelector('.pdf-layer');
                    const drawCan = wrapper.querySelector('.draw-layer');
                    const rect = pdfCan.getBoundingClientRect();
                    
                    const magCtx = document.getElementById('mag-canvas').getContext('2d');
                    document.getElementById('mag-canvas').width = 500;
                    document.getElementById('mag-canvas').height = 500;

                    // Tính toạ độ tương đối
                    const x = (e.clientX - rect.left) * (pdfCan.width / rect.width);
                    const y = (e.clientY - rect.top) * (pdfCan.height / rect.height);

                    // Vẽ nền trắng
                    magCtx.fillStyle = '#fff'; magCtx.fillRect(0,0,500,500);

                    // Vẽ lớp PDF
                    try {
                        magCtx.drawImage(pdfCan, x-100, y-100, 200, 200, 0, 0, 500, 500);
                        // Vẽ lớp Mực (Đè lên)
                        magCtx.drawImage(drawCan, x-100, y-100, 200, 200, 0, 0, 500, 500);
                    } catch(err){}
                }
            }
        };

        UI.init();

    </script>
</body>
</html>
